import{j as c,r as o}from"./atlas_BSujyM3STIIs7ogMAeFeS.js";import{W as St}from"./atlas_DDJH3F64TRS7xAljnqyWd.js";import{O as It}from"./atlas_C0798p1R6_QDmDHuetMGI.js";import{Q as Dt}from"./atlas_BrYhsyGbdfinGesBjh40k.js";import{e as K}from"./atlas_BKvmFXuXk1OxDb5S8--uJ.js";import{E as ne,c as At}from"./atlas_DDCiW7QzIfNLPEz5WRchT.js";import{g as Tt}from"./atlas_DFAhS78XbvMY8Hq-lokcg.js";import{P as Ft}from"./atlas_CZCpRd54Ss24_zPvDswww.js";import{M as at}from"./atlas_BWH7uwKFEWd5_sJOlPkiD.js";import{c as jt}from"./atlas_CX43Rv79CUc9F90Wm9Uey.js";import{a3 as Lt,a4 as kt,f as zt,a5 as Ot,C as it,a6 as $t,a7 as Ut,a8 as Nt,a9 as Bt,aa as ot,b as ct,z as lt,M as ut,V as Z,ab as ft,ac as Gt,m as Wt,B as Ht,a2 as Vt,o as Yt,a as qt}from"./atlas_B2lpKXcKkLCAPkjGiW29w.js";class Qt{static isRemoteUniverse(){try{const n=document.getElementById("data-universe-config");return n?JSON.parse(n.textContent||"{}").remote===!0:!1}catch(n){return console.error("Error checking universe type:",n),!1}}static getUniverseConfig(){try{const n=document.getElementById("data-universe-config");return n?JSON.parse(n.textContent||"{}"):null}catch(n){return console.error("Error parsing universe config:",n),null}}}class Se{static encodeUrl(n){return btoa(n).replace(/\+/g,"-").replace(/\//g,"_")}static generateGalaxyUrl(n,m=1){const h=`coordinates=${n[0]},${n[1]},${n[2]}&page=${m}`;return`/stargate/${this.encodeUrl(h)}`}static generateSystemUrl(n,m,h){const _=`coordinates=${n[0]},${n[1]},${n[2]}&system=${m}`;return`/stargate/${this.encodeUrl(_)}`}static generatePlanetUrl(n,m,h,_){const x=`coordinates=${n[0]},${n[1]},${n[2]}&system=${m}&planet=${h.toLowerCase()}`;return`/stargate/${this.encodeUrl(x)}`}static getCurrentPage(){try{const m=new URLSearchParams(window.location.search).get("page");if(m)return parseInt(m,10);const h=window.location.pathname.match(/\/galaxy\/(\d+)/);return h?parseInt(h[1],10):1}catch{return 1}}}const Xt=(a,n)=>{try{const m=a.split("/stargate/")[1];if(!m)return null;const h=atob(m.replace(/-/g,"+").replace(/_/g,"/")),_=new URLSearchParams(h),x=_.get("coordinates"),y=_.get("system"),M=_.get("planet");if(!x)return null;const I={type:n,coordinates:x};return y&&(I.systemIndex=parseInt(y)),M&&(I.planetName=M),I}catch{return null}},dt=a=>{try{const n=a.coordinates.split(",").map(Number),m=Se.getCurrentPage();let h;switch(a.type){case"galaxy":h=Se.generateGalaxyUrl(n,m);break;case"system":if(a.systemIndex!==void 0)h=Se.generateSystemUrl(n,a.systemIndex,m);else return window.location.href;break;case"planet":if(a.systemIndex!==void 0&&a.planetName)h=Se.generatePlanetUrl(n,a.systemIndex,a.planetName,m);else return window.location.href;break;default:return window.location.href}return`${window.location.origin}${h}`}catch{return window.location.href}},Jt=async a=>{const{url:n,size:m}=a;return new Promise((h,_)=>{const x=document.createElement("canvas"),y=m,M=Math.floor(m*.8);Dt.toCanvas(x,n,{width:M,margin:0,color:{dark:"#000000",light:"#FFFFFF"},errorCorrectionLevel:"H"},I=>{if(I){_(I);return}const f=document.createElement("canvas"),l=f.getContext("2d"),G=Math.floor(y*.17);if(f.width=y,f.height=y+G,l){const F=Math.floor(y*.1);l.fillStyle="#FFFFFF",l.beginPath(),l.roundRect(0,0,f.width,f.height,F),l.fill();const Y=(y-M)/2;l.drawImage(x,Y,Y),l.fillStyle="#000000",l.font=`bold ${Math.floor(y*.13)}px Arial`,l.textAlign="center",l.textBaseline="middle",l.fillText("VIEW IT LIVE",y/2,y+G*.2),h(f)}})})},Kt=async(a,n,m,h)=>{try{if(Qt.isRemoteUniverse())return;let _;if("coordinates"in h)_=dt(h);else{const l=Xt(h.stargateUrl,h.type);l?_=dt(l):_=h.stargateUrl}if(_.startsWith("http://localhost/"))try{const G=await(await fetch("/api/universe/config")).json(),F=45156749731585371360938718175484539659389209313560548011495000289036640085049n,Y=4515674973158537e61,ce=G.config_seed;(ce===Y||ce===F||BigInt(ce)===F)&&(_=_.replace("http://localhost/","https://the-atlas.koyeb.app/"))}catch(l){console.warn("Failed to check config seed:",l)}const x=Math.floor(n/8),y=await Jt({url:_,size:x}),M=Math.floor(n/100),I=n-y.width-M,f=m-y.height-M;a.drawImage(y,I,f)}catch(_){console.warn("Failed to generate QR code:",_)}},Zt=(a,n)=>{const{imageWidth:m,imageHeight:h,startYear:_=2023,companyName:x="Banshee",opacity:y=.5,fontSize:M}=n,I=new Date().getFullYear(),f=I===_?`${_}`:`${_}-${I}`,l=`The Atlas © Copyright ${x} • ${f}`;a.fillStyle=`rgba(255, 255, 255, ${y})`;const G=M||Math.floor(m/80);a.font=`${G}px Arial`,a.textAlign="left",a.textBaseline="bottom";const F=Math.floor(m/100);a.fillText(l,F,h-F)},er=({isVisible:a,message:n="Exporting view, please wait..."})=>c.jsxs("div",{className:`absolute inset-0 bg-black flex flex-col items-center justify-center z-10 transition-all duration-300 ${a?"opacity-100 visible":"opacity-0 invisible"}`,children:[c.jsx("div",{className:"w-16 h-16 border-4 border-white/20 border-t-white rounded-full animate-spin mb-6"}),c.jsx("p",{className:"text-white text-xl font-medium text-center px-4",children:n})]}),tr=({planetData:a,showInConsole:n=!0,showInPage:m=!1})=>{const[h,_]=o.useState([]),[x,y]=o.useState({});o.useEffect(()=>{if(!a)return;const f=M(a);y(f),_(I(a)),typeof window<"u"&&(window.__DEBUG_PLANET_DATA=a,window.__DEBUG_PLANET_ANALYSIS=f)},[a,n]);function M(f){const l={hasValidStructure:!1,missingFields:[],dataIntegrity:"unknown",renderingIssues:[],colorConsistency:"unknown"};if(f.planet_info&&f.surface_elements?l.hasValidStructure=!0:(f.planet_info||l.missingFields.push("planet_info"),f.surface_elements||l.missingFields.push("surface_elements")),f.surface_elements?.type==="oceanic"&&(l.oceanicData={hasAbstractLands:!!f.surface_elements.abstract_lands?.length,numGreenPatches:f.surface_elements.green_patches?.length||0,numClouds:f.surface_elements.clouds?.length||0,hasDepths:f.surface_elements.depths?.enabled||!1,baseColorIsBlue:f.planet_info?.base_color==="#0000FF",greenPatchColor:f.surface_elements.green_patches?.[0]?.color,issues:[]},l.oceanicData.numGreenPatches>15&&l.oceanicData.issues.push("Muchos parches verdes pueden ocultar el océano azul"),l.oceanicData.baseColorIsBlue||l.oceanicData.issues.push(`Color base no es azul puro: ${f.planet_info?.base_color}`),l.renderingIssues=l.oceanicData.issues),f.planet_info?.base_color&&f.planet_info?.type){const F={Oceanic:"#0000FF",Rocky:"#808080",Icy:"#ADD8E6",Desert:"#FFD700",Lava:"#FF0000"}[f.planet_info.type];F&&f.planet_info.base_color!==F?l.colorConsistency=`Inconsistente: esperado ${F}, recibido ${f.planet_info.base_color}`:l.colorConsistency="Correcto"}return l}function I(f){const l=[];if(!f.surface_elements?.type)return["No surface type defined"];const G=f.surface_elements.type.toLowerCase();switch(G){case"oceanic":l.push("OceanWavesEffect (PROBLEMA: ignora green_patches de Python)");break;case"rocky":l.push("RockyTerrainEffect");break;case"icy":l.push("IcyTerrainEffect");break;case"gas giant":l.push("GasGiantBandsEffect");break;default:l.push(`Generic effect for type: ${G}`)}return f.atmosphere?.density>0&&l.push("AtmosphericEffect"),f.rings&&l.push("RingSystemEffect"),l}return m?c.jsxs("div",{style:{position:"fixed",top:10,right:10,background:"rgba(0, 0, 0, 0.9)",color:"#00ff00",padding:"10px",borderRadius:"5px",fontFamily:"monospace",fontSize:"12px",maxWidth:"400px",maxHeight:"600px",overflow:"auto",zIndex:1e4,border:"1px solid #00ff00"},children:[c.jsxs("h3",{style:{margin:"0 0 10px 0",color:"#00ff00"},children:["🔍 Planet Debug: ",a.planet_info?.name]}),c.jsxs("div",{style:{marginBottom:"10px"},children:[c.jsx("strong",{children:"Type:"})," ",a.planet_info?.type,c.jsx("br",{}),c.jsx("strong",{children:"Base Color:"})," ",a.planet_info?.base_color,c.jsx("br",{}),c.jsx("strong",{children:"Radius:"})," ",a.planet_info?.radius]}),a.surface_elements?.type==="oceanic"&&c.jsxs("div",{style:{marginBottom:"10px",borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[c.jsx("strong",{children:"🌊 Oceanic Data:"}),c.jsx("br",{}),c.jsxs("span",{style:{color:x.oceanicData?.baseColorIsBlue?"#00ff00":"#ff0000"},children:["Base Color: ",x.oceanicData?.baseColorIsBlue?"✓ Blue":"✗ Not Blue"]}),c.jsx("br",{}),"Green Patches: ",x.oceanicData?.numGreenPatches,c.jsx("br",{}),"Clouds: ",x.oceanicData?.numClouds,c.jsx("br",{}),"Has Depths: ",x.oceanicData?.hasDepths?"Yes":"No",c.jsx("br",{}),x.oceanicData?.issues?.length>0&&c.jsxs("div",{style:{color:"#ffaa00",marginTop:"5px"},children:["⚠️ Issues:",c.jsx("br",{}),x.oceanicData.issues.map((f,l)=>c.jsxs("div",{children:["- ",f]},l))]})]}),c.jsxs("div",{style:{borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[c.jsx("strong",{children:"🎨 Effects Applied:"}),c.jsx("br",{}),h.map((f,l)=>c.jsxs("div",{style:{color:f.includes("PROBLEMA")?"#ff0000":"#00ff00"},children:["- ",f]},l))]}),c.jsx("button",{style:{marginTop:"10px",background:"#00ff00",color:"#000",border:"none",padding:"5px 10px",cursor:"pointer",borderRadius:"3px"},children:"Log to Console"})]}):null};function rr(a){o.useEffect(()=>{if(a&&a.surface_elements?.type==="oceanic"){a.surface_elements.green_patches?.length>0;const n=a.planet_info?.base_color;n!=="#0000FF"&&console.warn("⚠️ Planeta oceánico sin color azul base!",n)}},[a])}const ee=2.5,He=()=>{const a=45*Math.PI/180;return ee/(Math.tan(a/2)*.5)},mt=a=>{let n=0;for(let m=0;m<a.length;m++)n=(n<<5)-n+a.charCodeAt(m),n=n&n;return Math.abs(n)%1e4/1e4*.15},pt=a=>{let n=0;for(let m=0;m<a.length;m++)n=(n<<3)-n+a.charCodeAt(m)*7,n=n&n;return Math.abs(n)%1e4/1e4*Math.PI*2},gt=(a,n,m,h,_)=>{const x=n*(1-m*m)/(1+m*Math.cos(a)),y=x*Math.cos(a),M=x*Math.sin(a),I=y*Math.cos(_)-M*Math.sin(_)*Math.cos(h),f=y*Math.sin(_)+M*Math.cos(_)*Math.cos(h),l=M*Math.sin(h);return new Z(I,l,f)},ht={"Red Dwarf":1,"Yellow Dwarf":2,"Blue Giant":8,"Red Giant":3,"White Dwarf":2.5,"Neutron Star":1.5},nr=o.forwardRef(({planetName:a,containerClassName:n="",width:m=800,height:h=600,autoRotate:_=!0,enableControls:x=!0,showDebugInfo:y=!1,planetData:M,cosmicOriginTime:I,initialAngleRotation:f,onDataLoaded:l,onEffectsCreated:G,onError:F,onMoonSelected:Y,planetUrl:ce},Ve)=>{const v=o.useRef(null),g=o.useRef(null),$=o.useRef(null),E=o.useRef(null),D=o.useRef(null),U=o.useRef(null),_t=o.useRef(new Lt),Ie=o.useRef(null),ye=o.useRef(0),q=o.useRef(null),[Ye,we]=o.useState(!0),[qe,le]=o.useState(null),[R,Qe]=o.useState(null),[bt,De]=o.useState([]),[xe,yt]=o.useState(!1),[Pe,Ae]=o.useState({activeEffects:0,enabledEffects:0,frameRate:0,renderTime:0}),ge=o.useRef([]),ve=o.useRef(0),Ee=o.useRef(null),N=o.useRef(null),j=o.useRef(null),B=o.useRef(null),Te=o.useRef(new kt),Fe=o.useRef(new zt),se=o.useRef(null),Re=o.useRef(!1),[je,Xe]=o.useState(!1),[ar,Le]=o.useState(null),he=o.useRef(null);o.useImperativeHandle(Ve,()=>({captureScreenshot:()=>{if(!$.current||!g.current||!E.current||je)return;Xe(!0),U.current&&(U.current.enabled=!1);const e=$.current,s=g.current,t=E.current,i=e.domElement.width,p=e.domElement.height,u=3840/i,r=[];s.traverse(P=>{if(P.isPoints&&P.material){const d=P.material;if(d.size!==void 0){r.push({material:d,originalSize:d.size});const w=d.isPulsatingCubeParticle===!0?u*.3:u*1;d.size=d.size*w}if(d.uniforms){const w=d.isPulsatingCubeParticle===!0?u*.3:u*1;d.uniforms.size&&(r.push({material:d,uniform:"size",originalValue:d.uniforms.size.value}),d.uniforms.size.value=d.uniforms.size.value*w),d.uniforms.scale&&(r.push({material:d,uniform:"scale",originalValue:d.uniforms.scale.value}),d.uniforms.scale.value=d.uniforms.scale.value*w)}if(P.geometry&&P.geometry.attributes.size){const S=P.geometry.attributes.size,w=S.array.slice();r.push({geometry:P.geometry,originalSizeArray:w});const W=d.isPulsatingCubeParticle===!0?u*.3:u*1;for(let T=0;T<S.array.length;T++)S.array[T]*=W;S.needsUpdate=!0}}if(P.isSprite&&(r.push({object:P,originalScale:P.scale.clone()}),P.scale.multiplyScalar(u*1)),P.isLine&&P.material){const d=P.material;d.linewidth!==void 0&&(r.push({material:d,originalLinewidth:d.linewidth}),d.linewidth=d.linewidth*u*1)}});const b=3840,C=3840;e.setSize(b,C),t.aspect=1,t.updateProjectionMatrix(),e.render(s,t),e.domElement.toBlob(P=>{if(P){const d=document.createElement("canvas"),S=d.getContext("2d");if(d.width=b,d.height=C,S){const w=new Image;w.onload=async()=>{S.drawImage(w,0,0),Zt(S,{imageWidth:b,imageHeight:C}),ce&&await Kt(S,b,C,{type:"planet",stargateUrl:ce}),d.toBlob(W=>{if(W){const T=URL.createObjectURL(W),Q=document.createElement("a");Q.href=T,Q.download=`planet_${a}_${Date.now()}.jpg`,Q.click(),URL.revokeObjectURL(T)}},"image/jpeg",1)};const A=URL.createObjectURL(P);w.src=A}}r.forEach(({material:d,object:S,originalSize:w,originalScale:A,originalLinewidth:W,uniform:T,originalValue:Q,geometry:ue,originalSizeArray:O})=>{if(w!==void 0&&(d.size=w),A!==void 0&&S.scale.copy(A),W!==void 0&&(d.linewidth=W),T&&Q!==void 0&&(d.uniforms[T].value=Q),ue&&O){const V=ue.attributes.size;for(let te=0;te<O.length;te++)V.array[te]=O[te];V.needsUpdate=!0}}),e.setSize(i,p),t.aspect=i/p,t.updateProjectionMatrix(),U.current&&(U.current.enabled=!0),Xe(!1)},"image/jpeg",1)},isGeneratingImage:je}));const ke=o.useCallback(()=>{if(!v.current||!$.current||!E.current)return;const e=v.current,s=e.clientWidth||400,t=e.clientHeight||400;$.current.setSize(s,t),B.current&&B.current.setSize(s,t),E.current.aspect=s/t,E.current.updateProjectionMatrix()},[]),Je=async e=>{if(!(!D.current||!g.current||!N.current)){ne.log("Applying modular effects from API data",{planet:e.planet_info.name,type:e.planet_info.type});try{$e();const s=Tt(e);N.current.updateBaseColor(s);const t=K.createEffectsFromPythonPlanetData(e,ee,D.current,g.current,N.current),i=e.planet_info?.type||e.surface_elements?.planet_type||e.planet_type;if((i==="toxic"||i==="Toxic")&&g.current&&E.current&&$.current)try{const p=jt(g.current,E.current,$.current,ee,{planet_type:"toxic",toxic_intensity:.8,atmosphere_thickness:.6},e.seeds?.planet_seed);if(p){B.current=p;const u={id:`effect_toxic_postprocessing_${Date.now()}`,type:"toxic_post_processing",effect:{dispose:()=>p.dispose(),update:r=>p.update(r),updateUniforms:r=>p.update(r),addToScene:()=>{},apply:()=>{}},priority:100,enabled:!0,name:"Toxic Post-Processing (Bloom + Godrays + Chromatic Aberration)"};K.effects.set(u.id,u),t.push(u),ne.log("Created toxic post-processing effects")}}catch(p){ne.error("Error creating toxic post-processing",p)}else B.current&&(B.current.dispose(),B.current=null);De(t),ge.current=t,G&&G(t),ne.log(`Successfully applied ${t.length} modular effects`),Ue()}catch{Me()}}},wt=o.useCallback(()=>{if(!v.current)return!1;try{for(;v.current.firstChild;)v.current.removeChild(v.current.firstChild);g.current=null,E.current=null,$.current=null,D.current=null,k.current=null;const e=v.current,s=e.clientWidth||m||400,t=e.clientHeight||h||400,i=new Ot;i.background=new it(1297),g.current=i;const p=new $t(45,s/t,.1,1e4),u=He();p.position.set(0,0,u),p.lookAt(0,0,0),E.current=p;const r=new St({antialias:!0,alpha:!0,powerPreference:"high-performance"});return r.setSize(s,t),r.setPixelRatio(Math.min(window.devicePixelRatio,2)),r.shadowMap.enabled=!0,r.shadowMap.type=Ut,r.toneMapping=Nt,r.toneMappingExposure=1.2,r.outputColorSpace=Bt,r.domElement.className="",v.current.appendChild(r.domElement),$.current=r,Pt(i,null),vt(i),x&&Et(p,r.domElement),!0}catch{return!1}},[R,M,I]),L=o.useRef([]),Ke=o.useRef([]),ze=o.useRef(null),_e=o.useRef(null),k=o.useRef(null),z=o.useRef(null),xt=e=>{e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.camera.left=-10,e.shadow.camera.right=10,e.shadow.camera.top=10,e.shadow.camera.bottom=-10},Oe=e=>{if(L.current.length===0||!g.current)return;const s=e?.original_planet_data||e,t=s?.initial_orbital_angle||0,i=s?.orbital_period_seconds||365.25*24*3600,p=2*Math.PI/i,u=(t+ye.current*p)%(2*Math.PI),r=e?.planet_info?.name||e?.name||e?.original_planet_data?.name||"unknown_planet",b=s?.eccentricity_factor||.1,C=mt(r),P=pt(r),d=e?.planet_info?.orbital_radius||s?.orbital_radius||1,S=e?.timing?.max_orbital_radius||s?.system_max_orbital_radius||1,W=20+d/S*80,T=gt(u,W,b,C,P),Q=Math.sqrt(T.x**2+T.y**2+T.z**2),ue=200;L.current.forEach((O,V)=>{const te=Ke.current[V],fe=new Z(-T.x,-T.y,-T.z);if(V>0){const de=V*30;fe.x+=de*Math.cos(V),fe.z+=de*Math.sin(V)}fe.normalize();const Ne=fe.multiplyScalar(ue);if(te){const de=te.Type||"Yellow Dwarf",be=(ht[de]||2)*300/(Q*Q),me=Math.min(3,Math.max(.05,be));O.intensity=me}O.position.copy(Ne),O.target.position.set(0,0,0),g.current.children.includes(O.target)||g.current.add(O.target)}),ze.current&&ze.current.position.set(T.x*.5,0,T.z*.5),N.current&&L.current[0]&&N.current.updateFromThreeLight(L.current[0]),L.current[0]&&K.updateLightForAllEffects(L.current[0])},Pt=(e,s)=>{{const t=new ot(16777215,2);t.position.set(-10,5,10),t.target.position.set(0,0,0),t.castShadow=!0,xt(t),e.add(t),e.add(t.target),L.current=[t];const i=new ot(16777215,.01);i.position.set(8,-3,-5),e.add(i),ze.current=i,setTimeout(()=>{N.current&&t&&N.current.updateFromThreeLight(t),t&&K.updateLightForAllEffects(t)},50);return}},vt=e=>{const s=new ct(ee,128,64),t=new lt({color:8421504}),i=new ut(s,t);i.castShadow=!0,i.receiveShadow=!0,i.position.set(0,0,0),e.add(i),D.current=i;const p=new it(8421504);N.current=new Ft(i,p),N.current.addToScene(e),E.current&&(j.current=new at(e,ee,E.current,new Z(0,0,0),51408e4));const u=new ft(20);u.visible=!1,e.add(u)},Ze=o.useCallback(e=>{v.current?.getBoundingClientRect()&&(se.current={x:e.clientX,y:e.clientY,time:Date.now()},Re.current=!1)},[]),et=o.useCallback(e=>{if(!se.current)return;const s=e.clientX-se.current.x,t=e.clientY-se.current.y;Math.sqrt(s*s+t*t)>5&&(Re.current=!0)},[]),tt=o.useCallback(e=>{if(!E.current||!g.current||!j.current||!U.current||!se.current)return;const s=Date.now()-se.current.time,t=Re.current;if(se.current=null,Re.current=!1,t||s>500)return;const i=v.current?.getBoundingClientRect();if(!i)return;Fe.current.x=(e.clientX-i.left)/i.width*2-1,Fe.current.y=-((e.clientY-i.top)/i.height)*2+1,Te.current.setFromCamera(Fe.current,E.current);const p=j.current.getMoonAtPosition(Te.current);if(p){Le(p),Y&&Y(p);const u=j.current.getMoonPosition(p.name);if(u){const r=ee*8,b=new Z(u.x,u.y+r*.3,u.z+r);rt(b,u)}}else if(Te.current.intersectObject(D.current||new Gt,!0).length>0){Le(null),Y&&Y(null);const r=new Z(0,0,0),b=He(),C=new Z(0,0,b);rt(C,r)}else Le(null),Y&&Y(null)},[]),rt=o.useCallback((e,s)=>{if(!E.current||!U.current)return;const t=E.current,i=U.current;he.current={isAnimating:!0,startPosition:t.position.clone(),startTarget:i.target.clone(),endPosition:e,endTarget:s,startTime:performance.now(),duration:1500},i.enabled=!1},[]),Et=(e,s)=>{const t=new It(e,s);t.enableDamping=!0,t.dampingFactor=.05;const i=He();t.minDistance=i*.5,t.maxDistance=i*2,t.autoRotate=_,t.autoRotateSpeed=.5,t.enablePan=!0,t.enableZoom=!0,t.target.set(0,0,0),U.current=t},Rt=o.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{we(!0),le(null),ne.log("Loading planet data from API",{planetName:a});const s=await fetch("/api/planet/rendering-data");if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const t=await s.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const i=t.planet_data,p=t.timing,u=t.rendering_data,r={planet_info:u?.planet_info||{name:i.name,type:i.planet_type,base_color:"#808080",radius:i.diameter/15e3,orbital_radius:i.orbital_radius},surface_elements:u?.surface_elements,atmosphere:u?.atmosphere,rings:u?.rings,moons:u?.moons,effects_3d:u?.effects_3d,shader_uniforms:u?.shader_uniforms,universal_actions:u?.universal_actions,timing:{cosmic_origin_time:p.cosmic_origin_time,current_time_seconds:p.current_time_seconds,elapsed_time:p.elapsed_time,initial_orbital_angle:i.initial_orbital_angle,current_orbital_angle:i.current_orbital_angle,max_orbital_radius:p.max_orbital_radius,system_max_orbital_radius:i.system_max_orbital_radius},original_planet_data:i,seeds:u?.seeds};return Qe(r),q.current=r,ne.log("API data loaded successfully",{planet:r.planet_info.name,type:r.planet_info.type,hasEffects:!!r.surface_elements,fullRenderingData:u}),Oe(r),r.moons&&(r.pendingMoonData=r.moons),l&&l(r),r}catch(e){const s=e instanceof Error?e.message:"Unknown error";return le(s),F&&F(s),null}finally{we(!1),window.isLoadingPlanetData=!1}}},[a,l,F]);o.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{we(!0),le(null),ne.log("Loading planet data from API",{planetName:a});const s=await fetch("/api/planet/rendering-data");if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const t=await s.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const i=t.planet_data,p=t.timing,u=t.rendering_data,r={planet_info:u?.planet_info||{name:i.name,type:i.planet_type,base_color:"#808080",radius:i.diameter/15e3,orbital_radius:i.orbital_radius},surface_elements:u?.surface_elements,atmosphere:u?.atmosphere,rings:u?.rings,moons:u?.moons,effects_3d:u?.effects_3d,shader_uniforms:u?.shader_uniforms,universal_actions:u?.universal_actions,timing:{cosmic_origin_time:p.cosmic_origin_time,current_time_seconds:p.current_time_seconds,elapsed_time:p.elapsed_time,initial_orbital_angle:i.initial_orbital_angle,current_orbital_angle:i.current_orbital_angle,max_orbital_radius:p.max_orbital_radius,system_max_orbital_radius:i.system_max_orbital_radius},original_planet_data:i,seeds:u?.seeds};if(Qe(r),q.current=r,ne.log("API data loaded successfully",{planet:r.planet_info.name,type:r.planet_info.type,hasEffects:!!r.surface_elements,fullRenderingData:u}),Oe(r),r.moons){if(!j.current&&E.current&&g.current){const b=r.timing?.cosmic_origin_time||51408e4;j.current=new at(g.current,ee,E.current,new Z(0,0,0),b)}if(j.current){const b={...r.moons,cosmic_origin_time:r.timing?.cosmic_origin_time||51408e4,planet_mass:r.original_planet_data?.mass||1e24,planet_radius:ee,moons:r.moons.moons.map(C=>({...C,rotation:{rotation_period_s:C.orbit.orbital_period_seconds||86400,rotation_period_hours:(C.orbit.orbital_period_seconds||86400)/3600,angular_velocity_rad_s:2*Math.PI/(C.orbit.orbital_period_seconds||86400),is_tidally_locked:!0}}))};j.current.loadMoonSystem(b)}}k.current&&g.current&&(g.current.remove(k.current),k.current.geometry.dispose(),k.current.material.dispose(),k.current=null),await Je(r),l&&l(r)}catch(e){const s=e instanceof Error?e.message:"Unknown error";le(s),F&&F(s),Me()}finally{we(!1),window.isLoadingPlanetData=!1}}},[a,M,I,f]),o.useCallback(()=>{if(!R||!D.current)return;const e=M?.orbital_period_seconds||365.25*24*3600,s=2*Math.PI/e,t=R.timing?.initial_orbital_angle||0,i=Date.now()/1e3,p=0,u=I||R.timing?.cosmic_origin_time||Date.now()/1e3-3600,r=i-u+p,b=(t+r*s)%(2*Math.PI),C=R.timing?.max_orbital_radius||100,d=20+R.planet_info?.orbital_radius/C*80,S=d,w=d*Math.cos(b),A=S*Math.sin(b);D.current.position.x=w,D.current.position.z=A,D.current.position.y=0},[R,M,I]);const Mt=o.useCallback(async e=>{const s=e||R;if(s&&g.current)try{Oe(s),k.current&&g.current&&(g.current.remove(k.current),k.current.geometry.dispose(),k.current.material.dispose(),k.current=null),await Je(s)}catch{Me()}},[R]),Me=()=>{if(!(!g.current||!D.current)){ne.warn("Applying fallback effects for planet type:",M?.planet_type);try{$e(),D.current.material instanceof Wt&&D.current.material.color.setHex(6710886);try{const e=At("generic"),s=K.createEffectsFromList(e,ee,D.current);s.forEach(t=>{t.effect.addToScene&&g.current&&D.current&&t.effect.addToScene(g.current,D.current.position)}),ge.current=s,De(s)}catch{}Ue()}catch{}}},$e=()=>{ge.current.forEach(e=>{try{K.removeEffect(e.id),e.effect.dispose&&e.effect.dispose()}catch{}}),B.current&&(B.current.dispose(),B.current=null),ge.current=[],De([])},nt=o.useCallback(()=>{Ie.current=requestAnimationFrame(nt);const e=performance.now(),s=_t.current.getDelta(),t=Date.now()/1e3,i=q.current?.timing?.cosmic_origin_time||51408e4;if(ye.current=t-i,he.current?.isAnimating&&E.current&&U.current){const r=he.current,b=e-r.startTime,C=Math.min(b/r.duration,1),d=(A=>A<.5?4*A*A*A:(A-1)*(2*A-2)*(2*A-2)+1)(C),S=E.current,w=U.current;S.position.lerpVectors(r.startPosition,r.endPosition,d),w.target.lerpVectors(r.startTarget,r.endTarget,d),S.lookAt(w.target),w.update(),C>=1&&(he.current.isAnimating=!1,w.enabled=!0,he.current=null)}else U.current&&U.current.update();try{K.updateAllEffects(s,D.current?.rotation.y,E.current||void 0)}catch{}if(D.current&&q.current){const r=(q.current.planet_info?.name||a).replace(/ /g,"_"),b=q.current.original_planet_data,C=b?.orbital_period_seconds||365.25*24*3600,P=q.current.timing?.initial_orbital_angle||0,d=b?.axial_tilt||0,S=2*Math.PI/C,w=(P+ye.current*S)%(2*Math.PI),A=q.current.timing?.max_orbital_radius||q.current.timing?.system_max_orbital_radius,W=b?.orbital_radius;if(!A||!W)return;const ue=20+W/A*80,O=b?.eccentricity_factor||.1,V=ue;D.current.position.set(0,0,0);const te=b?.rotation_period_seconds||86400,fe=2*Math.PI/te;if(D.current.rotation.y=ye.current*fe%(2*Math.PI),D.current.rotation.z=d*(Math.PI/180),L.current.length>0){const Ne=mt(r),de=pt(r),X=gt(w,V,O,Ne,de),be=Math.sqrt(X.x**2+X.y**2+X.z**2),me=V*(1-O*O)/(1+O*Math.cos(w));e-ve.current>5e3&&(console.log(`[${r}] Orbital Debug:`),console.log(`  Angle: ${w.toFixed(4)} rad (${(w*180/Math.PI).toFixed(2)}°)`),console.log(`  Semi-major axis: ${W.toFixed(4)} AU (scene: ${V.toFixed(2)})`),console.log(`  Eccentricity: ${O.toFixed(4)}`),console.log(`  Distance (Kepler 2D): ${me.toFixed(4)} scene units`),console.log(`  Distance (3D rotated): ${be.toFixed(4)} scene units`),console.log(`  Difference: ${Math.abs(be-me).toFixed(6)} (${(Math.abs(be-me)/me*100).toFixed(3)}%)`));const Be=[];L.current.forEach((pe,re)=>{let J;if(re===0)J=new Z(0,0,0);else{const H=re/L.current.length*Math.PI*2;J=new Z(50*Math.cos(H),0,50*Math.sin(H))}Be.push(J)});let Ce=0;L.current.forEach((pe,re)=>{const J=Ke.current[re],ae=Be[re],H=Math.sqrt((X.x-ae.x)**2+(X.y-ae.y)**2+(X.z-ae.z)**2);let ie=0;if(J){const oe=J.Type||"Yellow Dwarf",Ge=(ht[oe]||2)*300/(H*H);ie=Math.min(3,Math.max(.05,Ge))}else{const oe=600/(H*H);ie=Math.min(3,Math.max(.05,oe))}Ce+=ie}),Ce=Math.min(3,Ce),L.current.forEach((pe,re)=>{const J=Be[re],ae=new Z(X.x-J.x,X.y-J.y,X.z-J.z);ae.normalize();const H=ae.clone().multiplyScalar(-200);if(re===0?pe.intensity=Ce:pe.intensity=0,pe.position.copy(H),pe.target.position.set(0,0,0),re===0&&g.current){if(!z.current){const oe=new ct(1,16,16),st=new lt({color:16776960,transparent:!0,opacity:.8});z.current=new ut(oe,st),z.current.visible=!1,g.current.add(z.current);const Ge=new Ht,Ct=new Vt({color:16776960,transparent:!0,opacity:.3}),We=new Yt(Ge,Ct);We.visible=!1,z.current.debugLine=We,g.current.add(We)}z.current.position.copy(H);const ie=z.current.debugLine;if(ie){const oe=new Float32Array([H.x,H.y,H.z,0,0,0]);ie.geometry.setAttribute("position",new qt(oe,3)),ie.geometry.attributes.position.needsUpdate=!0}}}),N.current&&L.current[0]&&N.current.updateFromThreeLight(L.current[0])}}ge.current.forEach(r=>{r.effect.updateUniforms&&r.effect.updateUniforms(s)});const u=Array.from(K.effects.values()).find(r=>r.type==="toxic_post_processing")?.enabled||!1;if(B.current&&u&&(B.current.update(s),L.current[0]&&B.current.updateLightPosition(L.current[0].position,E.current)),$.current&&g.current&&E.current){j.current&&j.current.update();const r=performance.now();B.current&&u?B.current.render():$.current.render(g.current,E.current);const b=performance.now()-r;if(e-ve.current>5e3){const C=1e3/(e-ve.current);Ue(),Ae(P=>({...P,frameRate:Math.round(C),renderTime:Math.round(b*100)/100})),ve.current=e}}},[]),Ue=o.useCallback(()=>{const e=K.getStats();Ae(s=>({...s,activeEffects:e.activeEffects,enabledEffects:e.enabledEffects}))},[]);return o.useEffect(()=>{let e=!0;return(async()=>{try{if(!e)return;const t=await Rt();if(!e)return;if(!wt()){e&&le("Failed to initialize 3D renderer");return}if(!e||(nt(),v.current&&"ResizeObserver"in window&&(Ee.current=new ResizeObserver(ke),Ee.current.observe(v.current)),window.addEventListener("resize",ke),v.current&&(v.current.addEventListener("mousedown",Ze),v.current.addEventListener("mousemove",et),v.current.addEventListener("click",tt)),!e))return;t?await Mt(t):Me()}catch(t){e&&le(t instanceof Error?t.message:"Unknown initialization error")}})(),()=>{if(e=!1,q.current=null,Ie.current&&cancelAnimationFrame(Ie.current),Ee.current&&Ee.current.disconnect(),window.removeEventListener("resize",ke),v.current&&(v.current.removeEventListener("mousedown",Ze),v.current.removeEventListener("mousemove",et),v.current.removeEventListener("click",tt)),$e(),N.current&&(N.current.dispose(),N.current=null),j.current&&(j.current.dispose(),j.current=null),U.current&&U.current.dispose(),_e.current&&g.current&&(g.current.remove(_e.current),_e.current.geometry.dispose(),_e.current.material.dispose(),_e.current=null),k.current&&g.current&&(g.current.remove(k.current),k.current.geometry.dispose(),k.current.material.dispose(),k.current=null),z.current&&g.current){const t=z.current.debugLine;t&&(g.current.remove(t),t.geometry.dispose(),t.material.dispose()),g.current.remove(z.current),z.current.geometry.dispose(),z.current.material.dispose(),z.current=null}if($.current&&v.current)try{v.current.contains($.current.domElement)&&v.current.removeChild($.current.domElement),$.current.dispose()}catch{}}},[]),o.useEffect(()=>{if(z.current){z.current.visible=xe;const e=z.current.debugLine;e&&(e.visible=xe)}g.current&&g.current.children.forEach(e=>{e instanceof ft&&(e.visible=xe)})},[xe]),o.useEffect(()=>{let e="";const s=t=>{e+=t.key.toLowerCase(),e.length>5&&(e=e.slice(-5)),e==="atlas"&&(yt(i=>!i),e="")};return window.addEventListener("keypress",s),()=>{window.removeEventListener("keypress",s)}},[]),o.useEffect(()=>{const e=setInterval(()=>{const s=K.getStats();Ae(t=>({...t,activeEffects:s.activeEffects,enabledEffects:s.enabledEffects}))},1e4);return()=>clearInterval(e)},[]),o.useEffect(()=>{if(R&&R.pendingMoonData&&j.current){const e=R.pendingMoonData,s={...e,cosmic_origin_time:R.timing?.cosmic_origin_time||51408e4,planet_mass:R.original_planet_data?.mass||1e24,planet_radius:ee,moons:e.moons.map(t=>({...t,rotation:{rotation_period_s:t.orbit.orbital_period_seconds||86400,rotation_period_hours:(t.orbit.orbital_period_seconds||86400)/3600,angular_velocity_rad_s:2*Math.PI/(t.orbit.orbital_period_seconds||86400),is_tidally_locked:!0}}))};j.current.loadMoonSystem(s),delete R.pendingMoonData}},[R,j.current]),rr(R),c.jsxs("div",{className:`relative ${n}`,children:[y&&R&&c.jsx(tr,{planetData:R,showInPage:!0,showInConsole:!0}),c.jsx("div",{ref:v,className:"w-full h-full",style:{minHeight:"300px",aspectRatio:"1"}}),c.jsx(er,{isVisible:je}),Ye&&c.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-50",children:c.jsxs("div",{className:"text-white text-center",children:[c.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"}),c.jsx("div",{children:"Loading planet..."})]})}),qe&&c.jsxs("div",{className:"absolute top-0 left-0 right-0 p-2 bg-red-500 text-white text-sm",children:[c.jsx("strong",{children:"Error:"})," ",qe]}),R&&!Ye&&c.jsxs("div",{className:"absolute bottom-0 left-0 p-2 text-white bg-black bg-opacity-50 max-w-xs rounded-tr-lg",children:[c.jsx("h3",{className:"text-xs font-bold",children:R.planet_info.name}),R.moons&&c.jsxs("div",{className:"text-xs mt-1",children:["Moons: ",R.moons.count]})]}),y&&c.jsxs("div",{className:"absolute top-0 right-0 p-4 text-white bg-black bg-opacity-70 text-xs font-mono",children:[c.jsx("h4",{className:"font-bold mb-2",children:"Debug Info"}),c.jsxs("div",{children:["Frame Rate: ",Pe.frameRate," FPS"]}),c.jsxs("div",{children:["Render Time: ",Pe.renderTime,"ms"]}),c.jsxs("div",{children:["Active Effects: ",Pe.activeEffects]}),c.jsxs("div",{children:["Enabled Effects: ",Pe.enabledEffects]}),c.jsxs("div",{className:"mt-2",children:[c.jsx("div",{className:"font-semibold",children:"Effects:"}),bt.map(e=>c.jsxs("div",{className:"ml-2",children:[e.type," (",e.enabled?"ON":"OFF",")"]},e.id))]})]})]})});class sr extends o.Component{constructor(n){super(n),this.state={hasError:!1,error:null}}static getDerivedStateFromError(n){return{hasError:!0,error:n.message}}componentDidCatch(n,m){}render(){return this.state.hasError?c.jsx("div",{className:"flex items-center justify-center w-full h-full bg-gray-900/50 rounded",children:c.jsxs("div",{className:"text-center p-4",children:[c.jsx("div",{className:"text-red-400 text-sm mb-2",children:"3D Renderer Error"}),c.jsx("div",{className:"text-xs text-gray-400",children:this.state.error})]})}):this.props.children}}const _r=o.forwardRef((a,n)=>c.jsx(sr,{children:c.jsx(nr,{ref:n,...a})}));export{er as E,_r as M,Se as S,Qt as U,Zt as a,Kt as b};
