import{S as ct}from"./atlas_ouOT0ykXceu4Q_V1lX7IB.js";import{G as mt,C as V,V as g,B as pt,k as st,p as yt,j as at,q as gt,R as wt,M as rt,i as xt,g as vt}from"./atlas_C0Xm8D4F9LGKGgzeG7E8_.js";class it{landGroup;lands=[];constructor(e,o={}){this.landGroup=new mt;const s=o.seed||Math.floor(Math.random()*1e6),a=new ct(s);o.greenPatches&&o.greenPatches.length>0?this.generateLandsFromPython(e,o.greenPatches,a,o):this.generateProceduralLands(e,a,o)}generateLandsFromPython(e,o,s,a){o.forEach((i,b)=>{let d=i.position_3d||i.position||[0,0,1];if(d.length===2){const t=s.uniform(0,Math.PI*2),n=Math.acos(s.uniform(-1,1));d=[Math.sin(n)*Math.cos(t),Math.sin(n)*Math.sin(t),Math.cos(n)]}const h=(i.size||.1)*e*1.8;Math.max(8,Math.min(i.sides||20,12));let m=new V(4881497),w=1;i.color&&Array.isArray(i.color)&&(m=new V(i.color[0],i.color[1],i.color[2]),i.color.length>3&&(w=i.color[3]));const M=Math.max(24,Math.min(64,Math.floor(h*32))),f=new g(d[0],d[1],d[2]).normalize(),S=new g,W=new g;Math.abs(f.y)<.99?S.crossVectors(f,new g(0,1,0)).normalize():S.crossVectors(f,new g(1,0,0)).normalize(),W.crossVectors(f,S).normalize();const q=2/Math.max(h*.05,1),_=(t,n)=>{let c=0,r=1,l=q,u=0;const k=Math.min(5,Math.max(3,Math.floor(h/40)+2));for(let G=0;G<k;G++){const C=t*l,I=n*l,y=(P,ft)=>{const Mt=P*12.9898+ft*78.233;return Math.sin(Mt+s.uniform(0,1e3))*43758.5453%1},x=Math.floor(C),$=Math.floor(I),Y=C-x,Z=I-$,N=P=>P*P*P*(P*(P*6-15)+10),v=N(Y),U=N(Z),H=y(x,$),J=y(x+1,$),nt=y(x,$+1),O=y(x+1,$+1),j=H*(1-v)+J*v,ht=nt*(1-v)+O*v,ut=j*(1-U)+ht*U;c+=ut*r,u+=r,r*=.5,l*=2.2}return c/u},z=[],X=[],K=[],lt=.35,L=new Map,dt=new Map;let Q=0;for(let t=0;t<=M;t++)for(let n=0;n<=M;n++){const c=(t/M-.5)*2,r=(n/M-.5)*2,l=Math.sqrt(c*c+r*r),u=_(c*2,r*2);if(1-l*.5+u*.6>lt&&l<1.2){const G=c*h,C=r*h,y=new g().addScaledVector(S,G).addScaledVector(W,C).addScaledVector(f,0);z.push(y.x,y.y,y.z),K.push((c+1)*.5,(r+1)*.5),L.set(`${t},${n}`,Q),dt.set(`${t},${n}`,u),Q++}}for(let t=0;t<M;t++)for(let n=0;n<M;n++){const c=L.get(`${t},${n}`),r=L.get(`${t+1},${n}`),l=L.get(`${t},${n+1}`),u=L.get(`${t+1},${n+1}`);c!==void 0&&r!==void 0&&l!==void 0&&X.push(c,r,l),r!==void 0&&u!==void 0&&l!==void 0&&X.push(r,u,l)}const p=new pt;p.setAttribute("position",new st(z,3)),p.setAttribute("uv",new st(K,2)),p.setIndex(X),p.computeVertexNormals();const B=p.attributes.position,T=f.clone().multiplyScalar(e),tt=new g;for(let t=0;t<B.count;t++){tt.fromBufferAttribute(B,t);const c=tt.clone().add(T).clone().normalize(),r=p.attributes.uv;if(r){const l=r.getX(t)*2-1,u=r.getY(t)*2-1,k=Math.sqrt(l*l+u*u),G=_(l*2,u*2),I=Math.max(0,1-Math.pow(k,.7))*.5+G*.5,x=(j=>j*j*(3-2*j))(I),Y=e*1.01-e,Z=h*.15,N=Math.min(Z,Y*.9),v=e*.008,U=e+v,H=e+v+N,J=yt.lerp(U,H,x),O=c.multiplyScalar(J).sub(T);B.setXYZ(t,O.x,O.y,O.z)}}B.needsUpdate=!0,p.computeVertexNormals(),p.translate(T.x,T.y,T.z);const et=new at({color:a.transparentMode?new V(15135743):m,opacity:a.transparentMode?.3:w,transparent:a.transparentMode||w<1,emissive:a.transparentMode?new V(13428479).multiplyScalar(.1):m.clone().multiplyScalar(.05),emissiveIntensity:a.transparentMode?.05:1e-7,shininess:a.transparentMode?30:8,flatShading:!1,bumpScale:.002,depthWrite:!0,depthTest:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),E=document.createElement("canvas");E.width=E.height=64;const ot=E.getContext("2d"),F=ot.createImageData(64,64);for(let t=0;t<F.data.length;t+=4){const n=s.uniform(.8,1.2),c=Math.floor(128*n);F.data[t]=c,F.data[t+1]=c,F.data[t+2]=c,F.data[t+3]=255}ot.putImageData(F,0,0);const R=new gt(E);R.wrapS=R.wrapT=wt,R.repeat.set(2,2),et.bumpMap=R;const A=new rt(p,et);A.castShadow=!0,A.receiveShadow=!0,A.renderOrder=1,this.lands.push(A),this.landGroup.add(A)})}generateProceduralLands(e,o,s){const a=Math.floor(o.uniform(5,15));for(let i=0;i<a;i++){const b=o.uniform(0,Math.PI*2),d=Math.acos(o.uniform(-1,1)),h=new g(Math.sin(d)*Math.cos(b),Math.sin(d)*Math.sin(b),Math.cos(d)),m=e*o.uniform(.02,.08),w=new xt(m,16),M=h.clone().multiplyScalar(e*1.002);w.lookAt(h),w.translate(M.x,M.y,M.z);const f=o.uniform(.3,.7),S=new V(.36*(1-f)+.22*f,.23*(1-f)+.36*f,0),q=s.tundraMode||!1?.25:1,_=new at({color:s.transparentMode?new V(15135743):S,opacity:s.transparentMode?.3:q,transparent:s.transparentMode||q<1,emissive:s.transparentMode?new V(13428479).multiplyScalar(.1):657920,shininess:s.transparentMode?30:5,depthWrite:!0,depthTest:!0}),z=new rt(w,_);z.renderOrder=1,this.lands.push(z),this.landGroup.add(z)}}addToScene(e,o){o&&this.landGroup.position.copy(o),e.add(this.landGroup)}update(e){}getObject3D(){return this.landGroup}dispose(){this.lands.forEach(e=>{e.geometry.dispose(),e.material instanceof vt&&e.material.dispose()}),this.lands=[],this.landGroup.clear()}}function bt(D,e,o){const s=e.green_patches;if(!s||s.length===0)return null;const a=o||Math.floor(Math.random()*1e6);return new it(D,{greenPatches:s,seed:a+6e3})}function St(D,e,o){const s=o||Math.floor(Math.random()*1e6),a=new ct(s+7e3),i=Math.floor(a.uniform(3,8)),b=[];for(let d=0;d<i;d++){const h=a.uniform(0,Math.PI*2),m=Math.acos(a.uniform(-1,1));b.push({position_3d:[Math.sin(m)*Math.cos(h),Math.sin(m)*Math.sin(h),Math.cos(m)],size:a.uniform(.05,.15),sides:Math.floor(a.uniform(8,16)),color:[0,0,0]})}return new it(D,{greenPatches:b,seed:s+7e3,transparentMode:!0})}export{it as L,St as a,bt as c};
