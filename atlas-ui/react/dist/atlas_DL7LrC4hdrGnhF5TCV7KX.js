import{j as c,r as i}from"./atlas_BG-O7ORrd1CIuvq6sOIEu.js";import{W as It}from"./atlas_DpO-yiEKcG7KgC12H7eV0.js";import{O as Dt}from"./atlas_efhr8mvI8-JsNPBr6yH7D.js";import{Q as Tt}from"./atlas_DTMHG0KBmlmtp0V4aoQDq.js";import{e as H}from"./atlas_D_aWA0cQNsTSlrLwUqQRr.js";import{E as se,c as At}from"./atlas_CgamtdYbhMIZNBHFzNNuU.js";import{g as Ft}from"./atlas_CQO8D_vmQG9g3x-h0Xcdn.js";import{P as Lt}from"./atlas_GT-l48vKMnLmWgrB6ilt1.js";import{M as st}from"./atlas_C1_4-jDYXLOYS1oeE2ZGc.js";import{c as jt}from"./atlas_CntGewpi1NWhKdxg4EDl-.js";import{s as at}from"./atlas_CXe69HDW-Q8b_kGwXRltZ.js";import{a3 as kt,a4 as zt,f as Ot,a5 as Ut,C as it,a6 as Nt,a7 as Bt,a8 as $t,a9 as Gt,aa as ot,b as ct,z as lt,M as ut,V as ee,ab as ft,ac as Wt,m as Ht,B as Vt,a2 as Yt,o as qt,a as Qt}from"./atlas_DUxdE5_5iPCKlmI6uaLFO.js";class Xt{static isRemoteUniverse(){try{const n=document.getElementById("data-universe-config");return n?JSON.parse(n.textContent||"{}").remote===!0:!1}catch(n){return console.error("Error checking universe type:",n),!1}}static getUniverseConfig(){try{const n=document.getElementById("data-universe-config");return n?JSON.parse(n.textContent||"{}"):null}catch(n){return console.error("Error parsing universe config:",n),null}}}class Me{static encodeUrl(n){return btoa(n).replace(/\+/g,"-").replace(/\//g,"_")}static generateGalaxyUrl(n,m=1){const h=`coordinates=${n[0]},${n[1]},${n[2]}&page=${m}`;return`/stargate/${this.encodeUrl(h)}`}static generateSystemUrl(n,m,h){const _=`coordinates=${n[0]},${n[1]},${n[2]}&system=${m}`;return`/stargate/${this.encodeUrl(_)}`}static generatePlanetUrl(n,m,h,_){const w=`coordinates=${n[0]},${n[1]},${n[2]}&system=${m}&planet=${h.toLowerCase()}`;return`/stargate/${this.encodeUrl(w)}`}static getCurrentPage(){try{const m=new URLSearchParams(window.location.search).get("page");if(m)return parseInt(m,10);const h=window.location.pathname.match(/\/galaxy\/(\d+)/);return h?parseInt(h[1],10):1}catch{return 1}}}const Jt=(a,n)=>{try{const m=a.split("/stargate/")[1];if(!m)return null;const h=atob(m.replace(/-/g,"+").replace(/_/g,"/")),_=new URLSearchParams(h),w=_.get("coordinates"),b=_.get("system"),M=_.get("planet");if(!w)return null;const I={type:n,coordinates:w};return b&&(I.systemIndex=parseInt(b)),M&&(I.planetName=M),I}catch{return null}},dt=a=>{try{const n=a.coordinates.split(",").map(Number),m=Me.getCurrentPage();let h;switch(a.type){case"galaxy":h=Me.generateGalaxyUrl(n,m);break;case"system":if(a.systemIndex!==void 0)h=Me.generateSystemUrl(n,a.systemIndex,m);else return window.location.href;break;case"planet":if(a.systemIndex!==void 0&&a.planetName)h=Me.generatePlanetUrl(n,a.systemIndex,a.planetName,m);else return window.location.href;break;default:return window.location.href}return`${window.location.origin}${h}`}catch{return window.location.href}},Zt=async a=>{const{url:n,size:m}=a;return new Promise((h,_)=>{const w=document.createElement("canvas"),b=m,M=Math.floor(m*.8);Tt.toCanvas(w,n,{width:M,margin:0,color:{dark:"#000000",light:"#FFFFFF"},errorCorrectionLevel:"H"},I=>{if(I){_(I);return}const f=document.createElement("canvas"),l=f.getContext("2d"),j=Math.floor(b*.17);if(f.width=b,f.height=b+j,l){const O=Math.floor(b*.1);l.fillStyle="#FFFFFF",l.beginPath(),l.roundRect(0,0,f.width,f.height,O),l.fill();const q=(b-M)/2;l.drawImage(w,q,q),l.fillStyle="#000000",l.font=`bold ${Math.floor(b*.13)}px Arial`,l.textAlign="center",l.textBaseline="middle",l.fillText("VIEW IT LIVE",b/2,b+j*.2),h(f)}})})},Kt=async(a,n,m,h)=>{try{if(Xt.isRemoteUniverse())return;let _;if("coordinates"in h)_=dt(h);else{const l=Jt(h.stargateUrl,h.type);l?_=dt(l):_=h.stargateUrl}if(_.startsWith("http://localhost/"))try{const j=await(await fetch("/api/universe/config")).json(),O=45156749731585371360938718175484539659389209313560548011495000289036640085049n,q=4515674973158537e61,Q=j.config_seed;(Q===q||Q===O||BigInt(Q)===O)&&(_=_.replace("http://localhost/","https://the-atlas.koyeb.app/"))}catch(l){console.warn("Failed to check config seed:",l)}const w=Math.floor(n/8),b=await Zt({url:_,size:w}),M=Math.floor(n/100),I=n-b.width-M,f=m-b.height-M;a.drawImage(b,I,f)}catch(_){console.warn("Failed to generate QR code:",_)}},er=(a,n)=>{const{imageWidth:m,imageHeight:h,startYear:_=2023,companyName:w="Banshee",opacity:b=.5,fontSize:M}=n,I=new Date().getFullYear(),f=I===_?`${_}`:`${_}-${I}`,l=`The Atlas Â© Copyright ${w} â€¢ ${f}`;a.fillStyle=`rgba(255, 255, 255, ${b})`;const j=M||Math.floor(m/80);a.font=`${j}px Arial`,a.textAlign="left",a.textBaseline="bottom";const O=Math.floor(m/100);a.fillText(l,O,h-O)},tr=({isVisible:a,message:n="Exporting view, please wait..."})=>c.jsxs("div",{className:`absolute inset-0 bg-black flex flex-col items-center justify-center z-10 transition-all duration-300 ${a?"opacity-100 visible":"opacity-0 invisible"}`,children:[c.jsx("div",{className:"w-16 h-16 border-4 border-white/20 border-t-white rounded-full animate-spin mb-6"}),c.jsx("p",{className:"text-white text-xl font-medium text-center px-4",children:n})]}),rr=({planetData:a,showInConsole:n=!0,showInPage:m=!1})=>{const[h,_]=i.useState([]),[w,b]=i.useState({});i.useEffect(()=>{if(!a)return;const f=M(a);b(f),_(I(a)),typeof window<"u"&&(window.__DEBUG_PLANET_DATA=a,window.__DEBUG_PLANET_ANALYSIS=f)},[a,n]);function M(f){const l={hasValidStructure:!1,missingFields:[],dataIntegrity:"unknown",renderingIssues:[],colorConsistency:"unknown"};if(f.planet_info&&f.surface_elements?l.hasValidStructure=!0:(f.planet_info||l.missingFields.push("planet_info"),f.surface_elements||l.missingFields.push("surface_elements")),f.surface_elements?.type==="oceanic"&&(l.oceanicData={hasAbstractLands:!!f.surface_elements.abstract_lands?.length,numGreenPatches:f.surface_elements.green_patches?.length||0,numClouds:f.surface_elements.clouds?.length||0,hasDepths:f.surface_elements.depths?.enabled||!1,baseColorIsBlue:f.planet_info?.base_color==="#0000FF",greenPatchColor:f.surface_elements.green_patches?.[0]?.color,issues:[]},l.oceanicData.numGreenPatches>15&&l.oceanicData.issues.push("Muchos parches verdes pueden ocultar el ocÃ©ano azul"),l.oceanicData.baseColorIsBlue||l.oceanicData.issues.push(`Color base no es azul puro: ${f.planet_info?.base_color}`),l.renderingIssues=l.oceanicData.issues),f.planet_info?.base_color&&f.planet_info?.type){const O={Oceanic:"#0000FF",Rocky:"#808080",Icy:"#ADD8E6",Desert:"#FFD700",Lava:"#FF0000"}[f.planet_info.type];O&&f.planet_info.base_color!==O?l.colorConsistency=`Inconsistente: esperado ${O}, recibido ${f.planet_info.base_color}`:l.colorConsistency="Correcto"}return l}function I(f){const l=[];if(!f.surface_elements?.type)return["No surface type defined"];const j=f.surface_elements.type.toLowerCase();switch(j){case"oceanic":l.push("OceanWavesEffect (PROBLEMA: ignora green_patches de Python)");break;case"rocky":l.push("RockyTerrainEffect");break;case"icy":l.push("IcyTerrainEffect");break;case"gas giant":l.push("GasGiantBandsEffect");break;default:l.push(`Generic effect for type: ${j}`)}return f.atmosphere?.density>0&&l.push("AtmosphericEffect"),f.rings&&l.push("RingSystemEffect"),l}return m?c.jsxs("div",{style:{position:"fixed",top:10,right:10,background:"rgba(0, 0, 0, 0.9)",color:"#00ff00",padding:"10px",borderRadius:"5px",fontFamily:"monospace",fontSize:"12px",maxWidth:"400px",maxHeight:"600px",overflow:"auto",zIndex:1e4,border:"1px solid #00ff00"},children:[c.jsxs("h3",{style:{margin:"0 0 10px 0",color:"#00ff00"},children:["ðŸ” Planet Debug: ",a.planet_info?.name]}),c.jsxs("div",{style:{marginBottom:"10px"},children:[c.jsx("strong",{children:"Type:"})," ",a.planet_info?.type,c.jsx("br",{}),c.jsx("strong",{children:"Base Color:"})," ",a.planet_info?.base_color,c.jsx("br",{}),c.jsx("strong",{children:"Radius:"})," ",a.planet_info?.radius]}),a.surface_elements?.type==="oceanic"&&c.jsxs("div",{style:{marginBottom:"10px",borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[c.jsx("strong",{children:"ðŸŒŠ Oceanic Data:"}),c.jsx("br",{}),c.jsxs("span",{style:{color:w.oceanicData?.baseColorIsBlue?"#00ff00":"#ff0000"},children:["Base Color: ",w.oceanicData?.baseColorIsBlue?"âœ“ Blue":"âœ— Not Blue"]}),c.jsx("br",{}),"Green Patches: ",w.oceanicData?.numGreenPatches,c.jsx("br",{}),"Clouds: ",w.oceanicData?.numClouds,c.jsx("br",{}),"Has Depths: ",w.oceanicData?.hasDepths?"Yes":"No",c.jsx("br",{}),w.oceanicData?.issues?.length>0&&c.jsxs("div",{style:{color:"#ffaa00",marginTop:"5px"},children:["âš ï¸ Issues:",c.jsx("br",{}),w.oceanicData.issues.map((f,l)=>c.jsxs("div",{children:["- ",f]},l))]})]}),c.jsxs("div",{style:{borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[c.jsx("strong",{children:"ðŸŽ¨ Effects Applied:"}),c.jsx("br",{}),h.map((f,l)=>c.jsxs("div",{style:{color:f.includes("PROBLEMA")?"#ff0000":"#00ff00"},children:["- ",f]},l))]}),c.jsx("button",{style:{marginTop:"10px",background:"#00ff00",color:"#000",border:"none",padding:"5px 10px",cursor:"pointer",borderRadius:"3px"},children:"Log to Console"})]}):null};function nr(a){i.useEffect(()=>{if(a&&a.surface_elements?.type==="oceanic"){a.surface_elements.green_patches?.length>0;const n=a.planet_info?.base_color;n!=="#0000FF"&&console.warn("âš ï¸ Planeta oceÃ¡nico sin color azul base!",n)}},[a])}const te=2.5,He=()=>{const a=45*Math.PI/180;return te/(Math.tan(a/2)*.5)},mt=a=>{let n=0;for(let m=0;m<a.length;m++)n=(n<<5)-n+a.charCodeAt(m),n=n&n;return Math.abs(n)%1e4/1e4*.15},pt=a=>{let n=0;for(let m=0;m<a.length;m++)n=(n<<3)-n+a.charCodeAt(m)*7,n=n&n;return Math.abs(n)%1e4/1e4*Math.PI*2},gt=(a,n,m,h,_)=>{const w=n*(1-m*m)/(1+m*Math.cos(a)),b=w*Math.cos(a),M=w*Math.sin(a),I=b*Math.cos(_)-M*Math.sin(_)*Math.cos(h),f=b*Math.sin(_)+M*Math.cos(_)*Math.cos(h),l=M*Math.sin(h);return new ee(I,l,f)},ht={"Red Dwarf":1,"Yellow Dwarf":2,"Blue Giant":8,"Red Giant":3,"White Dwarf":2.5,"Neutron Star":1.5},sr=i.forwardRef(({planetName:a,containerClassName:n="",width:m=800,height:h=600,autoRotate:_=!0,enableControls:w=!0,showDebugInfo:b=!1,planetData:M,cosmicOriginTime:I,initialAngleRotation:f,timeOffset:l=0,onDataLoaded:j,onEffectsCreated:O,onError:q,onMoonSelected:Q,planetUrl:Ce},_t)=>{const P=i.useRef(null),g=i.useRef(null),U=i.useRef(null),v=i.useRef(null),D=i.useRef(null),N=i.useRef(null),yt=i.useRef(new kt),Se=i.useRef(null),ge=i.useRef(0),X=i.useRef(null),Ie=i.useRef(l),[Ve,we]=i.useState(!0),[Ye,le]=i.useState(null),[E,qe]=i.useState(null),[bt,De]=i.useState([]),[xe,wt]=i.useState(!1),[Pe,Te]=i.useState({activeEffects:0,enabledEffects:0,frameRate:0,renderTime:0}),he=i.useRef([]),Ae=i.useRef(0),ve=i.useRef(null),B=i.useRef(null),F=i.useRef(null),$=i.useRef(null),Fe=i.useRef(new zt),Le=i.useRef(new Ot),ae=i.useRef(null),Ee=i.useRef(!1),[je,Qe]=i.useState(!1),[ir,ke]=i.useState(null),_e=i.useRef(null);i.useImperativeHandle(_t,()=>({captureScreenshot:()=>{if(!U.current||!g.current||!v.current||je)return;Qe(!0),N.current&&(N.current.enabled=!1);const e=U.current,s=g.current,t=v.current,o=e.domElement.width,p=e.domElement.height,u=3840/o,r=[];s.traverse(x=>{if(x.isPoints&&x.material){const d=x.material;if(d.size!==void 0){r.push({material:d,originalSize:d.size});const R=d.isPulsatingCubeParticle===!0?u*.3:u*1;d.size=d.size*R}if(d.uniforms){const R=d.isPulsatingCubeParticle===!0?u*.3:u*1;d.uniforms.size&&(r.push({material:d,uniform:"size",originalValue:d.uniforms.size.value}),d.uniforms.size.value=d.uniforms.size.value*R),d.uniforms.scale&&(r.push({material:d,uniform:"scale",originalValue:d.uniforms.scale.value}),d.uniforms.scale.value=d.uniforms.scale.value*R)}if(x.geometry&&x.geometry.attributes.size){const S=x.geometry.attributes.size,R=S.array.slice();r.push({geometry:x.geometry,originalSizeArray:R});const W=d.isPulsatingCubeParticle===!0?u*.3:u*1;for(let A=0;A<S.array.length;A++)S.array[A]*=W;S.needsUpdate=!0}}if(x.isSprite&&(r.push({object:x,originalScale:x.scale.clone()}),x.scale.multiplyScalar(u*1)),x.isLine&&x.material){const d=x.material;d.linewidth!==void 0&&(r.push({material:d,originalLinewidth:d.linewidth}),d.linewidth=d.linewidth*u*1)}});const y=3840,C=3840;e.setSize(y,C),t.aspect=1,t.updateProjectionMatrix(),e.render(s,t),e.domElement.toBlob(x=>{if(x){const d=document.createElement("canvas"),S=d.getContext("2d");if(d.width=y,d.height=C,S){const R=new Image;R.onload=async()=>{S.drawImage(R,0,0),er(S,{imageWidth:y,imageHeight:C}),Ce&&await Kt(S,y,C,{type:"planet",stargateUrl:Ce}),d.toBlob(W=>{if(W){const A=URL.createObjectURL(W),J=document.createElement("a");J.href=A,J.download=`planet_${a}_${Date.now()}.jpg`,J.click(),URL.revokeObjectURL(A)}},"image/jpeg",1)};const T=URL.createObjectURL(x);R.src=T}}r.forEach(({material:d,object:S,originalSize:R,originalScale:T,originalLinewidth:W,uniform:A,originalValue:J,geometry:ue,originalSizeArray:V})=>{if(R!==void 0&&(d.size=R),T!==void 0&&S.scale.copy(T),W!==void 0&&(d.linewidth=W),A&&J!==void 0&&(d.uniforms[A].value=J),ue&&V){const Z=ue.attributes.size;for(let re=0;re<V.length;re++)Z.array[re]=V[re];Z.needsUpdate=!0}}),e.setSize(o,p),t.aspect=o/p,t.updateProjectionMatrix(),N.current&&(N.current.enabled=!0),Qe(!1)},"image/jpeg",1)},isGeneratingImage:je}));const ze=i.useCallback(()=>{if(!P.current||!U.current||!v.current)return;const e=P.current,s=e.clientWidth||400,t=e.clientHeight||400;U.current.setSize(s,t),$.current&&$.current.setSize(s,t),v.current.aspect=s/t,v.current.updateProjectionMatrix()},[]),Xe=async e=>{if(!(!D.current||!g.current||!B.current)){se.log("Applying modular effects from API data",{planet:e.planet_info.name,type:e.planet_info.type});try{Ne();const s=Ft(e);B.current.updateBaseColor(s);const t=H.createEffectsFromPythonPlanetData(e,te,D.current,g.current,B.current),o=e.planet_info?.type||e.surface_elements?.planet_type||e.planet_type;if((o==="toxic"||o==="Toxic")&&g.current&&v.current&&U.current)try{const p=jt(g.current,v.current,U.current,te,{planet_type:"toxic",toxic_intensity:.8,atmosphere_thickness:.6},e.seeds?.planet_seed);if(p){$.current=p;const u={id:`effect_toxic_postprocessing_${Date.now()}`,type:"toxic_post_processing",effect:{dispose:()=>p.dispose(),update:r=>p.update(r),updateUniforms:r=>p.update(r),addToScene:()=>{},apply:()=>{}},priority:100,enabled:!0,name:"Toxic Post-Processing (Bloom + Godrays + Chromatic Aberration)"};H.effects.set(u.id,u),t.push(u),se.log("Created toxic post-processing effects")}}catch(p){se.error("Error creating toxic post-processing",p)}else $.current&&($.current.dispose(),$.current=null);De(t),he.current=t,O&&O(t),se.log(`Successfully applied ${t.length} modular effects`),Be()}catch{Re()}}},xt=i.useCallback(()=>{if(!P.current)return!1;try{for(;P.current.firstChild;)P.current.removeChild(P.current.firstChild);g.current=null,v.current=null,U.current=null,D.current=null,k.current=null;const e=P.current,s=e.clientWidth||m||400,t=e.clientHeight||h||400,o=new Ut;o.background=new it(1297),g.current=o;const p=new Nt(45,s/t,.1,1e4),u=He();p.position.set(0,0,u),p.lookAt(0,0,0),v.current=p;const r=new It({antialias:!0,alpha:!0,powerPreference:"high-performance"});return r.setSize(s,t),r.setPixelRatio(Math.min(window.devicePixelRatio,2)),r.shadowMap.enabled=!0,r.shadowMap.type=Bt,r.toneMapping=$t,r.toneMappingExposure=1.2,r.outputColorSpace=Gt,r.domElement.className="",P.current.appendChild(r.domElement),U.current=r,vt(o,null),Et(o),w&&Rt(p,r.domElement),!0}catch{return!1}},[E,M,I]),L=i.useRef([]),Je=i.useRef([]),Oe=i.useRef(null),ye=i.useRef(null),k=i.useRef(null),z=i.useRef(null),Pt=e=>{e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.camera.left=-10,e.shadow.camera.right=10,e.shadow.camera.top=10,e.shadow.camera.bottom=-10},Ue=e=>{if(L.current.length===0||!g.current)return;const s=e?.original_planet_data||e,t=s?.initial_orbital_angle||0,o=s?.orbital_period_seconds||365.25*24*3600,p=2*Math.PI/o,u=(t+ge.current*p)%(2*Math.PI),r=e?.planet_info?.name||e?.name||e?.original_planet_data?.name||"unknown_planet",y=s?.eccentricity_factor||.1,C=mt(r),x=pt(r),d=e?.planet_info?.orbital_radius||s?.orbital_radius||1,S=e?.timing?.max_orbital_radius||s?.system_max_orbital_radius||1,W=20+d/S*80,A=gt(u,W,y,C,x),J=Math.sqrt(A.x**2+A.y**2+A.z**2),ue=200;L.current.forEach((V,Z)=>{const re=Je.current[Z],fe=new ee(-A.x,-A.y,-A.z);if(Z>0){const de=Z*30;fe.x+=de*Math.cos(Z),fe.z+=de*Math.sin(Z)}fe.normalize();const $e=fe.multiplyScalar(ue);if(re){const de=re.Type||"Yellow Dwarf",be=(ht[de]||2)*300/(J*J),me=Math.min(3,Math.max(.05,be));V.intensity=me}V.position.copy($e),V.target.position.set(0,0,0),g.current.children.includes(V.target)||g.current.add(V.target)}),Oe.current&&Oe.current.position.set(A.x*.5,0,A.z*.5),B.current&&L.current[0]&&B.current.updateFromThreeLight(L.current[0]),L.current[0]&&H.updateLightForAllEffects(L.current[0])},vt=(e,s)=>{{const t=new ot(16777215,2);t.position.set(-10,5,10),t.target.position.set(0,0,0),t.castShadow=!0,Pt(t),e.add(t),e.add(t.target),L.current=[t];const o=new ot(16777215,.01);o.position.set(8,-3,-5),e.add(o),Oe.current=o,setTimeout(()=>{B.current&&t&&B.current.updateFromThreeLight(t),t&&H.updateLightForAllEffects(t)},50);return}},Et=e=>{const s=new ct(te,128,64),t=new lt({color:8421504}),o=new ut(s,t);o.castShadow=!0,o.receiveShadow=!0,o.position.set(0,0,0),e.add(o),D.current=o;const p=new it(8421504);B.current=new Lt(o,p),B.current.addToScene(e),v.current&&(F.current=new st(e,te,v.current,new ee(0,0,0),51408e4));const u=new ft(20);u.visible=!1,e.add(u)},Ze=i.useCallback(e=>{P.current?.getBoundingClientRect()&&(ae.current={x:e.clientX,y:e.clientY,time:Date.now()},Ee.current=!1)},[]),Ke=i.useCallback(e=>{if(!ae.current)return;const s=e.clientX-ae.current.x,t=e.clientY-ae.current.y;Math.sqrt(s*s+t*t)>5&&(Ee.current=!0)},[]),et=i.useCallback(e=>{if(!v.current||!g.current||!F.current||!N.current||!ae.current)return;const s=Date.now()-ae.current.time,t=Ee.current;if(ae.current=null,Ee.current=!1,t||s>500)return;const o=P.current?.getBoundingClientRect();if(!o)return;Le.current.x=(e.clientX-o.left)/o.width*2-1,Le.current.y=-((e.clientY-o.top)/o.height)*2+1,Fe.current.setFromCamera(Le.current,v.current);const p=F.current.getMoonAtPosition(Fe.current);if(p){ke(p),Q&&Q(p);const u=F.current.getMoonPosition(p.name);if(u){const r=te*8,y=new ee(u.x,u.y+r*.3,u.z+r);tt(y,u)}}else if(Fe.current.intersectObject(D.current||new Wt,!0).length>0){ke(null),Q&&Q(null);const r=new ee(0,0,0),y=He(),C=new ee(0,0,y);tt(C,r)}else ke(null),Q&&Q(null)},[]),tt=i.useCallback((e,s)=>{if(!v.current||!N.current)return;const t=v.current,o=N.current;_e.current={isAnimating:!0,startPosition:t.position.clone(),startTarget:o.target.clone(),endPosition:e,endTarget:s,startTime:performance.now(),duration:1500},o.enabled=!1},[]),Rt=(e,s)=>{const t=new Dt(e,s);t.enableDamping=!0,t.dampingFactor=.05;const o=He();t.minDistance=o*.5,t.maxDistance=o*2,t.autoRotate=_,t.autoRotateSpeed=.5,t.enablePan=!0,t.enableZoom=!0,t.target.set(0,0,0),N.current=t},Mt=i.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{we(!0),le(null),se.log("Loading planet data from API",{planetName:a});const s=await fetch("/api/planet/rendering-data");if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const t=await s.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const o=t.planet_data,p=t.timing,u=t.rendering_data,r={planet_info:u?.planet_info||{name:o.name,type:o.planet_type,base_color:"#808080",radius:o.diameter/15e3,orbital_radius:o.orbital_radius},surface_elements:u?.surface_elements,atmosphere:u?.atmosphere,rings:u?.rings,moons:u?.moons,effects_3d:u?.effects_3d,shader_uniforms:u?.shader_uniforms,universal_actions:u?.universal_actions,timing:{cosmic_origin_time:p.cosmic_origin_time,current_time_seconds:p.current_time_seconds,elapsed_time:p.elapsed_time,initial_orbital_angle:o.initial_orbital_angle,current_orbital_angle:o.current_orbital_angle,max_orbital_radius:p.max_orbital_radius,system_max_orbital_radius:o.system_max_orbital_radius},original_planet_data:o,seeds:u?.seeds};return qe(r),X.current=r,se.log("API data loaded successfully",{planet:r.planet_info.name,type:r.planet_info.type,hasEffects:!!r.surface_elements,fullRenderingData:u}),Ue(r),r.moons&&(r.pendingMoonData=r.moons),j&&j(r),r}catch(e){const s=e instanceof Error?e.message:"Unknown error";return le(s),q&&q(s),null}finally{we(!1),window.isLoadingPlanetData=!1}}},[a,j,q]);i.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{we(!0),le(null),se.log("Loading planet data from API",{planetName:a});const s=await fetch("/api/planet/rendering-data");if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const t=await s.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const o=t.planet_data,p=t.timing,u=t.rendering_data,r={planet_info:u?.planet_info||{name:o.name,type:o.planet_type,base_color:"#808080",radius:o.diameter/15e3,orbital_radius:o.orbital_radius},surface_elements:u?.surface_elements,atmosphere:u?.atmosphere,rings:u?.rings,moons:u?.moons,effects_3d:u?.effects_3d,shader_uniforms:u?.shader_uniforms,universal_actions:u?.universal_actions,timing:{cosmic_origin_time:p.cosmic_origin_time,current_time_seconds:p.current_time_seconds,elapsed_time:p.elapsed_time,initial_orbital_angle:o.initial_orbital_angle,current_orbital_angle:o.current_orbital_angle,max_orbital_radius:p.max_orbital_radius,system_max_orbital_radius:o.system_max_orbital_radius},original_planet_data:o,seeds:u?.seeds};if(qe(r),X.current=r,se.log("API data loaded successfully",{planet:r.planet_info.name,type:r.planet_info.type,hasEffects:!!r.surface_elements,fullRenderingData:u}),Ue(r),r.moons){if(!F.current&&v.current&&g.current){const y=r.timing?.cosmic_origin_time||51408e4;F.current=new st(g.current,te,v.current,new ee(0,0,0),y)}if(F.current){const y={...r.moons,cosmic_origin_time:r.timing?.cosmic_origin_time||51408e4,planet_mass:r.original_planet_data?.mass||1e24,planet_radius:te,moons:r.moons.moons.map(C=>({...C,rotation:{rotation_period_s:C.orbit.orbital_period_seconds||86400,rotation_period_hours:(C.orbit.orbital_period_seconds||86400)/3600,angular_velocity_rad_s:2*Math.PI/(C.orbit.orbital_period_seconds||86400),is_tidally_locked:!0}}))};F.current.loadMoonSystem(y)}}k.current&&g.current&&(g.current.remove(k.current),k.current.geometry.dispose(),k.current.material.dispose(),k.current=null),await Xe(r),j&&j(r)}catch(e){const s=e instanceof Error?e.message:"Unknown error";le(s),q&&q(s),Re()}finally{we(!1),window.isLoadingPlanetData=!1}}},[a,M,I,f]),i.useCallback(()=>{if(!E||!D.current)return;const e=M?.orbital_period_seconds||365.25*24*3600,s=2*Math.PI/e,t=E.timing?.initial_orbital_angle||0,o=Date.now()/1e3,p=0,u=I||E.timing?.cosmic_origin_time||Date.now()/1e3-3600,r=o-u+p,y=(t+r*s)%(2*Math.PI),C=E.timing?.max_orbital_radius||100,d=20+E.planet_info?.orbital_radius/C*80,S=d,R=d*Math.cos(y),T=S*Math.sin(y);D.current.position.x=R,D.current.position.z=T,D.current.position.y=0},[E,M,I]);const Ct=i.useCallback(async e=>{const s=e||E;if(s&&g.current)try{Ue(s),k.current&&g.current&&(g.current.remove(k.current),k.current.geometry.dispose(),k.current.material.dispose(),k.current=null),await Xe(s)}catch{Re()}},[E]),Re=()=>{if(!(!g.current||!D.current)){se.warn("Applying fallback effects for planet type:",M?.planet_type);try{Ne(),D.current.material instanceof Ht&&D.current.material.color.setHex(6710886);try{const e=At("generic"),s=H.createEffectsFromList(e,te,D.current);s.forEach(t=>{t.effect.addToScene&&g.current&&D.current&&t.effect.addToScene(g.current,D.current.position)}),he.current=s,De(s)}catch{}Be()}catch{}}},Ne=()=>{he.current.forEach(e=>{try{H.removeEffect(e.id),e.effect.dispose&&e.effect.dispose()}catch{}}),$.current&&($.current.dispose(),$.current=null),he.current=[],De([])},rt=i.useCallback(()=>{Se.current=requestAnimationFrame(rt);const e=performance.now(),s=yt.current.getDelta(),t=Date.now()/1e3,o=X.current?.timing?.cosmic_origin_time||51408e4;if(ge.current=t-o+Ie.current,F.current&&F.current.setTimeOffset(Ie.current),_e.current?.isAnimating&&v.current&&N.current){const r=_e.current,y=e-r.startTime,C=Math.min(y/r.duration,1),d=(T=>T<.5?4*T*T*T:(T-1)*(2*T-2)*(2*T-2)+1)(C),S=v.current,R=N.current;S.position.lerpVectors(r.startPosition,r.endPosition,d),R.target.lerpVectors(r.startTarget,r.endTarget,d),S.lookAt(R.target),R.update(),C>=1&&(_e.current.isAnimating=!1,R.enabled=!0,_e.current=null)}else N.current&&N.current.update();try{H.updateAllEffects(s,D.current?.rotation.y,v.current||void 0,ge.current)}catch{}if(D.current&&X.current){const r=(X.current.planet_info?.name||a).replace(/ /g,"_"),y=X.current.original_planet_data,C=y?.orbital_period_seconds||365.25*24*3600,x=X.current.timing?.initial_orbital_angle||0,d=y?.axial_tilt||0,S=2*Math.PI/C,R=(x+ge.current*S)%(2*Math.PI),T=X.current.timing?.max_orbital_radius||X.current.timing?.system_max_orbital_radius,W=y?.orbital_radius;if(!T||!W)return;const ue=20+W/T*80,V=y?.eccentricity_factor||.1,Z=ue;D.current.position.set(0,0,0);const re=y?.rotation_period_seconds||86400,fe=2*Math.PI/re;if(D.current.rotation.y=ge.current*fe%(2*Math.PI),D.current.rotation.z=d*(Math.PI/180),L.current.length>0){const $e=mt(r),de=pt(r),Y=gt(R,Z,V,$e,de);Math.sqrt(Y.x**2+Y.y**2+Y.z**2);const be=[];L.current.forEach((pe,ne)=>{let K;if(ne===0)K=new ee(0,0,0);else{const G=ne/L.current.length*Math.PI*2;K=new ee(50*Math.cos(G),0,50*Math.sin(G))}be.push(K)});let me=0;L.current.forEach((pe,ne)=>{const K=Je.current[ne],ie=be[ne],G=Math.sqrt((Y.x-ie.x)**2+(Y.y-ie.y)**2+(Y.z-ie.z)**2);let oe=0;if(K){const ce=K.Type||"Yellow Dwarf",Ge=(ht[ce]||2)*300/(G*G);oe=Math.min(3,Math.max(.05,Ge))}else{const ce=600/(G*G);oe=Math.min(3,Math.max(.05,ce))}me+=oe}),me=Math.min(3,me),L.current.forEach((pe,ne)=>{const K=be[ne],ie=new ee(Y.x-K.x,Y.y-K.y,Y.z-K.z);ie.normalize();const G=ie.clone().multiplyScalar(-200);if(ne===0?pe.intensity=me:pe.intensity=0,pe.position.copy(G),pe.target.position.set(0,0,0),ne===0&&g.current){if(!z.current){const ce=new ct(1,16,16),nt=new lt({color:16776960,transparent:!0,opacity:.8});z.current=new ut(ce,nt),z.current.visible=!1,g.current.add(z.current);const Ge=new Vt,St=new Yt({color:16776960,transparent:!0,opacity:.3}),We=new qt(Ge,St);We.visible=!1,z.current.debugLine=We,g.current.add(We)}z.current.position.copy(G);const oe=z.current.debugLine;if(oe){const ce=new Float32Array([G.x,G.y,G.z,0,0,0]);oe.geometry.setAttribute("position",new Qt(ce,3)),oe.geometry.attributes.position.needsUpdate=!0}}}),B.current&&L.current[0]&&B.current.updateFromThreeLight(L.current[0]),L.current[0]&&H.updateLightForAllEffects(L.current[0]),H.updateOrbitalPositionForAllEffects(Y)}}he.current.forEach(r=>{r.effect.updateUniforms&&r.effect.updateUniforms(s)});const u=Array.from(H.effects.values()).find(r=>r.type==="toxic_post_processing")?.enabled||!1;if($.current&&u&&($.current.update(s),L.current[0]&&$.current.updateLightPosition(L.current[0].position,v.current)),U.current&&g.current&&v.current){F.current&&F.current.update();const r=performance.now();$.current&&u?$.current.render():U.current.render(g.current,v.current);const y=performance.now()-r;if(e-Ae.current>5e3){const C=1e3/(e-Ae.current);Be(),Te(x=>({...x,frameRate:Math.round(C),renderTime:Math.round(y*100)/100})),Ae.current=e}}},[]),Be=i.useCallback(()=>{const e=H.getStats();Te(s=>({...s,activeEffects:e.activeEffects,enabledEffects:e.enabledEffects}))},[]);return i.useEffect(()=>{let e=!0;return(async()=>{try{if(!e)return;const t=await Mt();if(!e)return;if(!xt()){e&&le("Failed to initialize 3D renderer");return}if(!e||(rt(),P.current&&"ResizeObserver"in window&&(ve.current=new ResizeObserver(ze),ve.current.observe(P.current)),window.addEventListener("resize",ze),P.current&&(P.current.addEventListener("mousedown",Ze),P.current.addEventListener("mousemove",Ke),P.current.addEventListener("click",et)),!e))return;t?await Ct(t):Re()}catch(t){e&&le(t instanceof Error?t.message:"Unknown initialization error")}})(),()=>{if(e=!1,X.current=null,Se.current&&cancelAnimationFrame(Se.current),ve.current&&ve.current.disconnect(),window.removeEventListener("resize",ze),P.current&&(P.current.removeEventListener("mousedown",Ze),P.current.removeEventListener("mousemove",Ke),P.current.removeEventListener("click",et)),Ne(),B.current&&(B.current.dispose(),B.current=null),F.current&&(F.current.dispose(),F.current=null),N.current&&N.current.dispose(),ye.current&&g.current&&(g.current.remove(ye.current),ye.current.geometry.dispose(),ye.current.material.dispose(),ye.current=null),k.current&&g.current&&(g.current.remove(k.current),k.current.geometry.dispose(),k.current.material.dispose(),k.current=null),z.current&&g.current){const t=z.current.debugLine;t&&(g.current.remove(t),t.geometry.dispose(),t.material.dispose()),g.current.remove(z.current),z.current.geometry.dispose(),z.current.material.dispose(),z.current=null}if(U.current&&P.current)try{P.current.contains(U.current.domElement)&&P.current.removeChild(U.current.domElement),U.current.dispose()}catch{}}},[]),i.useEffect(()=>(Ie.current=l,at(l),()=>{at(0)}),[l]),i.useEffect(()=>{if(z.current){z.current.visible=xe;const e=z.current.debugLine;e&&(e.visible=xe)}g.current&&g.current.children.forEach(e=>{e instanceof ft&&(e.visible=xe)})},[xe]),i.useEffect(()=>{let e="";const s=t=>{e+=t.key.toLowerCase(),e.length>5&&(e=e.slice(-5)),e==="atlas"&&(wt(o=>!o),e="")};return window.addEventListener("keypress",s),()=>{window.removeEventListener("keypress",s)}},[]),i.useEffect(()=>{const e=setInterval(()=>{const s=H.getStats();Te(t=>({...t,activeEffects:s.activeEffects,enabledEffects:s.enabledEffects}))},1e4);return()=>clearInterval(e)},[]),i.useEffect(()=>{if(E&&E.pendingMoonData&&F.current){const e=E.pendingMoonData,s={...e,cosmic_origin_time:E.timing?.cosmic_origin_time||51408e4,planet_mass:E.original_planet_data?.mass||1e24,planet_radius:te,moons:e.moons.map(t=>({...t,rotation:{rotation_period_s:t.orbit.orbital_period_seconds||86400,rotation_period_hours:(t.orbit.orbital_period_seconds||86400)/3600,angular_velocity_rad_s:2*Math.PI/(t.orbit.orbital_period_seconds||86400),is_tidally_locked:!0}}))};F.current.loadMoonSystem(s),delete E.pendingMoonData}},[E,F.current]),nr(E),c.jsxs("div",{className:`relative ${n}`,children:[b&&E&&c.jsx(rr,{planetData:E,showInPage:!0,showInConsole:!0}),c.jsx("div",{ref:P,className:"w-full h-full",style:{minHeight:"300px",aspectRatio:"1"}}),c.jsx(tr,{isVisible:je}),Ve&&c.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-50",children:c.jsxs("div",{className:"text-white text-center",children:[c.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"}),c.jsx("div",{children:"Loading planet..."})]})}),Ye&&c.jsxs("div",{className:"absolute top-0 left-0 right-0 p-2 bg-red-500 text-white text-sm",children:[c.jsx("strong",{children:"Error:"})," ",Ye]}),E&&!Ve&&c.jsxs("div",{className:"absolute bottom-0 left-0 p-2 text-white bg-black bg-opacity-50 max-w-xs rounded-tr-lg",children:[c.jsx("h3",{className:"text-xs font-bold",children:E.planet_info.name}),E.moons&&c.jsxs("div",{className:"text-xs mt-1",children:["Moons: ",E.moons.count]})]}),b&&c.jsxs("div",{className:"absolute top-0 right-0 p-4 text-white bg-black bg-opacity-70 text-xs font-mono",children:[c.jsx("h4",{className:"font-bold mb-2",children:"Debug Info"}),c.jsxs("div",{children:["Frame Rate: ",Pe.frameRate," FPS"]}),c.jsxs("div",{children:["Render Time: ",Pe.renderTime,"ms"]}),c.jsxs("div",{children:["Active Effects: ",Pe.activeEffects]}),c.jsxs("div",{children:["Enabled Effects: ",Pe.enabledEffects]}),c.jsxs("div",{className:"mt-2",children:[c.jsx("div",{className:"font-semibold",children:"Effects:"}),bt.map(e=>c.jsxs("div",{className:"ml-2",children:[e.type," (",e.enabled?"ON":"OFF",")"]},e.id))]})]})]})});class ar extends i.Component{constructor(n){super(n),this.state={hasError:!1,error:null}}static getDerivedStateFromError(n){return{hasError:!0,error:n.message}}componentDidCatch(n,m){}render(){return this.state.hasError?c.jsx("div",{className:"flex items-center justify-center w-full h-full bg-gray-900/50 rounded",children:c.jsxs("div",{className:"text-center p-4",children:[c.jsx("div",{className:"text-red-400 text-sm mb-2",children:"3D Renderer Error"}),c.jsx("div",{className:"text-xs text-gray-400",children:this.state.error})]})}):this.props.children}}const br=i.forwardRef((a,n)=>c.jsx(ar,{children:c.jsx(sr,{ref:n,...a})}));export{tr as E,br as M,Me as S,Xt as U,er as a,Kt as b};
