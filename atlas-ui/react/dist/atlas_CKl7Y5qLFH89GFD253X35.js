import{c as Z}from"./atlas_DTMHG0KBmlmtp0V4aoQDq.js";import{V as B,a6 as ae,m as $,f as X,o as D,i as ne,M as q,G as J,b as H,C as K,F as oe,z as Q,c as ee,v as re,w as te,u as ce,B as ie,a2 as se,ad as le,e as he}from"./atlas_DUxdE5_5iPCKlmI6uaLFO.js";class pe{scene;planetRadius;moonMeshes=[];orbitalLines=[];moonData=null;cosmicOriginTime;lastRelaxationSummary=0;moonMaterials=new Map;camera;planetPosition;orbitalLinesFadeEnabled=!0;orbitalLinesVisible=!0;orbitalLinesTargetOpacity=1;orbitalLinesCurrentOpacity=1;lastCameraPosition=new B;lastCameraTarget=new B;lastInteractionTime=0;fadeOutTimer=null;initialShowTimer=null;cameraMovementThreshold=.01;fadeOutDelay=3e3;initialShowDuration=5e3;fadeSpeed=.05;constructor(e,t,i,a,n){if(this.scene=e,this.planetRadius=t,this.camera=i,this.planetPosition=a,this.cosmicOriginTime=n,this.lastCameraPosition.copy(this.camera.position),this.camera instanceof ae){const o=new B;this.camera.getWorldDirection(o),this.lastCameraTarget.copy(o)}this.startInitialShowTimer(),this.initializeMaterials()}initializeMaterials(){this.moonMaterials.set("rocky",new $({color:9143936,roughness:.9,metalness:.1,normalScale:new X(.8,.8)})),this.moonMaterials.set("icy",new $({color:14737648,roughness:.3,metalness:.05,normalScale:new X(.4,.4)})),this.moonMaterials.set("asteroidal",new $({color:4865578,roughness:.95,metalness:.15,normalScale:new X(1.2,1.2)})),this.moonMaterials.set("captured",new $({color:7035722,roughness:.8,metalness:.08,normalScale:new X(.9,.9)}))}loadMoonSystem(e){this.moonData=e,e.cosmic_origin_time&&(this.cosmicOriginTime=e.cosmic_origin_time),this.clearMoons(),this.createMoons()}clearMoons(){this.orbitalLines.forEach(e=>{this.scene.remove(e),e.traverse(t=>{t instanceof D&&(t.geometry.dispose(),t.material instanceof ne&&t.material.dispose())})}),this.orbitalLines=[],this.moonMeshes.forEach(e=>{this.scene.remove(e),e.traverse(t=>{t instanceof q&&(t.geometry.dispose(),Array.isArray(t.material)?t.material.forEach(i=>i.dispose()):t.material.dispose())})}),this.moonMeshes=[]}createMoons(){this.moonData&&this.moonData.moons.forEach((e,t)=>{const i=this.createMoonMesh(e,t);this.moonMeshes.push(i),this.scene.add(i)})}createMoonMesh(e,t){const i=new J;i.name=`moon-${e.name}`;let a=e.visuals.relative_size;const n=.06,o=.35,s=a<.02?8:4;let c=Math.max(n,Math.min(o,a*s));const l=this.planetRadius*c,_=32,h=Math.max(.5,Math.min(2,c*10)),S=Math.floor(_*h),w=Math.floor(S/2),f=(e.procedural?.seed||0)*.618034%(Math.PI*2),p=new H(l,S,w,f);this.generateProceduralSurface(p,e,l);let r;switch(e.properties.type){case"icy":r=new $({color:16777215,roughness:.2,metalness:.05,transparent:!1});break;case"asteroidal":r=new $({color:16777215,roughness:.95,metalness:.15,transparent:!1});break;case"captured":r=new $({color:16777215,roughness:.8,metalness:.08,transparent:!1});break;default:r=new $({color:16777215,roughness:.8,metalness:.1,transparent:!1});break}switch(this.applyMoonTexture(r,e),e.properties.type){case"icy":const m=e.procedural?.seed||0,b=this.createSeededRandom(m+9999)();let d=1;b>.8?d=1.4:b>.6?d=1.2:b<.2?d=.6:b<.4&&(d=.8),r.emissive=new K(4877194).multiplyScalar(.05*d),r.emissiveIntensity=.6*d,r.envMapIntensity=1*d,r.roughness=Math.max(.05,.15/d),r.metalness=.02,r.transparent=!0,r.opacity=Math.min(1,.95+(d-1)*.1);break;case"asteroidal":r.emissive=new K(2759178).multiplyScalar(.03),r.emissiveIntensity=.3,r.envMapIntensity=.1,r.roughness=.98,r.metalness=.18;break;case"captured":r.emissive=new K(5917242).multiplyScalar(.04),r.emissiveIntensity=.4,r.envMapIntensity=.3,r.roughness=.75,r.metalness=.12;break;default:r.emissive=new K(9136404).multiplyScalar(.04),r.emissiveIntensity=.4,r.envMapIntensity=.4,r.roughness=.85,r.metalness=.08;break}r.transparent=!1,r.side=oe,r.aoMapIntensity=.8,r.normalScale=new X(1,1);const g=new q(p,r);if(g.name=`moon-surface-${e.name}`,g.castShadow=!0,g.receiveShadow=!0,g.userData={moonData:e,moonIndex:t,isMoon:!0},i.add(g),this.createOrbitalTrail(e,t),a<.02){const m=new H(l*1.3,8,4),b=new Q({color:4473924,transparent:!0,opacity:.3,side:ee}),d=new q(m,b);d.name=`moon-glow-${e.name}`,i.add(d)}if(e.visuals.has_atmosphere&&e.visuals.atmosphere_color){const m=new H(l*1.05,16,8),b=new Q({color:e.visuals.atmosphere_color,transparent:!0,opacity:e.visuals.atmosphere_opacity||.1,side:ee}),d=new q(m,b);d.name=`moon-atmosphere-${e.name}`,i.add(d)}return this.updateMoonPosition(i,e,0,t),i}generateProceduralSurface(e,t,i){const a=t.procedural?.seed||0,n=Z(this.createSeededRandom(a)),o=e.attributes.position.array,s=.5,c=this.calculateHydrostaticRelaxation(t),_=.7+(a*13+4567)%1e3/1e3*.6;let h;switch(t.properties.type){case"icy":h=i*.15;break;case"asteroidal":h=i*.18;break;case"captured":h=i*.12;break;default:h=i*.09;break}const w=h*(1-c)*_;for(let u=0;u<o.length;u+=3){const f=o[u],p=o[u+1],r=o[u+2],g=f*s,m=p*s,b=r*s;let d=0;switch(t.properties.type){case"icy":d+=n(g*2,m*2,b*2)*.8,d+=n(g*6,m*6,b*6)*.4,d+=n(g*15,m*15,b*15)*.2;break;case"asteroidal":d+=n(g*.8,m*.8,b*.8)*1.5,d+=n(g*3,m*3,b*3)*1,d+=n(g*8,m*8,b*8)*.7,d+=n(g*20,m*20,b*20)*.4,d+=n(g*50,m*50,b*50)*.2;break;case"captured":d+=n(g*1.2,m*1.2,b*1.2)*1.2,d+=n(g*4,m*4,b*4)*.8,d+=n(g*10,m*10,b*10)*.5,d+=n(g*30,m*30,b*30)*.25;break;default:d+=n(g*1.5,m*1.5,b*1.5)*1,d+=n(g*5,m*5,b*5)*.6,d+=n(g*12,m*12,b*12)*.3,d+=n(g*25,m*25,b*25)*.15;break}const T=new B(f,p,r),k=T.clone().normalize(),P=T.add(k.multiplyScalar(d*w));o[u]=P.x,o[u+1]=P.y,o[u+2]=P.z}e.attributes.position.needsUpdate=!0,e.computeVertexNormals()}applyMoonTexture(e,t){this.createProceduralColorTexture(e,t)}createProceduralColorTexture(e,t){const a=document.createElement("canvas");a.width=256,a.height=256;const n=a.getContext("2d"),o=t.visuals.base_color;let s;if(o&&o.startsWith("#")){const y=o.slice(1);s={r:parseInt(y.slice(0,2),16),g:parseInt(y.slice(2,4),16),b:parseInt(y.slice(4,6),16)}}else switch(t.properties.type){case"icy":s={r:160,g:170,b:190};break;case"asteroidal":s={r:74,g:62,b:42};break;case"captured":s={r:107,g:91,b:74};break;default:s={r:139,g:134,b:128};break}const c=t.procedural?.seed||Math.abs(t.name.split("").reduce((y,F)=>y+F.charCodeAt(0),0)),l=Math.abs(c)%1e6,_=l===0?12345:l,h=Z(this.createSeededRandom(_+777));let S=0,w=0,u=0;const f=_%100*.1,p=_/100%100*.1,r=_/1e4%100*.1;switch(t.properties.type){case"icy":S=h(f+1,p+2,r+3)*120,w=h(f+4,p+5,r+6)*100,u=h(f+7,p+8,r+9)*110;const y=h(f*.5,p*.5,r*.5),F=h(f*.3,p*.7,r*.4),O=h(f*.8,p*.2,r*.6);let V=1;O>.4?V=1.4:O>.1?V=1.2:O<-.4?V=.6:O<-.1&&(V=.8),y>.3?(S-=40,w+=50,u+=60):y<-.3?(S+=60,w-=20,u+=20):F>.4?(S+=40,w+=35,u-=30,V*=.9):F<-.4&&(S-=30,w-=20,u+=50),S*=V,w*=V,u*=V;break;case"asteroidal":S=h(f+10,p+11,r+12)*60,w=h(f+13,p+14,r+15)*55,u=h(f+16,p+17,r+18)*50;break;case"captured":S=h(f+19,p+20,r+21)*50,w=h(f+22,p+23,r+24)*45,u=h(f+25,p+26,r+27)*40;break;default:S=h(f+28,p+29,r+30)*55,w=h(f+31,p+32,r+33)*50,u=h(f+34,p+35,r+36)*45;break}({...s},s={r:Math.max(20,Math.min(255,s.r+S)),g:Math.max(20,Math.min(255,s.g+w)),b:Math.max(30,Math.min(255,s.b+u))}),n.fillStyle=`rgb(${s.r}, ${s.g}, ${s.b})`,n.fillRect(0,0,256,256);const g=(_*7919+41)%233280,m=Z(this.createSeededRandom(g)),b=n.getImageData(0,0,256,256),d=b.data;for(let y=0;y<256;y++)for(let F=0;F<256;F++){const O=(y*256+F)*4,V=F/256,W=y/256,U=(V-.5)*2*Math.PI,N=(W-.5)*Math.PI,x=Math.cos(N)*Math.cos(U),L=Math.cos(N)*Math.sin(U),C=Math.sin(N),G=(g*17+8901)%1e3,M=.5+G/1e3*1,A=.8+G/1e3*.4;let v=0;switch(t.properties.type){case"icy":v+=m(x*(2*M),L*(2*M),C*(2*M))*(.5*A),v+=m(x*(6*M),L*(6*M),C*(6*M))*(.3*A),v+=m(x*(15*M),L*(15*M),C*(15*M))*(.2*A);const E=m(x*30,L*30,C*30)*.1;v+=E*A;break;case"asteroidal":v+=m(x*(1.2*M),L*(1.2*M),C*(1.2*M))*(.75*A),v+=m(x*(4*M),L*(4*M),C*(4*M))*(.55*A),v+=m(x*(10*M),L*(10*M),C*(10*M))*(.35*A),v+=m(x*(25*M),L*(25*M),C*(25*M))*(.22*A);break;case"captured":v+=m(x*(1.8*M),L*(1.8*M),C*(1.8*M))*(.6*A),v+=m(x*(5*M),L*(5*M),C*(5*M))*(.38*A),v+=m(x*(12*M),L*(12*M),C*(12*M))*(.2*A);break;default:v+=m(x*(2*M),L*(2*M),C*(2*M))*(.55*A),v+=m(x*(6*M),L*(6*M),C*(6*M))*(.33*A),v+=m(x*(16*M),L*(16*M),C*(16*M))*(.18*A);break}let I,R,z;if(t.properties.type==="icy"){if(I=s.r,R=s.g,z=s.b,v>0){const j=v*.5;I=I*(1-j*.15),R=R*(1+j*.2),z=z*(1+j*.25)}else{const j=Math.abs(v)*.5;I=I*(1+j*.1),R=R*(1-j*.15),z=z*(1+j*.05)}const E=1+v*.3;I=I*E,R=R*E,z=z*E;const Y=m(x*8,L*8,C*8);Y>.5?(I=Math.min(255,I*1.05),R=Math.min(255,R*1.08),z=Math.min(255,z*1.1)):Y<-.5&&(I=I*.95,R=R*.97,z=z*1.02),I=Math.max(0,Math.min(255,I)),R=Math.max(0,Math.min(255,R)),z=Math.max(0,Math.min(255,z))}else{const E=1+v;I=Math.max(0,Math.min(255,s.r*E)),R=Math.max(0,Math.min(255,s.g*E)),z=Math.max(0,Math.min(255,s.b*E))}d[O]=I,d[O+1]=R,d[O+2]=z,d[O+3]=255}n.putImageData(b,0,0);const T=new re(a);T.wrapS=te,T.wrapT=te,T.generateMipmaps=!0,T.needsUpdate=!0;const P=(t.procedural?.seed||0)*.618034%1;T.offset.x=P,T.repeat.set(1,1),e.map=T,e.needsUpdate=!0}drawCrater(e,t,i){const a=(i.position.lon+180)/360*t,n=(90-i.position.lat)/180*t,o=Math.max(20,i.radius*t*.8),s=e.createRadialGradient(a,n,0,a,n,o);s.addColorStop(0,"rgba(0, 0, 0, 0.95)"),s.addColorStop(.2,"rgba(10, 10, 10, 0.8)"),s.addColorStop(.5,"rgba(40, 40, 40, 0.6)"),s.addColorStop(.8,"rgba(100, 100, 100, 0.4)"),s.addColorStop(.95,"rgba(180, 180, 180, 0.3)"),s.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=s,e.beginPath(),e.arc(a,n,o,0,2*Math.PI),e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.7)",e.lineWidth=3,e.beginPath(),e.arc(a,n,o*.9,0,2*Math.PI),e.stroke(),e.strokeStyle="rgba(220, 220, 220, 0.5)",e.lineWidth=1,e.beginPath(),e.arc(a,n,o*.95,0,2*Math.PI),e.stroke()}createSeededRandom(e){let t=e*9301+49297;return()=>(t=(t*9301+49297)%233280,t/233280)}calculateHydrostaticRelaxation(e){const t=e.properties.radius_km*1e3,i=e.properties.mass_kg,a=e.properties.density_kg_m3;if(!isFinite(t)||!isFinite(i)||!isFinite(a)||t<=0||i<=0||a<=0)return 0;const o=66743e-15*i/(t*t);if(!isFinite(o)||o<=0)return 0;let s;switch(e.properties.type){case"icy":const u=e.tidal_heating?.tidal_power_watts||0,f=4*Math.PI*t*t,p=u/f;p>1e3?s=1e12:p>100?s=1e15:p>10?s=1e18:p>1?s=1e20:s=1e21;break;case"asteroidal":s=1e26;break;case"captured":s=1e24;break;default:t>5e5?s=1e22:t>1e5?s=1e23:s=1e25;break}let c;e.properties.type==="icy"?(e.tidal_heating?.tidal_power_watts||0)>1e12?c=1e9:c=35e8:c=3e10;const l=s/c;if(!isFinite(l)||l<=0)return 0;const h=Date.now()/1e3-this.cosmicOriginTime;if(!isFinite(h)||h<0)return 0;const S=h/l,w=1-Math.exp(-S);return e.tidal_heating?.tidal_power_watts,this.lastRelaxationSummary||(this.lastRelaxationSummary=0),this.lastRelaxationSummary<Date.now()-5e3&&(this.lastRelaxationSummary=Date.now()),Math.max(0,Math.min(1,w))}updateMoonSurfaceRelaxation(e,t){const i=e.getObjectByName(`moon-surface-${t.name}`);if(!i||!(i.geometry instanceof H))return;const a=this.calculateHydrostaticRelaxation(t),n=t.procedural?.seed||0,o=i.geometry,s=o.parameters.radius,c=Z(this.createSeededRandom(n)),l=o.attributes.position.array,_=.5,S=.7+(n*13+4567)%1e3/1e3*.6;let w;switch(t.properties.type){case"icy":w=s*.15;break;case"asteroidal":w=s*.18;break;case"captured":w=s*.12;break;default:w=s*.09;break}const f=w*(1-a)*S;for(let p=0;p<l.length;p+=3){const r=l[p],g=l[p+1],m=l[p+2],b=new B(r,g,m),d=b.length(),T=b.clone().normalize(),k=r/d*_,P=g/d*_,y=m/d*_;let F=0;switch(t.properties.type){case"icy":F+=c(k*2,P*2,y*2)*.8,F+=c(k*6,P*6,y*6)*.4,F+=c(k*15,P*15,y*15)*.2;break;case"asteroidal":F+=c(k*.8,P*.8,y*.8)*1.5,F+=c(k*3,P*3,y*3)*1,F+=c(k*8,P*8,y*8)*.7,F+=c(k*20,P*20,y*20)*.4,F+=c(k*50,P*50,y*50)*.2;break;case"captured":F+=c(k*1.2,P*1.2,y*1.2)*1.2,F+=c(k*4,P*4,y*4)*.8,F+=c(k*10,P*10,y*10)*.5,F+=c(k*30,P*30,y*30)*.25;break;default:F+=c(k*1.5,P*1.5,y*1.5)*1,F+=c(k*5,P*5,y*5)*.6,F+=c(k*12,P*12,y*12)*.3,F+=c(k*25,P*25,y*25)*.15;break}const O=T.clone().multiplyScalar(s+F*f);l[p]=O.x,l[p+1]=O.y,l[p+2]=O.z}o.attributes.position.needsUpdate=!0,o.computeVertexNormals()}drawMaria(e,t,i,a=0){const n=(i.position.lon+180)/360*t,o=(90-i.position.lat)/180*t,s=Math.max(15,i.radius*t*.4),c=e.createRadialGradient(n,o,0,n,o,s);c.addColorStop(0,`rgba(10, 10, 10, ${i.darkness*.9})`),c.addColorStop(.6,`rgba(25, 25, 25, ${i.darkness*.7})`),c.addColorStop(1,`rgba(40, 40, 40, ${i.darkness*.3})`),e.fillStyle=c,e.beginPath(),e.arc(n,o,s,0,2*Math.PI),e.fill();const l=this.createSeededRandom(a+Math.floor(n+o));e.fillStyle=`rgba(60, 50, 40, ${i.darkness*.2})`;for(let _=0;_<5;_++){const h=n+(l()-.5)*s*.8,S=o+(l()-.5)*s*.8;e.beginPath(),e.arc(h,S,2+l()*3,0,2*Math.PI),e.fill()}}calculateOrbitalParameters(e){const t=Math.max(...this.moonData.moons.map(T=>T.orbit.semi_major_axis_km)),i=e.orbit.semi_major_axis_km/t,a=Math.log10(1+i*9),o=e.properties.origin==="co-formation"&&e.properties.density_kg_m3<1500?2.5:1.8,c=this.planetRadius*o*1.2,l=this.planetRadius*4,_=c+a*l,h=this.planetRadius*10,S=Math.min(_,h),w=e.orbit.eccentricity,f=Math.min(3,1/.5),p=Math.min(.8,w*f),g=Math.min(e.orbit.inclination_deg*3,60),m=ce.degToRad(g),b=e.orbit.argument_of_periapsis||0,d=e.orbit.longitude_of_ascending_node||0;return{semiMajorAxis:S,eccentricity:p,inclination:m,argumentOfPeriapsis:b,longitudeOfAscendingNode:d}}createOrbitalTrail(e,t){const i=this.calculateOrbitalParameters(e),a=i.semiMajorAxis,n=i.eccentricity,o=i.inclination,s=i.argumentOfPeriapsis,c=i.longitudeOfAscendingNode,l=[],_=128;for(let u=0;u<=_;u++){const f=u/_*Math.PI*2,p=a*(1-n*n)/(1+n*Math.cos(f)),r=p*Math.cos(f+s),g=p*Math.sin(f+s),m=0,b=Math.cos(o),d=Math.sin(o),T=Math.cos(c),k=Math.sin(c),P=r,y=g*b-m*d,F=g*d+m*b,O=P*T-y*k,V=P*k+y*T,W=F;l.push(new B(O,W,-V))}new ie().setFromPoints(l);let h;switch(e.properties.type){case"icy":h=6724095;break;case"asteroidal":h=9127187;break;case"captured":h=16737894;break;default:h=16755302;break}const S=new J;S.name=`moon-orbit-${e.name}`;for(let u=0;u<l.length;u+=3){const f=[];if(u<l.length&&(f.push(l[u]),u+1<l.length&&f.push(l[u+1])),f.length>=2){const p=new ie().setFromPoints(f),r=new se({color:h,opacity:0,transparent:!0,linewidth:1}),g=new D(p,r);g.name=`moon-orbit-segment-${e.name}-${u}`,S.add(g)}}const w=S;w.visible=!1,w.position.copy(this.planetPosition),this.scene.add(w),this.orbitalLines||(this.orbitalLines=[]),this.orbitalLines.push(w)}drawIceCracks(e,t,i){const a=(i.start.lon+180)/360*t,n=(90-i.start.lat)/180*t,o=(i.end.lon+180)/360*t,s=(90-i.end.lat)/180*t,c=Math.max(8,i.width*t*500);e.shadowColor="rgba(150, 200, 255, 1.0)",e.shadowBlur=20,e.strokeStyle=`rgba(255, 255, 255, ${Math.min(1,i.brightness*3)})`,e.lineWidth=c,e.lineCap="round",e.beginPath(),e.moveTo(a,n),e.lineTo(o,s),e.stroke(),e.shadowColor="rgba(100, 150, 255, 0.8)",e.shadowBlur=30,e.strokeStyle=`rgba(200, 230, 255, ${Math.min(1,i.brightness*2.5)})`,e.lineWidth=c*.7,e.beginPath(),e.moveTo(a,n),e.lineTo(o,s),e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.shadowBlur=0}update(){if(!this.moonData)return;this.detectCameraMovement()&&this.onCameraMovement(),this.updateOrbitalLinesFade();const e=Date.now()/1e3;if(!isFinite(this.cosmicOriginTime))return;const t=e-this.cosmicOriginTime;isFinite(t)&&(t<0||(this.moonData.moons.forEach((i,a)=>{a<this.moonMeshes.length&&(this.updateMoonPosition(this.moonMeshes[a],i,t,a),Math.floor(t)%30===0&&this.updateMoonSurfaceRelaxation(this.moonMeshes[a],i))}),this.updateLOD()))}updateMoonPosition(e,t,i,a=0){if(!isFinite(i))return;const n=t.orbit.orbital_period_seconds;if(!isFinite(n)||n<=0)return;const o=2*Math.PI/n,s=t.orbit.initial_phase||0,c=(o*i+s)%(2*Math.PI);if(!isFinite(c))return;const l=this.calculateOrbitalParameters(t),_=l.semiMajorAxis,h=l.eccentricity,S=l.inclination,w=l.argumentOfPeriapsis,u=l.longitudeOfAscendingNode;let f=c;for(let Y=0;Y<5;Y++){const j=c+h*Math.sin(f);if(!isFinite(j))break;f=j}if(!isFinite(f))return;const p=Math.sqrt(1+h),r=Math.sqrt(1-h),g=Math.sin(f/2),m=Math.cos(f/2);if(!isFinite(p)||!isFinite(r)||!isFinite(g)||!isFinite(m))return;const b=2*Math.atan2(p*g,r*m);if(!isFinite(b))return;const d=_*(1-h*h)/(1+h*Math.cos(b)),T=b+w,k=d*Math.cos(T),P=d*Math.sin(T),y=0;if(!isFinite(k)||!isFinite(P)||!isFinite(y))return;const F=Math.cos(S),O=Math.sin(S);if(!isFinite(F)||!isFinite(O)||!isFinite(u))return;let V=k,W=P*F-y*O,U=P*O+y*F;const N=Math.cos(u),x=Math.sin(u);if(!isFinite(N)||!isFinite(x))return;const L=V*N-W*x,C=V*x+W*N,G=U;if(!isFinite(L)||!isFinite(C)||!isFinite(G)||!isFinite(this.planetPosition.x)||!isFinite(this.planetPosition.y)||!isFinite(this.planetPosition.z))return;const M=L,A=G,v=-C,I=this.planetPosition.x+M,R=this.planetPosition.y+A,z=this.planetPosition.z+v;if(!isFinite(I)||!isFinite(R)||!isFinite(z))return;e.position.set(I,R,z);const E=e.getObjectByName(`moon-surface-${t.name}`);E&&this.applyTidalLockingWithLibration(E,t,b,i)}calculatePeriapsisWithPrecession(e,t){const i=e.orbit.argument_of_periapsis||0;if(!isFinite(t)||!isFinite(i))return i;const a=this.planetRadius,n=e.orbit.semi_major_axis_km;if(!isFinite(n)||n<=0||n/a>10)return i;const s=.001,c=2*Math.PI/e.orbit.orbital_period_seconds,l=e.orbit.inclination_deg*Math.PI/180;if(!isFinite(c)||!isFinite(l))return i;const _=3/2*s*c*Math.pow(a/n,2)*Math.cos(l);if(!isFinite(_))return i;const h=_*t,S=(i+h)%(2*Math.PI);return isFinite(S)?S:i}applyTidalLockingWithLibration(e,t,i,a){if(!isFinite(i))return;if(t.rotation?.is_tidally_locked??!0){e.lookAt(this.planetPosition);const o=t.orbit.eccentricity;if(isFinite(o)&&o>=0&&o<1){const s=2*o*Math.sin(i),l=t.orbit.inclination_deg*Math.PI/180*Math.sin(i)*.1;if(isFinite(s)&&isFinite(l)){const _=s+l;isFinite(_)&&e.rotateY(_)}}}else{const o=t.rotation?.angular_velocity_rad_s??2*Math.PI/t.orbit.orbital_period_seconds;if(isFinite(o)&&o>0){const s=Date.now()/1e3,c=this.moonData?.cosmic_origin_time||0,l=s-c,_=o*l;isFinite(_)&&(e.rotation.y=_%(2*Math.PI))}}}updateLOD(){if(!this.moonData)return;const e=this.camera.position,t=new le,i=new he;i.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),t.setFromProjectionMatrix(i),this.moonMeshes.forEach((a,n)=>{const o=e.distanceTo(a.position),s=this.moonData.moons[n];if(!t.containsPoint(a.position)&&o>this.moonData.render_settings.lod_distances[1]){a.visible=!1;return}const l=this.moonData.render_settings.max_visible_distance*2;if(a.visible=o<l,!a.visible)return;const h=s.properties.radius_km/o;let S=2;o<this.moonData.render_settings.lod_distances[0]||h>.001?S=0:(o<this.moonData.render_settings.lod_distances[1]||h>1e-4)&&(S=1);const w=a.getObjectByName(`moon-surface-${s.name}`);w&&w.geometry instanceof H&&this.applyGeometryLOD(w,S,o);const u=this.moonData.render_settings.max_visible_distance;if(o>u*.5){const f=Math.max(.3,1-(o-u*.5)/(u*.5));a.scale.setScalar(f)}else a.scale.setScalar(1)})}applyGeometryLOD(e,t,i){e.geometry;const a=e.material;i>1e3&&(a.roughness=Math.min(1,a.roughness+.1),a.metalness=Math.max(0,a.metalness-.05))}getMoonAtPosition(e){const t=e.intersectObjects(this.scene.children,!0);for(const i of t)if(i.object.userData?.isMoon)return i.object.userData.moonData;return null}getMoonPosition(e){const t=this.moonMeshes.find(i=>i.name===`moon-${e}`);return t?t.position.clone():null}dispose(){this.fadeOutTimer&&(clearTimeout(this.fadeOutTimer),this.fadeOutTimer=null),this.initialShowTimer&&(clearTimeout(this.initialShowTimer),this.initialShowTimer=null),this.clearMoons(),this.moonMaterials.forEach(e=>e.dispose()),this.moonMaterials.clear()}startInitialShowTimer(){this.orbitalLinesTargetOpacity=0,this.orbitalLinesCurrentOpacity=0,this.lastInteractionTime=Date.now(),this.initialShowTimer=null}detectCameraMovement(){const e=this.camera.position.clone(),t=new B;this.camera.getWorldDirection(t);const i=e.distanceTo(this.lastCameraPosition)>this.cameraMovementThreshold,a=t.distanceTo(this.lastCameraTarget)>this.cameraMovementThreshold;return i||a?(this.lastCameraPosition.copy(e),this.lastCameraTarget.copy(t),!0):!1}isCameraMoving(){return this.detectCameraMovement()}onCameraMovement(){this.lastInteractionTime=Date.now(),this.fadeOutTimer&&(clearTimeout(this.fadeOutTimer),this.fadeOutTimer=null),this.initialShowTimer&&(clearTimeout(this.initialShowTimer),this.initialShowTimer=null),this.fadeInOrbitalLines(),this.fadeOutTimer=window.setTimeout(()=>{this.fadeOutOrbitalLines(),this.fadeOutTimer=null},this.fadeOutDelay)}fadeInOrbitalLines(){this.orbitalLinesFadeEnabled&&(this.orbitalLinesTargetOpacity=.4)}fadeOutOrbitalLines(){this.orbitalLinesFadeEnabled&&(this.orbitalLinesTargetOpacity=0)}updateOrbitalLinesFade(){if(!this.orbitalLinesFadeEnabled)return;const e=this.orbitalLinesTargetOpacity-this.orbitalLinesCurrentOpacity;Math.abs(e)>.001&&(this.orbitalLinesCurrentOpacity+=e*this.fadeSpeed,this.orbitalLines.forEach(t=>{if(t.name&&t.name.startsWith("moon-orbit-")){const i=this.orbitalLinesCurrentOpacity>.05;t.visible=i,i&&t.traverse(a=>{if(a instanceof D&&a.material instanceof se&&a.name&&a.name.startsWith("moon-orbit-segment-")){const n=a.material;n.opacity=this.orbitalLinesCurrentOpacity,n.needsUpdate=!0}})}}))}enableOrbitalLinesFade(e){this.orbitalLinesFadeEnabled=e,e||(this.orbitalLinesTargetOpacity=.4,this.orbitalLinesCurrentOpacity=.4,this.updateOrbitalLinesFade())}isOrbitalLinesFadeEnabled(){return this.orbitalLinesFadeEnabled}}export{pe as M};
