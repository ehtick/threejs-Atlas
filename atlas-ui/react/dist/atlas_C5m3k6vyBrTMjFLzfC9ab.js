import{r as a,j as n,R as Ae}from"./atlas_Bv5zr7cG9joXJ1l7Eo-6s.js";import{W as De}from"./atlas_CCPhKrgd40h-8U080h1w-.js";import{O as Me}from"./atlas_eNp6ISnLi0u4njGno8cRo.js";import{e as j}from"./atlas_BnqcqIM_GRQFgmeSY8G5m.js";import{E,c as Le}from"./atlas_4uRCXczyxd9jtdf01ay4h.js";import{g as ke}from"./atlas_vPv-P3BRdxjV8HUw8-zQ6.js";import{P as Te}from"./atlas_CCgaNvzDedGXVBYdRmqSZ.js";import{v as Ie,w as Fe,C as ue,x as Ne,y as ze,z as Oe,H as Be,I as fe,J as Ge,b as Ue,u as He,M as We,j as $e}from"./atlas_BjkcO1_mNssSqp05cLhjd.js";const Ve=({planetData:u,showInConsole:g=!0,showInPage:L=!1})=>{const[H,W]=a.useState([]),[R,F]=a.useState({});a.useEffect(()=>{if(!u)return;const o=C(u);F(o),W(v(u)),typeof window<"u"&&(window.__DEBUG_PLANET_DATA=u,window.__DEBUG_PLANET_ANALYSIS=o)},[u,g]);function C(o){const c={hasValidStructure:!1,missingFields:[],dataIntegrity:"unknown",renderingIssues:[],colorConsistency:"unknown"};if(o.planet_info&&o.surface_elements?c.hasValidStructure=!0:(o.planet_info||c.missingFields.push("planet_info"),o.surface_elements||c.missingFields.push("surface_elements")),o.surface_elements?.type==="oceanic"&&(c.oceanicData={hasAbstractLands:!!o.surface_elements.abstract_lands?.length,numGreenPatches:o.surface_elements.green_patches?.length||0,numClouds:o.surface_elements.clouds?.length||0,hasDepths:o.surface_elements.depths?.enabled||!1,baseColorIsBlue:o.planet_info?.base_color==="#0000FF",greenPatchColor:o.surface_elements.green_patches?.[0]?.color,issues:[]},c.oceanicData.numGreenPatches>15&&c.oceanicData.issues.push("Muchos parches verdes pueden ocultar el océano azul"),c.oceanicData.baseColorIsBlue||c.oceanicData.issues.push(`Color base no es azul puro: ${o.planet_info?.base_color}`),c.renderingIssues=c.oceanicData.issues),o.planet_info?.base_color&&o.planet_info?.type){const P={Oceanic:"#0000FF",Rocky:"#808080",Icy:"#ADD8E6",Desert:"#FFD700",Lava:"#FF0000"}[o.planet_info.type];P&&o.planet_info.base_color!==P?c.colorConsistency=`Inconsistente: esperado ${P}, recibido ${o.planet_info.base_color}`:c.colorConsistency="Correcto"}return c}function v(o){const c=[];if(!o.surface_elements?.type)return["No surface type defined"];const D=o.surface_elements.type.toLowerCase();switch(D){case"oceanic":c.push("OceanWavesEffect (PROBLEMA: ignora green_patches de Python)");break;case"rocky":c.push("RockyTerrainEffect");break;case"icy":c.push("IcyTerrainEffect");break;case"gas giant":c.push("GasGiantBandsEffect");break;default:c.push(`Generic effect for type: ${D}`)}return o.atmosphere?.density>0&&c.push("AtmosphericEffect"),o.rings&&c.push("RingSystemEffect"),c}return L?n.jsxs("div",{style:{position:"fixed",top:10,right:10,background:"rgba(0, 0, 0, 0.9)",color:"#00ff00",padding:"10px",borderRadius:"5px",fontFamily:"monospace",fontSize:"12px",maxWidth:"400px",maxHeight:"600px",overflow:"auto",zIndex:1e4,border:"1px solid #00ff00"},children:[n.jsxs("h3",{style:{margin:"0 0 10px 0",color:"#00ff00"},children:["🔍 Planet Debug: ",u.planet_info?.name]}),n.jsxs("div",{style:{marginBottom:"10px"},children:[n.jsx("strong",{children:"Type:"})," ",u.planet_info?.type,n.jsx("br",{}),n.jsx("strong",{children:"Base Color:"})," ",u.planet_info?.base_color,n.jsx("br",{}),n.jsx("strong",{children:"Radius:"})," ",u.planet_info?.radius]}),u.surface_elements?.type==="oceanic"&&n.jsxs("div",{style:{marginBottom:"10px",borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[n.jsx("strong",{children:"🌊 Oceanic Data:"}),n.jsx("br",{}),n.jsxs("span",{style:{color:R.oceanicData?.baseColorIsBlue?"#00ff00":"#ff0000"},children:["Base Color: ",R.oceanicData?.baseColorIsBlue?"✓ Blue":"✗ Not Blue"]}),n.jsx("br",{}),"Green Patches: ",R.oceanicData?.numGreenPatches,n.jsx("br",{}),"Clouds: ",R.oceanicData?.numClouds,n.jsx("br",{}),"Has Depths: ",R.oceanicData?.hasDepths?"Yes":"No",n.jsx("br",{}),R.oceanicData?.issues?.length>0&&n.jsxs("div",{style:{color:"#ffaa00",marginTop:"5px"},children:["⚠️ Issues:",n.jsx("br",{}),R.oceanicData.issues.map((o,c)=>n.jsxs("div",{children:["- ",o]},c))]})]}),n.jsxs("div",{style:{borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[n.jsx("strong",{children:"🎨 Effects Applied:"}),n.jsx("br",{}),H.map((o,c)=>n.jsxs("div",{style:{color:o.includes("PROBLEMA")?"#ff0000":"#00ff00"},children:["- ",o]},c))]}),n.jsx("button",{style:{marginTop:"10px",background:"#00ff00",color:"#000",border:"none",padding:"5px 10px",cursor:"pointer",borderRadius:"3px"},children:"Log to Console"})]}):null};function Ye(u){a.useEffect(()=>{if(u&&u.surface_elements?.type==="oceanic"){u.surface_elements.green_patches?.length>0;const g=u.planet_info?.base_color;g!=="#0000FF"&&console.warn("⚠️ Planeta oceánico sin color azul base!",g)}},[u])}const U=2.5,de=()=>{const u=45*Math.PI/180;return U/(Math.tan(u/2)*.5)},Ze=({planetName:u,containerClassName:g="",width:L=800,height:H=600,autoRotate:W=!0,enableControls:R=!0,showDebugInfo:F=!1,planetData:C,cosmicOriginTime:v,initialAngleRotation:o,onDataLoaded:c,onEffectsCreated:D,onError:P})=>{const _=a.useRef(null),d=a.useRef(null),x=a.useRef(null),S=a.useRef(null),p=a.useRef(null),k=a.useRef(null),pe=a.useRef(new Ie),$=a.useRef(null),V=a.useRef(0),y=a.useRef(null),[te,N]=a.useState(!0),[re,M]=a.useState(null),[m,ne]=a.useState(null),[se,Y]=a.useState([]),[z,Z]=a.useState({activeEffects:0,enabledEffects:0,frameRate:0,renderTime:0}),T=a.useRef([]),J=a.useRef(0),O=a.useRef(null),b=a.useRef(null),me=Math.floor(Date.now()/1e3),[he,Xe]=a.useState(0),ge=v||m?.timing?.cosmic_origin_time||Date.now()/1e3-3600,_e=me-ge+he;V.current=_e;const X=a.useCallback(()=>{if(!_.current||!x.current||!S.current)return;const e=_.current,r=e.clientWidth||400,t=e.clientHeight||400;x.current.setSize(r,t),S.current.aspect=r/t,S.current.updateProjectionMatrix()},[]),ae=async e=>{if(!(!p.current||!d.current||!b.current)){E.log("Applying modular effects from API data",{planet:e.planet_info.name,type:e.planet_info.type});try{K();const r=ke(e);b.current.updateBaseColor(r);const t=j.createEffectsFromPythonPlanetData(e,U,p.current,d.current,b.current);console.log(`Planet: ${e.planet_info?.name}, Effects:`,t.map(s=>s.type)),Y(t),T.current=t,D&&D(t),E.log(`Successfully applied ${t.length} modular effects`),Q()}catch(r){E.error("Error applying modular effects",r),B()}}},be=a.useCallback(()=>{if(!_.current)return!1;try{for(;_.current.firstChild;)_.current.removeChild(_.current.firstChild);d.current=null,S.current=null,x.current=null,p.current=null,h.current=null;const e=_.current,r=e.clientWidth||L||400,t=e.clientHeight||H||400,s=new Fe;s.background=new ue(1297),d.current=s;const f=new Ne(45,r/t,.1,1e4),l=de();f.position.set(0,0,l),f.lookAt(0,0,0),S.current=f;const i=new De({antialias:!0,alpha:!0,powerPreference:"high-performance"});return i.setSize(r,t),i.setPixelRatio(Math.min(window.devicePixelRatio,2)),i.shadowMap.enabled=!0,i.shadowMap.type=ze,i.toneMapping=Oe,i.toneMappingExposure=1.2,i.outputColorSpace=Be,_.current.appendChild(i.domElement),x.current=i,we(s,null),Ee(s),R&&Re(f,i.domElement),!0}catch(e){return console.error("Error initializing Three.js:",e),!1}},[m,C,v]),xe=e=>{if(!e)return 0;const r=e.sun_angle||e.lighting?.sun_angle;if(r!==void 0)return r;const t=e.timing?.current_orbital_angle||e.timing?.orbital_angle;return t??0},w=a.useRef(null),q=a.useRef(null),I=a.useRef(null),h=a.useRef(null),ye=e=>{e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.camera.left=-10,e.shadow.camera.right=10,e.shadow.camera.top=10,e.shadow.camera.bottom=-10},ie=e=>{if(!w.current||!d.current)return;const r=xe(e),t=10,s=r+Math.PI,f=Math.sin(r)*5,l=t*Math.cos(s),i=f,A=t*Math.sin(s);w.current.position.set(l,i,A),w.current.target.position.set(0,0,0),d.current.children.includes(w.current.target)||d.current.add(w.current.target),q.current&&q.current.position.set(-l*.5,0,-A*.5),b.current&&w.current&&b.current.updateFromThreeLight(w.current),w.current&&j.updateLightForAllEffects(w.current)},we=(e,r)=>{{const t=new fe(16777215,2);t.position.set(-10,5,10),t.target.position.set(0,0,0),t.castShadow=!0,ye(t),e.add(t),e.add(t.target),w.current=t;const s=new fe(16777215,.05);s.position.set(8,-3,-5),e.add(s),q.current=s;const f=new Ge(2236996,.1);e.add(f),setTimeout(()=>{b.current&&t&&b.current.updateFromThreeLight(t),t&&j.updateLightForAllEffects(t)},50);return}},Ee=e=>{const r=new Ue(U,128,64),t=new He({color:8421504}),s=new We(r,t);s.castShadow=!0,s.receiveShadow=!0,s.position.set(0,0,0),e.add(s),p.current=s;const f=new ue(8421504);b.current=new Te(s,f),b.current.addToScene(e)},Re=(e,r)=>{const t=new Me(e,r);t.enableDamping=!0,t.dampingFactor=.05;const s=de();t.minDistance=s*.5,t.maxDistance=s*2,t.autoRotate=W,t.autoRotateSpeed=.5,t.enablePan=!0,t.enableZoom=!0,t.target.set(0,0,0),k.current=t},Pe=a.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{N(!0),M(null),E.log("Loading planet data from API",{planetName:u});const r=await fetch("/api/planet/rendering-data");if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const t=await r.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const s=t.planet_data,f=t.timing,l=t.rendering_data,i={planet_info:l?.planet_info||{name:s.name,type:s.planet_type,base_color:"#808080",radius:s.diameter/15e3,orbital_radius:s.orbital_radius},surface_elements:l?.surface_elements,atmosphere:l?.atmosphere,rings:l?.rings,effects_3d:l?.effects_3d,shader_uniforms:l?.shader_uniforms,universal_actions:l?.universal_actions,timing:{cosmic_origin_time:f.cosmic_origin_time,current_time_seconds:f.current_time_seconds,elapsed_time:f.elapsed_time,initial_orbital_angle:s.initial_orbital_angle,current_orbital_angle:s.current_orbital_angle,max_orbital_radius:f.max_orbital_radius,system_max_orbital_radius:s.system_max_orbital_radius},original_planet_data:s,seeds:l?.seeds};return ne(i),y.current=i,E.log("API data loaded successfully",{planet:i.planet_info.name,type:i.planet_info.type,hasEffects:!!i.surface_elements,fullRenderingData:l}),c&&c(i),i}catch(e){const r=e instanceof Error?e.message:"Unknown error";return M(r),P&&P(r),null}finally{N(!1),window.isLoadingPlanetData=!1}}},[u,c,P]);a.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{N(!0),M(null),E.log("Loading planet data from API",{planetName:u});const r=await fetch("/api/planet/rendering-data");if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const t=await r.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const s=t.planet_data,f=t.timing,l=t.rendering_data,i={planet_info:l?.planet_info||{name:s.name,type:s.planet_type,base_color:"#808080",radius:s.diameter/15e3,orbital_radius:s.orbital_radius},surface_elements:l?.surface_elements,atmosphere:l?.atmosphere,rings:l?.rings,effects_3d:l?.effects_3d,shader_uniforms:l?.shader_uniforms,universal_actions:l?.universal_actions,timing:{cosmic_origin_time:f.cosmic_origin_time,current_time_seconds:f.current_time_seconds,elapsed_time:f.elapsed_time,initial_orbital_angle:s.initial_orbital_angle,current_orbital_angle:s.current_orbital_angle,max_orbital_radius:f.max_orbital_radius,system_max_orbital_radius:s.system_max_orbital_radius},original_planet_data:s,seeds:l?.seeds};ne(i),y.current=i,E.log("API data loaded successfully",{planet:i.planet_info.name,type:i.planet_info.type,hasEffects:!!i.surface_elements,fullRenderingData:l}),ie(i),h.current&&d.current&&(d.current.remove(h.current),h.current.geometry.dispose(),h.current.material.dispose(),h.current=null),await ae(i),c&&c(i)}catch(e){const r=e instanceof Error?e.message:"Unknown error";M(r),P&&P(r),B()}finally{N(!1),window.isLoadingPlanetData=!1}}},[u,C,v,o]);const oe=a.useCallback(()=>{if(!m||!p.current)return;const e=C?.orbital_period_seconds||365.25*24*3600,r=2*Math.PI/e,t=m.timing?.initial_orbital_angle||0,s=Date.now()/1e3,f=0,l=v||m.timing?.cosmic_origin_time||Date.now()/1e3-3600,i=s-l+f,A=(t+i*r)%(2*Math.PI),ee=m.timing?.max_orbital_radius||100,G=20+m.planet_info?.orbital_radius/ee*80,je=G,Ce=G*Math.cos(A),Se=je*Math.sin(A);p.current.position.x=Ce,p.current.position.z=Se,p.current.position.y=0},[m,C,v]),ve=a.useCallback(async e=>{const r=e||m;if(r&&d.current)try{ie(r),h.current&&d.current&&(d.current.remove(h.current),h.current.geometry.dispose(),h.current.material.dispose(),h.current=null),await ae(r)}catch(t){E.error("Error in applyProceduralShadersFromAPI:",t),B()}},[m]),B=()=>{if(!(!d.current||!p.current)){E.warn("Applying fallback effects for planet type:",C?.planet_type);try{K(),p.current.material instanceof $e&&p.current.material.color.setHex(6710886);try{const e=Le("generic"),r=j.createEffectsFromList(e,U,p.current);r.forEach(t=>{t.effect.addToScene&&d.current&&p.current&&t.effect.addToScene(d.current,p.current.position)}),T.current=r,Y(r)}catch(e){console.warn("Could not create fallback effects, using basic material only:",e)}Q()}catch(e){E.error("Error applying fallback effects",e)}}},K=()=>{j.clearAllEffects(),T.current.forEach(e=>{try{e.effect.dispose&&e.effect.dispose()}catch{}}),T.current=[],Y([])},ce=a.useCallback(()=>{$.current=requestAnimationFrame(ce);const e=performance.now(),r=pe.current.getDelta();k.current&&k.current.update();try{j.updateAllEffects(r,p.current?.rotation.y)}catch{}if(p.current&&y.current){y.current.planet_info?.name;const t=y.current.original_planet_data,s=t?.orbital_period_seconds||365.25*24*3600,f=y.current.timing?.initial_orbital_angle||0;v||y.current.timing?.cosmic_origin_time||Date.now()/1e3-3600;const l=t?.axial_tilt||0,i=2*Math.PI/s;(f+V.current*i)%(2*Math.PI);const A=y.current.timing?.max_orbital_radius||y.current.timing?.system_max_orbital_radius,ee=t?.orbital_radius;if(!A||!ee)return;t?.eccentricity_factor,p.current.position.set(0,0,0);const le=t?.rotation_period_seconds||86400,G=2*Math.PI/le;p.current.rotation.y=V.current*G%(2*Math.PI),p.current.rotation.z=l*(Math.PI/180)}if(T.current.forEach(t=>{t.effect.updateUniforms&&t.effect.updateUniforms(r)}),x.current&&d.current&&S.current){const t=performance.now();x.current.render(d.current,S.current);const s=performance.now()-t;if(e-J.current>5e3){const f=1e3/(e-J.current);Q(),Z(l=>({...l,frameRate:Math.round(f),renderTime:Math.round(s*100)/100})),J.current=e}}},[]),Q=a.useCallback(()=>{const e=j.getStats();Z(r=>({...r,activeEffects:e.activeEffects,enabledEffects:e.enabledEffects}))},[]);return a.useEffect(()=>{let e=!0;return window.tonnirLoggedInPlanet=!1,window.orbitChecked=!1,window.debugOrbitRadius=null,window.debugSystemMaxRadius=null,window.planetNameLogged=!1,window.timingDataLogged=!1,window.isLoadingPlanetData=!1,window.orbitalAngleSourceLogged=!1,window.orbitalAngleDebugged=!1,window.positionDebugged=!1,window.animationLoopDebugged=!1,(async()=>{try{if(!e)return;const t=await Pe();if(!e)return;if(!be()){e&&M("Failed to initialize 3D renderer");return}if(!e||(ce(),_.current&&"ResizeObserver"in window&&(O.current=new ResizeObserver(X),O.current.observe(_.current)),window.addEventListener("resize",X),!e))return;t?await ve(t):B()}catch(t){e&&M(t instanceof Error?t.message:"Unknown initialization error")}})(),()=>{if(e=!1,y.current=null,$.current&&cancelAnimationFrame($.current),O.current&&O.current.disconnect(),window.removeEventListener("resize",X),K(),b.current&&(b.current.dispose(),b.current=null),k.current&&k.current.dispose(),I.current&&d.current&&(d.current.remove(I.current),I.current.geometry.dispose(),I.current.material.dispose(),I.current=null),h.current&&d.current&&(d.current.remove(h.current),h.current.geometry.dispose(),h.current.material.dispose(),h.current=null),x.current&&_.current)try{_.current.contains(x.current.domElement)&&_.current.removeChild(x.current.domElement),x.current.dispose()}catch{}}},[]),a.useEffect(()=>{const e=setInterval(()=>{const r=j.getStats();Z(t=>({...t,activeEffects:r.activeEffects,enabledEffects:r.enabledEffects}))},1e4);return()=>clearInterval(e)},[]),a.useEffect(()=>{m&&d.current&&p.current&&oe()},[m,oe]),Ye(m),n.jsxs("div",{className:`relative ${g}`,children:[F&&m&&n.jsx(Ve,{planetData:m,showInPage:!0,showInConsole:!0}),n.jsx("div",{ref:_,className:"w-full h-full",style:{minHeight:"300px",aspectRatio:"1"}}),te&&n.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-50",children:n.jsxs("div",{className:"text-white text-center",children:[n.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"}),n.jsx("div",{children:"Loading planet..."})]})}),re&&n.jsxs("div",{className:"absolute top-0 left-0 right-0 p-2 bg-red-500 text-white text-sm",children:[n.jsx("strong",{children:"Error:"})," ",re]}),m&&!te&&n.jsxs("div",{className:"absolute bottom-0 left-0 p-4 text-white bg-black bg-opacity-50 max-w-xs",children:[n.jsx("h3",{className:"text-lg font-bold",children:m.planet_info.name}),n.jsx("p",{className:"text-sm opacity-80",children:m.planet_info.type}),n.jsxs("p",{className:"text-xs mt-1 opacity-60",children:[se.length," effects active"]}),m.surface_elements?.description&&n.jsx("p",{className:"text-xs mt-2 opacity-60",children:m.surface_elements.description.appearance})]}),F&&n.jsxs("div",{className:"absolute top-0 right-0 p-4 text-white bg-black bg-opacity-70 text-xs font-mono",children:[n.jsx("h4",{className:"font-bold mb-2",children:"Debug Info"}),n.jsxs("div",{children:["Frame Rate: ",z.frameRate," FPS"]}),n.jsxs("div",{children:["Render Time: ",z.renderTime,"ms"]}),n.jsxs("div",{children:["Active Effects: ",z.activeEffects]}),n.jsxs("div",{children:["Enabled Effects: ",z.enabledEffects]}),n.jsxs("div",{className:"mt-2",children:[n.jsx("div",{className:"font-semibold",children:"Effects:"}),se.map(e=>n.jsxs("div",{className:"ml-2",children:[e.type," (",e.enabled?"ON":"OFF",")"]},e.id))]})]})]})};class Je extends Ae.Component{constructor(g){super(g),this.state={hasError:!1,error:null}}static getDerivedStateFromError(g){return console.error("🚨 ErrorBoundary caught error:",g),console.error("🚨 Error stack:",g.stack),{hasError:!0,error:g.message}}componentDidCatch(g,L){console.error("🚨 componentDidCatch:",g,L)}render(){return this.state.hasError?n.jsx("div",{className:"flex items-center justify-center w-full h-full bg-gray-900/50 rounded",children:n.jsxs("div",{className:"text-center p-4",children:[n.jsx("div",{className:"text-red-400 text-sm mb-2",children:"3D Renderer Error"}),n.jsx("div",{className:"text-xs text-gray-400",children:this.state.error})]})}):this.props.children}}const at=u=>n.jsx(Je,{children:n.jsx(Ze,{...u})});export{at as M};
