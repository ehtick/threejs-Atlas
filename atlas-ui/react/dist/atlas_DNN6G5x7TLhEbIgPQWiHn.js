import{c as D}from"./atlas_DTMHG0KBmlmtp0V4aoQDq.js";import{V as $,a7 as ae,m as W,f as X,o as J,i as ne,M as H,G as Q,b as Z,C as q,F as oe,p as re,y as K,D as ee,w as ce,c as le,u as he,v as te,I as de,B as ie,a3 as se,ae as me,e as ue}from"./atlas_Bd-08EnGHvuA4jxvJ1T-8.js";class Me{scene;planetRadius;moonMeshes=[];orbitalLines=[];smallMoonIndicators=[];moonData=null;cosmicOriginTime;lastRelaxationSummary=0;moonMaterials=new Map;camera;planetPosition;timeOffset=0;orbitalLinesFadeEnabled=!0;orbitalLinesVisible=!0;orbitalLinesTargetOpacity=1;orbitalLinesCurrentOpacity=1;lastCameraPosition=new $;lastCameraTarget=new $;lastInteractionTime=0;fadeOutTimer=null;initialShowTimer=null;cameraMovementThreshold=.01;fadeOutDelay=3e3;initialShowDuration=5e3;fadeSpeed=.05;constructor(e,t,i,r,a){if(this.scene=e,this.planetRadius=t,this.camera=i,this.planetPosition=r,this.cosmicOriginTime=a,this.lastCameraPosition.copy(this.camera.position),this.camera instanceof ae){const n=new $;this.camera.getWorldDirection(n),this.lastCameraTarget.copy(n)}this.startInitialShowTimer(),this.initializeMaterials()}initializeMaterials(){this.moonMaterials.set("rocky",new W({color:9143936,roughness:.9,metalness:.1,normalScale:new X(.8,.8)})),this.moonMaterials.set("icy",new W({color:14737648,roughness:.3,metalness:.05,normalScale:new X(.4,.4)})),this.moonMaterials.set("asteroidal",new W({color:4865578,roughness:.95,metalness:.15,normalScale:new X(1.2,1.2)})),this.moonMaterials.set("captured",new W({color:7035722,roughness:.8,metalness:.08,normalScale:new X(.9,.9)}))}loadMoonSystem(e){this.moonData=e,e.cosmic_origin_time&&(this.cosmicOriginTime=e.cosmic_origin_time),this.clearMoons(),this.createMoons()}clearMoons(){this.orbitalLines.forEach(e=>{this.scene.remove(e),e.traverse(t=>{t instanceof J&&(t.geometry.dispose(),t.material instanceof ne&&t.material.dispose())})}),this.orbitalLines=[],this.moonMeshes.forEach(e=>{this.scene.remove(e),e.traverse(t=>{t instanceof H&&(t.geometry.dispose(),Array.isArray(t.material)?t.material.forEach(i=>i.dispose()):t.material.dispose())})}),this.moonMeshes=[]}createMoons(){this.moonData&&this.moonData.moons.forEach((e,t)=>{const i=this.createMoonMesh(e,t);this.moonMeshes.push(i),this.scene.add(i)})}createMoonMesh(e,t){const i=new Q;i.name=`moon-${e.name}`;const r=e.visuals.relative_size,a=this.planetRadius*r,n=64,s=Math.max(1,Math.min(2,1.5/Math.max(r,.01))),c=Math.floor(n*s),d=Math.floor(c*.75),l=(e.procedural?.seed||0)*.618034%(Math.PI*2),S=new Z(a,c,d,l);this.generateProceduralSurface(S,e,a);let o;switch(e.properties.type){case"icy":o=new W({color:16777215,roughness:.2,metalness:.05,transparent:!1});break;case"asteroidal":o=new W({color:16777215,roughness:.95,metalness:.15,transparent:!1});break;case"captured":o=new W({color:16777215,roughness:.8,metalness:.08,transparent:!1});break;default:o=new W({color:16777215,roughness:.8,metalness:.1,transparent:!1});break}switch(this.applyMoonTexture(o,e),e.properties.type){case"icy":const T=e.procedural?.seed||0,F=this.createSeededRandom(T+9999)();let f=1;F>.8?f=1.4:F>.6?f=1.2:F<.2?f=.6:F<.4&&(f=.8),o.emissive=new q(4877194).multiplyScalar(.05*f),o.emissiveIntensity=.6*f,o.envMapIntensity=1*f,o.roughness=Math.max(.05,.15/f),o.metalness=.02,o.transparent=!0,o.opacity=Math.min(1,.95+(f-1)*.1);break;case"asteroidal":o.emissive=new q(2759178).multiplyScalar(.03),o.emissiveIntensity=.3,o.envMapIntensity=.1,o.roughness=.98,o.metalness=.18;break;case"captured":o.emissive=new q(5917242).multiplyScalar(.04),o.emissiveIntensity=.4,o.envMapIntensity=.3,o.roughness=.75,o.metalness=.12;break;default:o.emissive=new q(9136404).multiplyScalar(.04),o.emissiveIntensity=.4,o.envMapIntensity=.4,o.roughness=.85,o.metalness=.08;break}o.transparent=!1,o.side=oe,o.aoMapIntensity=.8,o.normalScale=new X(1,1);const h=new H(S,o);h.name=`moon-surface-${e.name}`,h.castShadow=!0,h.receiveShadow=!0,h.userData={moonData:e,moonIndex:t,isMoon:!0},i.add(h),this.createOrbitalTrail(e,t);const m=Math.max(a*2,this.planetRadius*.04),p=new re(m,32),P=new K({side:ee,depthTest:!1,depthWrite:!1,colorWrite:!1}),g=new H(p,P);g.name=`moon-indicator-hitarea-${e.name}`,g.renderOrder=998,g.userData={isMoonIndicator:!0,moonData:e},i.add(g);const u=new ce(m*.85,m,48),w=new K({color:65348,transparent:!0,opacity:0,side:ee,depthTest:!1}),M=new H(u,w);if(M.name=`moon-indicator-${e.name}`,M.renderOrder=999,M.userData={isMoonIndicator:!0,moonData:e},i.add(M),this.smallMoonIndicators.push(M),this.smallMoonIndicators.push(g),e.visuals.has_atmosphere&&e.visuals.atmosphere_color){const T=new Z(a*1.05,16,8),F=new K({color:e.visuals.atmosphere_color,transparent:!0,opacity:e.visuals.atmosphere_opacity||.1,side:le}),f=new H(T,F);f.name=`moon-atmosphere-${e.name}`,i.add(f)}return this.updateMoonPosition(i,e,0,t),i}generateProceduralSurface(e,t,i){const r=t.procedural?.seed||0,a=D(this.createSeededRandom(r)),n=e.attributes.position.array,s=1.5/Math.max(i,.1),c=this.calculateHydrostaticRelaxation(t),_=.7+(r*13+4567)%1e3/1e3*.6;let l;switch(t.properties.type){case"icy":l=i*.15;break;case"asteroidal":l=i*.18;break;case"captured":l=i*.12;break;default:l=i*.09;break}const o=l*(1-c)*_;for(let h=0;h<n.length;h+=3){const m=n[h],p=n[h+1],P=n[h+2],g=m*s,u=p*s,w=P*s;let M=0;switch(t.properties.type){case"icy":M+=a(g*2,u*2,w*2)*.8,M+=a(g*6,u*6,w*6)*.4,M+=a(g*15,u*15,w*15)*.2;break;case"asteroidal":M+=a(g*.8,u*.8,w*.8)*1.5,M+=a(g*3,u*3,w*3)*1,M+=a(g*8,u*8,w*8)*.7,M+=a(g*20,u*20,w*20)*.4,M+=a(g*50,u*50,w*50)*.2;break;case"captured":M+=a(g*1.2,u*1.2,w*1.2)*1.2,M+=a(g*4,u*4,w*4)*.8,M+=a(g*10,u*10,w*10)*.5,M+=a(g*30,u*30,w*30)*.25;break;default:M+=a(g*1.5,u*1.5,w*1.5)*1,M+=a(g*5,u*5,w*5)*.6,M+=a(g*12,u*12,w*12)*.3,M+=a(g*25,u*25,w*25)*.15;break}const T=new $(m,p,P),F=T.clone().normalize(),f=T.add(F.multiplyScalar(M*o));n[h]=f.x,n[h+1]=f.y,n[h+2]=f.z}e.attributes.position.needsUpdate=!0,e.computeVertexNormals()}applyMoonTexture(e,t){this.createProceduralColorTexture(e,t)}createProceduralColorTexture(e,t){const r=document.createElement("canvas");r.width=256,r.height=256;const a=r.getContext("2d"),n=t.visuals.base_color;let s;if(n&&n.startsWith("#")){const y=n.slice(1);s={r:parseInt(y.slice(0,2),16),g:parseInt(y.slice(2,4),16),b:parseInt(y.slice(4,6),16)}}else switch(t.properties.type){case"icy":s={r:160,g:170,b:190};break;case"asteroidal":s={r:74,g:62,b:42};break;case"captured":s={r:107,g:91,b:74};break;default:s={r:139,g:134,b:128};break}const c=t.procedural?.seed||Math.abs(t.name.split("").reduce((y,O)=>y+O.charCodeAt(0),0)),d=Math.abs(c)%1e6,_=d===0?12345:d,l=D(this.createSeededRandom(_+777));let S=0,o=0,h=0;const m=_%100*.1,p=_/100%100*.1,P=_/1e4%100*.1;switch(t.properties.type){case"icy":S=l(m+1,p+2,P+3)*120,o=l(m+4,p+5,P+6)*100,h=l(m+7,p+8,P+9)*110;const y=l(m*.5,p*.5,P*.5),O=l(m*.3,p*.7,P*.4),v=l(m*.8,p*.2,P*.6);let j=1;v>.4?j=1.4:v>.1?j=1.2:v<-.4?j=.6:v<-.1&&(j=.8),y>.3?(S-=40,o+=50,h+=60):y<-.3?(S+=60,o-=20,h+=20):O>.4?(S+=40,o+=35,h-=30,j*=.9):O<-.4&&(S-=30,o-=20,h+=50),S*=j,o*=j,h*=j;break;case"asteroidal":S=l(m+10,p+11,P+12)*60,o=l(m+13,p+14,P+15)*55,h=l(m+16,p+17,P+18)*50;break;case"captured":S=l(m+19,p+20,P+21)*50,o=l(m+22,p+23,P+24)*45,h=l(m+25,p+26,P+27)*40;break;default:S=l(m+28,p+29,P+30)*55,o=l(m+31,p+32,P+33)*50,h=l(m+34,p+35,P+36)*45;break}({...s},s={r:Math.max(20,Math.min(255,s.r+S)),g:Math.max(20,Math.min(255,s.g+o)),b:Math.max(30,Math.min(255,s.b+h))}),a.fillStyle=`rgb(${s.r}, ${s.g}, ${s.b})`,a.fillRect(0,0,256,256);const g=(_*7919+41)%233280,u=D(this.createSeededRandom(g)),w=a.getImageData(0,0,256,256),M=w.data;for(let y=0;y<256;y++)for(let O=0;O<256;O++){const v=(y*256+O)*4,j=O/256,B=y/256,U=(j-.5)*2*Math.PI,N=(B-.5)*Math.PI,x=Math.cos(N)*Math.cos(U),L=Math.cos(N)*Math.sin(U),I=Math.sin(N),G=(g*17+8901)%1e3,b=.5+G/1e3*1,E=.8+G/1e3*.4;let k=0;switch(t.properties.type){case"icy":k+=u(x*(2*b),L*(2*b),I*(2*b))*(.5*E),k+=u(x*(6*b),L*(6*b),I*(6*b))*(.3*E),k+=u(x*(15*b),L*(15*b),I*(15*b))*(.2*E);const z=u(x*30,L*30,I*30)*.1;k+=z*E;break;case"asteroidal":k+=u(x*(1.2*b),L*(1.2*b),I*(1.2*b))*(.75*E),k+=u(x*(4*b),L*(4*b),I*(4*b))*(.55*E),k+=u(x*(10*b),L*(10*b),I*(10*b))*(.35*E),k+=u(x*(25*b),L*(25*b),I*(25*b))*(.22*E);break;case"captured":k+=u(x*(1.8*b),L*(1.8*b),I*(1.8*b))*(.6*E),k+=u(x*(5*b),L*(5*b),I*(5*b))*(.38*E),k+=u(x*(12*b),L*(12*b),I*(12*b))*(.2*E);break;default:k+=u(x*(2*b),L*(2*b),I*(2*b))*(.55*E),k+=u(x*(6*b),L*(6*b),I*(6*b))*(.33*E),k+=u(x*(16*b),L*(16*b),I*(16*b))*(.18*E);break}let C,R,A;if(t.properties.type==="icy"){if(C=s.r,R=s.g,A=s.b,k>0){const V=k*.5;C=C*(1-V*.15),R=R*(1+V*.2),A=A*(1+V*.25)}else{const V=Math.abs(k)*.5;C=C*(1+V*.1),R=R*(1-V*.15),A=A*(1+V*.05)}const z=1+k*.3;C=C*z,R=R*z,A=A*z;const Y=u(x*8,L*8,I*8);Y>.5?(C=Math.min(255,C*1.05),R=Math.min(255,R*1.08),A=Math.min(255,A*1.1)):Y<-.5&&(C=C*.95,R=R*.97,A=A*1.02),C=Math.max(0,Math.min(255,C)),R=Math.max(0,Math.min(255,R)),A=Math.max(0,Math.min(255,A))}else{const z=1+k;C=Math.max(0,Math.min(255,s.r*z)),R=Math.max(0,Math.min(255,s.g*z)),A=Math.max(0,Math.min(255,s.b*z))}M[v]=C,M[v+1]=R,M[v+2]=A,M[v+3]=255}a.putImageData(w,0,0);const T=new he(r);T.wrapS=te,T.wrapT=te,T.generateMipmaps=!0,T.needsUpdate=!0;const f=(t.procedural?.seed||0)*.618034%1;T.offset.x=f,T.repeat.set(1,1),e.map=T,e.needsUpdate=!0}drawCrater(e,t,i){const r=(i.position.lon+180)/360*t,a=(90-i.position.lat)/180*t,n=Math.max(20,i.radius*t*.8),s=e.createRadialGradient(r,a,0,r,a,n);s.addColorStop(0,"rgba(0, 0, 0, 0.95)"),s.addColorStop(.2,"rgba(10, 10, 10, 0.8)"),s.addColorStop(.5,"rgba(40, 40, 40, 0.6)"),s.addColorStop(.8,"rgba(100, 100, 100, 0.4)"),s.addColorStop(.95,"rgba(180, 180, 180, 0.3)"),s.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=s,e.beginPath(),e.arc(r,a,n,0,2*Math.PI),e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.7)",e.lineWidth=3,e.beginPath(),e.arc(r,a,n*.9,0,2*Math.PI),e.stroke(),e.strokeStyle="rgba(220, 220, 220, 0.5)",e.lineWidth=1,e.beginPath(),e.arc(r,a,n*.95,0,2*Math.PI),e.stroke()}createSeededRandom(e){let t=e*9301+49297;return()=>(t=(t*9301+49297)%233280,t/233280)}calculateHydrostaticRelaxation(e){const t=e.properties.radius_km*1e3,i=e.properties.mass_kg,r=e.properties.density_kg_m3;if(!isFinite(t)||!isFinite(i)||!isFinite(r)||t<=0||i<=0||r<=0)return 0;const n=66743e-15*i/(t*t);if(!isFinite(n)||n<=0)return 0;let s;switch(e.properties.type){case"icy":const h=e.tidal_heating?.tidal_power_watts||0,m=4*Math.PI*t*t,p=h/m;p>1e3?s=1e12:p>100?s=1e15:p>10?s=1e18:p>1?s=1e20:s=1e21;break;case"asteroidal":s=1e26;break;case"captured":s=1e24;break;default:t>5e5?s=1e22:t>1e5?s=1e23:s=1e25;break}let c;e.properties.type==="icy"?(e.tidal_heating?.tidal_power_watts||0)>1e12?c=1e9:c=35e8:c=3e10;const d=s/c;if(!isFinite(d)||d<=0)return 0;const l=Date.now()/1e3-this.cosmicOriginTime;if(!isFinite(l)||l<0)return 0;const S=l/d,o=1-Math.exp(-S);return e.tidal_heating?.tidal_power_watts,this.lastRelaxationSummary||(this.lastRelaxationSummary=0),this.lastRelaxationSummary<Date.now()-5e3&&(this.lastRelaxationSummary=Date.now()),Math.max(0,Math.min(1,o))}updateMoonSurfaceRelaxation(e,t){const i=e.getObjectByName(`moon-surface-${t.name}`);if(!i||!(i.geometry instanceof Z))return;const r=this.calculateHydrostaticRelaxation(t),a=t.procedural?.seed||0,n=i.geometry,s=n.parameters.radius,c=D(this.createSeededRandom(a)),d=n.attributes.position.array,_=.5,S=.7+(a*13+4567)%1e3/1e3*.6;let o;switch(t.properties.type){case"icy":o=s*.15;break;case"asteroidal":o=s*.18;break;case"captured":o=s*.12;break;default:o=s*.09;break}const m=o*(1-r)*S;for(let p=0;p<d.length;p+=3){const P=d[p],g=d[p+1],u=d[p+2],w=new $(P,g,u),M=w.length(),T=w.clone().normalize(),F=P/M*_,f=g/M*_,y=u/M*_;let O=0;switch(t.properties.type){case"icy":O+=c(F*2,f*2,y*2)*.8,O+=c(F*6,f*6,y*6)*.4,O+=c(F*15,f*15,y*15)*.2;break;case"asteroidal":O+=c(F*.8,f*.8,y*.8)*1.5,O+=c(F*3,f*3,y*3)*1,O+=c(F*8,f*8,y*8)*.7,O+=c(F*20,f*20,y*20)*.4,O+=c(F*50,f*50,y*50)*.2;break;case"captured":O+=c(F*1.2,f*1.2,y*1.2)*1.2,O+=c(F*4,f*4,y*4)*.8,O+=c(F*10,f*10,y*10)*.5,O+=c(F*30,f*30,y*30)*.25;break;default:O+=c(F*1.5,f*1.5,y*1.5)*1,O+=c(F*5,f*5,y*5)*.6,O+=c(F*12,f*12,y*12)*.3,O+=c(F*25,f*25,y*25)*.15;break}const v=T.clone().multiplyScalar(s+O*m);d[p]=v.x,d[p+1]=v.y,d[p+2]=v.z}n.attributes.position.needsUpdate=!0,n.computeVertexNormals()}drawMaria(e,t,i,r=0){const a=(i.position.lon+180)/360*t,n=(90-i.position.lat)/180*t,s=Math.max(15,i.radius*t*.4),c=e.createRadialGradient(a,n,0,a,n,s);c.addColorStop(0,`rgba(10, 10, 10, ${i.darkness*.9})`),c.addColorStop(.6,`rgba(25, 25, 25, ${i.darkness*.7})`),c.addColorStop(1,`rgba(40, 40, 40, ${i.darkness*.3})`),e.fillStyle=c,e.beginPath(),e.arc(a,n,s,0,2*Math.PI),e.fill();const d=this.createSeededRandom(r+Math.floor(a+n));e.fillStyle=`rgba(60, 50, 40, ${i.darkness*.2})`;for(let _=0;_<5;_++){const l=a+(d()-.5)*s*.8,S=n+(d()-.5)*s*.8;e.beginPath(),e.arc(l,S,2+d()*3,0,2*Math.PI),e.fill()}}calculateOrbitalParameters(e){const t=Math.max(...this.moonData.moons.map(T=>T.orbit.semi_major_axis_km)),i=e.orbit.semi_major_axis_km/t,r=Math.log10(1+i*9),n=e.properties.origin==="co-formation"&&e.properties.density_kg_m3<1500?2.5:1.8,c=this.planetRadius*n*1.2,d=this.planetRadius*4,_=c+r*d,l=this.planetRadius*10,S=Math.min(_,l),o=e.orbit.eccentricity,m=Math.min(3,1/.5),p=Math.min(.8,o*m),g=Math.min(e.orbit.inclination_deg*3,60),u=de.degToRad(g),w=e.orbit.argument_of_periapsis||0,M=e.orbit.longitude_of_ascending_node||0;return{semiMajorAxis:S,eccentricity:p,inclination:u,argumentOfPeriapsis:w,longitudeOfAscendingNode:M}}createOrbitalTrail(e,t){const i=this.calculateOrbitalParameters(e),r=i.semiMajorAxis,a=i.eccentricity,n=i.inclination,s=i.argumentOfPeriapsis,c=i.longitudeOfAscendingNode,d=[],_=128;for(let h=0;h<=_;h++){const m=h/_*Math.PI*2,p=r*(1-a*a)/(1+a*Math.cos(m)),P=p*Math.cos(m+s),g=p*Math.sin(m+s),u=0,w=Math.cos(n),M=Math.sin(n),T=Math.cos(c),F=Math.sin(c),f=P,y=g*w-u*M,O=g*M+u*w,v=f*T-y*F,j=f*F+y*T,B=O;d.push(new $(v,B,-j))}new ie().setFromPoints(d);let l;switch(e.properties.type){case"icy":l=6724095;break;case"asteroidal":l=9127187;break;case"captured":l=16737894;break;default:l=16755302;break}const S=new Q;S.name=`moon-orbit-${e.name}`;for(let h=0;h<d.length;h+=3){const m=[];if(h<d.length&&(m.push(d[h]),h+1<d.length&&m.push(d[h+1])),m.length>=2){const p=new ie().setFromPoints(m),P=new se({color:l,opacity:0,transparent:!0,linewidth:1}),g=new J(p,P);g.name=`moon-orbit-segment-${e.name}-${h}`,S.add(g)}}const o=S;o.visible=!1,o.position.copy(this.planetPosition),this.scene.add(o),this.orbitalLines||(this.orbitalLines=[]),this.orbitalLines.push(o)}drawIceCracks(e,t,i){const r=(i.start.lon+180)/360*t,a=(90-i.start.lat)/180*t,n=(i.end.lon+180)/360*t,s=(90-i.end.lat)/180*t,c=Math.max(8,i.width*t*500);e.shadowColor="rgba(150, 200, 255, 1.0)",e.shadowBlur=20,e.strokeStyle=`rgba(255, 255, 255, ${Math.min(1,i.brightness*3)})`,e.lineWidth=c,e.lineCap="round",e.beginPath(),e.moveTo(r,a),e.lineTo(n,s),e.stroke(),e.shadowColor="rgba(100, 150, 255, 0.8)",e.shadowBlur=30,e.strokeStyle=`rgba(200, 230, 255, ${Math.min(1,i.brightness*2.5)})`,e.lineWidth=c*.7,e.beginPath(),e.moveTo(r,a),e.lineTo(n,s),e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.shadowBlur=0}setTimeOffset(e){this.timeOffset=e}getTimeOffset(){return this.timeOffset}update(){if(!this.moonData)return;this.detectCameraMovement()&&this.onCameraMovement(),this.updateOrbitalLinesFade();const e=Date.now()/1e3;if(!isFinite(this.cosmicOriginTime))return;const t=e-this.cosmicOriginTime+this.timeOffset;isFinite(t)&&(t<0||(this.moonData.moons.forEach((i,r)=>{r<this.moonMeshes.length&&(this.updateMoonPosition(this.moonMeshes[r],i,t,r),Math.floor(t)%30===0&&this.updateMoonSurfaceRelaxation(this.moonMeshes[r],i))}),this.updateLOD()))}updateMoonPosition(e,t,i,r=0){if(!isFinite(i))return;const a=t.orbit.orbital_period_seconds;if(!isFinite(a)||a<=0)return;const n=2*Math.PI/a,s=t.orbit.initial_phase||0,c=(n*i+s)%(2*Math.PI);if(!isFinite(c))return;const d=this.calculateOrbitalParameters(t),_=d.semiMajorAxis,l=d.eccentricity,S=d.inclination,o=d.argumentOfPeriapsis,h=d.longitudeOfAscendingNode;let m=c;for(let Y=0;Y<5;Y++){const V=c+l*Math.sin(m);if(!isFinite(V))break;m=V}if(!isFinite(m))return;const p=Math.sqrt(1+l),P=Math.sqrt(1-l),g=Math.sin(m/2),u=Math.cos(m/2);if(!isFinite(p)||!isFinite(P)||!isFinite(g)||!isFinite(u))return;const w=2*Math.atan2(p*g,P*u);if(!isFinite(w))return;const M=_*(1-l*l)/(1+l*Math.cos(w)),T=w+o,F=M*Math.cos(T),f=M*Math.sin(T),y=0;if(!isFinite(F)||!isFinite(f)||!isFinite(y))return;const O=Math.cos(S),v=Math.sin(S);if(!isFinite(O)||!isFinite(v)||!isFinite(h))return;let j=F,B=f*O-y*v,U=f*v+y*O;const N=Math.cos(h),x=Math.sin(h);if(!isFinite(N)||!isFinite(x))return;const L=j*N-B*x,I=j*x+B*N,G=U;if(!isFinite(L)||!isFinite(I)||!isFinite(G)||!isFinite(this.planetPosition.x)||!isFinite(this.planetPosition.y)||!isFinite(this.planetPosition.z))return;const b=L,E=G,k=-I,C=this.planetPosition.x+b,R=this.planetPosition.y+E,A=this.planetPosition.z+k;if(!isFinite(C)||!isFinite(R)||!isFinite(A))return;e.position.set(C,R,A);const z=e.getObjectByName(`moon-surface-${t.name}`);z&&this.applyTidalLockingWithLibration(z,t,w,i)}calculatePeriapsisWithPrecession(e,t){const i=e.orbit.argument_of_periapsis||0;if(!isFinite(t)||!isFinite(i))return i;const r=this.planetRadius,a=e.orbit.semi_major_axis_km;if(!isFinite(a)||a<=0||a/r>10)return i;const s=.001,c=2*Math.PI/e.orbit.orbital_period_seconds,d=e.orbit.inclination_deg*Math.PI/180;if(!isFinite(c)||!isFinite(d))return i;const _=3/2*s*c*Math.pow(r/a,2)*Math.cos(d);if(!isFinite(_))return i;const l=_*t,S=(i+l)%(2*Math.PI);return isFinite(S)?S:i}applyTidalLockingWithLibration(e,t,i,r){if(!isFinite(i))return;if(t.rotation?.is_tidally_locked??!0){e.lookAt(this.planetPosition);const n=t.orbit.eccentricity;if(isFinite(n)&&n>=0&&n<1){const s=2*n*Math.sin(i),d=t.orbit.inclination_deg*Math.PI/180*Math.sin(i)*.1;if(isFinite(s)&&isFinite(d)){const _=s+d;isFinite(_)&&e.rotateY(_)}}}else{const n=t.rotation?.angular_velocity_rad_s??2*Math.PI/t.orbit.orbital_period_seconds;if(isFinite(n)&&n>0){const s=Date.now()/1e3,c=this.moonData?.cosmic_origin_time||0,d=s-c,_=n*d;isFinite(_)&&(e.rotation.y=_%(2*Math.PI))}}}updateLOD(){if(!this.moonData)return;const e=this.camera.position,t=new me,i=new ue;i.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),t.setFromProjectionMatrix(i),this.moonMeshes.forEach((r,a)=>{const n=e.distanceTo(r.position),s=this.moonData.moons[a];if(!t.containsPoint(r.position)&&n>this.moonData.render_settings.lod_distances[1]){r.visible=!1;return}const d=this.moonData.render_settings.max_visible_distance*2;if(r.visible=n<d,!r.visible)return;const l=s.properties.radius_km/n;let S=2;n<this.moonData.render_settings.lod_distances[0]||l>.001?S=0:(n<this.moonData.render_settings.lod_distances[1]||l>1e-4)&&(S=1);const o=r.getObjectByName(`moon-surface-${s.name}`);o&&o.geometry instanceof Z&&this.applyGeometryLOD(o,S,n);const h=this.moonData.render_settings.max_visible_distance;if(n>h*.5){const m=Math.max(.3,1-(n-h*.5)/(h*.5));r.scale.setScalar(m)}else r.scale.setScalar(1)})}applyGeometryLOD(e,t,i){e.geometry;const r=e.material;i>1e3&&(r.roughness=Math.min(1,r.roughness+.1),r.metalness=Math.max(0,r.metalness-.05))}getMoonAtPosition(e){const t=e.intersectObjects(this.scene.children,!0);for(const i of t)if(i.object.userData?.isMoon||i.object.userData?.isMoonIndicator)return i.object.userData.moonData;return null}getMoonPosition(e){const t=this.moonMeshes.find(i=>i.name===`moon-${e}`);return t?t.position.clone():null}dispose(){this.fadeOutTimer&&(clearTimeout(this.fadeOutTimer),this.fadeOutTimer=null),this.initialShowTimer&&(clearTimeout(this.initialShowTimer),this.initialShowTimer=null),this.clearMoons(),this.moonMaterials.forEach(e=>e.dispose()),this.moonMaterials.clear()}startInitialShowTimer(){this.orbitalLinesTargetOpacity=0,this.orbitalLinesCurrentOpacity=0,this.lastInteractionTime=Date.now(),this.initialShowTimer=null}detectCameraMovement(){const e=this.camera.position.clone(),t=new $;this.camera.getWorldDirection(t);const i=e.distanceTo(this.lastCameraPosition)>this.cameraMovementThreshold,r=t.distanceTo(this.lastCameraTarget)>this.cameraMovementThreshold;return i||r?(this.lastCameraPosition.copy(e),this.lastCameraTarget.copy(t),!0):!1}isCameraMoving(){return this.detectCameraMovement()}onCameraMovement(){this.lastInteractionTime=Date.now(),this.fadeOutTimer&&(clearTimeout(this.fadeOutTimer),this.fadeOutTimer=null),this.initialShowTimer&&(clearTimeout(this.initialShowTimer),this.initialShowTimer=null),this.fadeInOrbitalLines(),this.fadeOutTimer=window.setTimeout(()=>{this.fadeOutOrbitalLines(),this.fadeOutTimer=null},this.fadeOutDelay)}fadeInOrbitalLines(){this.orbitalLinesFadeEnabled&&(this.orbitalLinesTargetOpacity=.4)}fadeOutOrbitalLines(){this.orbitalLinesFadeEnabled&&(this.orbitalLinesTargetOpacity=0)}updateOrbitalLinesFade(){if(!this.orbitalLinesFadeEnabled)return;const e=this.orbitalLinesTargetOpacity-this.orbitalLinesCurrentOpacity;Math.abs(e)>.001&&(this.orbitalLinesCurrentOpacity+=e*this.fadeSpeed,this.orbitalLines.forEach(a=>{if(a.name&&a.name.startsWith("moon-orbit-")){const n=this.orbitalLinesCurrentOpacity>.05;a.visible=n,n&&a.traverse(s=>{if(s instanceof J&&s.material instanceof se&&s.name&&s.name.startsWith("moon-orbit-segment-")){const c=s.material;c.opacity=this.orbitalLinesCurrentOpacity,c.needsUpdate=!0}})}}));const t=Date.now()/1e3,i=.5+Math.sin(t*4)*.4,r=this.orbitalLinesCurrentOpacity*i;this.smallMoonIndicators.forEach(a=>{if(a.material instanceof K&&(a.visible=this.orbitalLinesCurrentOpacity>.05,a.material.opacity=r,a.material.needsUpdate=!0,a.parent)){const n=new $;a.parent.getWorldPosition(n),a.lookAt(this.camera.position)}})}enableOrbitalLinesFade(e){this.orbitalLinesFadeEnabled=e,e||(this.orbitalLinesTargetOpacity=.4,this.orbitalLinesCurrentOpacity=.4,this.updateOrbitalLinesFade())}isOrbitalLinesFadeEnabled(){return this.orbitalLinesFadeEnabled}}export{Me as M};
