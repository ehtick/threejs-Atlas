import{j as n,r as u}from"./atlas_DztNjO7RDBVhWZ-y1bcy1.js";import{W as Ge}from"./atlas_oohEvMdySAEvykvrmEZWK.js";import{O as We}from"./atlas_ujwtN6M9bdCDvth7wAGyD.js";import{Q as He}from"./atlas_NcbMusH95geV1bEYmniMW.js";import{e as U}from"./atlas_CKgoXdq-KyExGQBSbNLMh.js";import{E as O,c as Ve}from"./atlas_RvtgSuNkg9MFF7eIotjGD.js";import{g as qe}from"./atlas_Dohzt8kNSWBW4t2pSLrOG.js";import{P as Ye}from"./atlas_BZAQSikhKZZ5xAz2fSejO.js";import{c as Qe}from"./atlas_B0DOS25QVmvMiQ0kDrzPR.js";import{a3 as Ze,a4 as Xe,C as Re,a5 as Je,a6 as Ke,a7 as et,a8 as tt,a9 as Se,aa as rt,b as nt,z as st,M as at,m as it}from"./atlas_Dr7FhitegIaVfnn-NnCom.js";class ne{static encodeUrl(c){return btoa(c).replace(/\+/g,"-").replace(/\//g,"_")}static generateGalaxyUrl(c,m=1){const g=`coordinates=${c[0]},${c[1]},${c[2]}&page=${m}`;return`/stargate/${this.encodeUrl(g)}`}static generateSystemUrl(c,m,g){const h=`coordinates=${c[0]},${c[1]},${c[2]}&system=${m}`;return`/stargate/${this.encodeUrl(h)}`}static generatePlanetUrl(c,m,g,h){const y=`coordinates=${c[0]},${c[1]},${c[2]}&system=${m}&planet=${g.toLowerCase()}`;return`/stargate/${this.encodeUrl(y)}`}static getCurrentPage(){try{const m=new URLSearchParams(window.location.search).get("page");if(m)return parseInt(m,10);const g=window.location.pathname.match(/\/galaxy\/(\d+)/);return g?parseInt(g[1],10):1}catch{return 1}}}const ot=(s,c)=>{try{const m=s.split("/stargate/")[1];if(!m)return null;const g=atob(m.replace(/-/g,"+").replace(/_/g,"/")),h=new URLSearchParams(g),y=h.get("coordinates"),b=h.get("system"),v=h.get("planet");if(!y)return null;const w={type:c,coordinates:y};return b&&(w.systemIndex=parseInt(b)),v&&(w.planetName=v),w}catch{return null}},Ce=s=>{try{const c=s.coordinates.split(",").map(Number),m=ne.getCurrentPage();let g;switch(s.type){case"galaxy":g=ne.generateGalaxyUrl(c,m);break;case"system":if(s.systemIndex!==void 0)g=ne.generateSystemUrl(c,s.systemIndex,m);else return window.location.href;break;case"planet":if(s.systemIndex!==void 0&&s.planetName)g=ne.generatePlanetUrl(c,s.systemIndex,s.planetName,m);else return window.location.href;break;default:return window.location.href}return`${window.location.origin}${g}`}catch{return window.location.href}},ct=async s=>{const{url:c,size:m}=s;return new Promise((g,h)=>{const y=document.createElement("canvas"),b=m,v=Math.floor(m*.8);He.toCanvas(y,c,{width:v,margin:0,color:{dark:"#000000",light:"#FFFFFF"},errorCorrectionLevel:"H"},w=>{if(w){h(w);return}const f=document.createElement("canvas"),a=f.getContext("2d"),F=Math.floor(b*.17);if(f.width=b,f.height=b+F,a){const E=Math.floor(b*.1);a.fillStyle="#FFFFFF",a.beginPath(),a.roundRect(0,0,f.width,f.height,E),a.fill();const G=(b-v)/2;a.drawImage(y,G,G),a.fillStyle="#000000",a.font=`bold ${Math.floor(b*.13)}px Arial`,a.textAlign="center",a.textBaseline="middle",a.fillText("VIEW IT LIVE",b/2,b+F*.2),g(f)}})})},lt=async(s,c,m,g)=>{try{let h;if("coordinates"in g)h=Ce(g);else{const a=ot(g.stargateUrl,g.type);a?h=Ce(a):h=g.stargateUrl}if(h.startsWith("http://localhost/"))try{const F=await(await fetch("/api/universe/config")).json(),E=45156749731585371360938718175484539659389209313560548011495000289036640085049n,G=4515674973158537e61,Y=F.config_seed;(Y===G||Y===E||BigInt(Y)===E)&&(h=h.replace("http://localhost/","https://the-atlas.koyeb.app/"))}catch(a){console.warn("Failed to check config seed:",a)}const y=Math.floor(c/8),b=await ct({url:h,size:y}),v=Math.floor(c/100),w=c-b.width-v,f=m-b.height-v;s.drawImage(b,w,f)}catch(h){console.warn("Failed to generate QR code:",h)}},ut=(s,c)=>{const{imageWidth:m,imageHeight:g,startYear:h=2023,companyName:y="Banshee",opacity:b=.5,fontSize:v}=c,w=new Date().getFullYear(),f=w===h?`${h}`:`${h}-${w}`,a=`The Atlas Â© Copyright ${y} â€¢ ${f}`;s.fillStyle=`rgba(255, 255, 255, ${b})`;const F=v||Math.floor(m/80);s.font=`${F}px Arial`,s.textAlign="left",s.textBaseline="bottom";const E=Math.floor(m/100);s.fillText(a,E,g-E)},ft=({isVisible:s,message:c="Exporting view, please wait..."})=>n.jsxs("div",{className:`absolute inset-0 bg-black flex flex-col items-center justify-center z-10 transition-all duration-300 ${s?"opacity-100 visible":"opacity-0 invisible"}`,children:[n.jsx("div",{className:"w-16 h-16 border-4 border-white/20 border-t-white rounded-full animate-spin mb-6"}),n.jsx("p",{className:"text-white text-xl font-medium text-center px-4",children:c})]}),dt=({planetData:s,showInConsole:c=!0,showInPage:m=!1})=>{const[g,h]=u.useState([]),[y,b]=u.useState({});u.useEffect(()=>{if(!s)return;const f=v(s);b(f),h(w(s)),typeof window<"u"&&(window.__DEBUG_PLANET_DATA=s,window.__DEBUG_PLANET_ANALYSIS=f)},[s,c]);function v(f){const a={hasValidStructure:!1,missingFields:[],dataIntegrity:"unknown",renderingIssues:[],colorConsistency:"unknown"};if(f.planet_info&&f.surface_elements?a.hasValidStructure=!0:(f.planet_info||a.missingFields.push("planet_info"),f.surface_elements||a.missingFields.push("surface_elements")),f.surface_elements?.type==="oceanic"&&(a.oceanicData={hasAbstractLands:!!f.surface_elements.abstract_lands?.length,numGreenPatches:f.surface_elements.green_patches?.length||0,numClouds:f.surface_elements.clouds?.length||0,hasDepths:f.surface_elements.depths?.enabled||!1,baseColorIsBlue:f.planet_info?.base_color==="#0000FF",greenPatchColor:f.surface_elements.green_patches?.[0]?.color,issues:[]},a.oceanicData.numGreenPatches>15&&a.oceanicData.issues.push("Muchos parches verdes pueden ocultar el ocÃ©ano azul"),a.oceanicData.baseColorIsBlue||a.oceanicData.issues.push(`Color base no es azul puro: ${f.planet_info?.base_color}`),a.renderingIssues=a.oceanicData.issues),f.planet_info?.base_color&&f.planet_info?.type){const E={Oceanic:"#0000FF",Rocky:"#808080",Icy:"#ADD8E6",Desert:"#FFD700",Lava:"#FF0000"}[f.planet_info.type];E&&f.planet_info.base_color!==E?a.colorConsistency=`Inconsistente: esperado ${E}, recibido ${f.planet_info.base_color}`:a.colorConsistency="Correcto"}return a}function w(f){const a=[];if(!f.surface_elements?.type)return["No surface type defined"];const F=f.surface_elements.type.toLowerCase();switch(F){case"oceanic":a.push("OceanWavesEffect (PROBLEMA: ignora green_patches de Python)");break;case"rocky":a.push("RockyTerrainEffect");break;case"icy":a.push("IcyTerrainEffect");break;case"gas giant":a.push("GasGiantBandsEffect");break;default:a.push(`Generic effect for type: ${F}`)}return f.atmosphere?.density>0&&a.push("AtmosphericEffect"),f.rings&&a.push("RingSystemEffect"),a}return m?n.jsxs("div",{style:{position:"fixed",top:10,right:10,background:"rgba(0, 0, 0, 0.9)",color:"#00ff00",padding:"10px",borderRadius:"5px",fontFamily:"monospace",fontSize:"12px",maxWidth:"400px",maxHeight:"600px",overflow:"auto",zIndex:1e4,border:"1px solid #00ff00"},children:[n.jsxs("h3",{style:{margin:"0 0 10px 0",color:"#00ff00"},children:["ðŸ” Planet Debug: ",s.planet_info?.name]}),n.jsxs("div",{style:{marginBottom:"10px"},children:[n.jsx("strong",{children:"Type:"})," ",s.planet_info?.type,n.jsx("br",{}),n.jsx("strong",{children:"Base Color:"})," ",s.planet_info?.base_color,n.jsx("br",{}),n.jsx("strong",{children:"Radius:"})," ",s.planet_info?.radius]}),s.surface_elements?.type==="oceanic"&&n.jsxs("div",{style:{marginBottom:"10px",borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[n.jsx("strong",{children:"ðŸŒŠ Oceanic Data:"}),n.jsx("br",{}),n.jsxs("span",{style:{color:y.oceanicData?.baseColorIsBlue?"#00ff00":"#ff0000"},children:["Base Color: ",y.oceanicData?.baseColorIsBlue?"âœ“ Blue":"âœ— Not Blue"]}),n.jsx("br",{}),"Green Patches: ",y.oceanicData?.numGreenPatches,n.jsx("br",{}),"Clouds: ",y.oceanicData?.numClouds,n.jsx("br",{}),"Has Depths: ",y.oceanicData?.hasDepths?"Yes":"No",n.jsx("br",{}),y.oceanicData?.issues?.length>0&&n.jsxs("div",{style:{color:"#ffaa00",marginTop:"5px"},children:["âš ï¸ Issues:",n.jsx("br",{}),y.oceanicData.issues.map((f,a)=>n.jsxs("div",{children:["- ",f]},a))]})]}),n.jsxs("div",{style:{borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[n.jsx("strong",{children:"ðŸŽ¨ Effects Applied:"}),n.jsx("br",{}),g.map((f,a)=>n.jsxs("div",{style:{color:f.includes("PROBLEMA")?"#ff0000":"#00ff00"},children:["- ",f]},a))]}),n.jsx("button",{style:{marginTop:"10px",background:"#00ff00",color:"#000",border:"none",padding:"5px 10px",cursor:"pointer",borderRadius:"3px"},children:"Log to Console"})]}):null};function pt(s){u.useEffect(()=>{if(s&&s.surface_elements?.type==="oceanic"){s.surface_elements.green_patches?.length>0;const c=s.planet_info?.base_color;c!=="#0000FF"&&console.warn("âš ï¸ Planeta oceÃ¡nico sin color azul base!",c)}},[s])}const X=2.5,Ie=()=>{const s=45*Math.PI/180;return X/(Math.tan(s/2)*.5)},mt=u.forwardRef(({planetName:s,containerClassName:c="",width:m=800,height:g=600,autoRotate:h=!0,enableControls:y=!0,showDebugInfo:b=!1,planetData:v,cosmicOriginTime:w,initialAngleRotation:f,onDataLoaded:a,onEffectsCreated:F,onError:E,planetUrl:G},Y)=>{const A=u.useRef(null),_=u.useRef(null),M=u.useRef(null),L=u.useRef(null),x=u.useRef(null),$=u.useRef(null),Ae=u.useRef(new Ze),se=u.useRef(null),ae=u.useRef(0),k=u.useRef(null),[ge,J]=u.useState(!0),[he,V]=u.useState(null),[R,_e]=u.useState(null),[Me,ie]=u.useState([]),[K,oe]=u.useState({activeEffects:0,enabledEffects:0,frameRate:0,renderTime:0}),Q=u.useRef([]),ce=u.useRef(0),ee=u.useRef(null),T=u.useRef(null),D=u.useRef(null),[le,be]=u.useState(!1);u.useImperativeHandle(Y,()=>({captureScreenshot:()=>{if(!M.current||!_.current||!L.current||le)return;be(!0),$.current&&($.current.enabled=!1);const e=M.current,r=_.current,t=L.current,i=e.domElement.width,l=e.domElement.height,d=3840/i,o=[];r.traverse(P=>{if(P.isPoints&&P.material){const p=P.material;if(p.size!==void 0){o.push({material:p,originalSize:p.size});const C=p.isPulsatingCubeParticle===!0?d*.3:d*1;p.size=p.size*C}if(p.uniforms){const C=p.isPulsatingCubeParticle===!0?d*.3:d*1;p.uniforms.size&&(o.push({material:p,uniform:"size",originalValue:p.uniforms.size.value}),p.uniforms.size.value=p.uniforms.size.value*C),p.uniforms.scale&&(o.push({material:p,uniform:"scale",originalValue:p.uniforms.scale.value}),p.uniforms.scale.value=p.uniforms.scale.value*C)}if(P.geometry&&P.geometry.attributes.size){const S=P.geometry.attributes.size,C=S.array.slice();o.push({geometry:P.geometry,originalSizeArray:C});const H=p.isPulsatingCubeParticle===!0?d*.3:d*1;for(let N=0;N<S.array.length;N++)S.array[N]*=H;S.needsUpdate=!0}}if(P.isSprite&&(o.push({object:P,originalScale:P.scale.clone()}),P.scale.multiplyScalar(d*1)),P.isLine&&P.material){const p=P.material;p.linewidth!==void 0&&(o.push({material:p,originalLinewidth:p.linewidth}),p.linewidth=p.linewidth*d*1)}});const j=3840,B=3840;e.setSize(j,B),t.aspect=1,t.updateProjectionMatrix(),e.render(r,t),e.domElement.toBlob(P=>{if(P){const p=document.createElement("canvas"),S=p.getContext("2d");if(p.width=j,p.height=B,S){const C=new Image;C.onload=async()=>{S.drawImage(C,0,0),ut(S,{imageWidth:j,imageHeight:B}),G&&await lt(S,j,B,{type:"planet",stargateUrl:G}),p.toBlob(H=>{if(H){const N=URL.createObjectURL(H),q=document.createElement("a");q.href=N,q.download=`planet_${s}_${Date.now()}.jpg`,q.click(),URL.revokeObjectURL(N)}},"image/jpeg",1)};const W=URL.createObjectURL(P);C.src=W}}o.forEach(({material:p,object:S,originalSize:C,originalScale:W,originalLinewidth:H,uniform:N,originalValue:q,geometry:ve,originalSizeArray:me})=>{if(C!==void 0&&(p.size=C),W!==void 0&&S.scale.copy(W),H!==void 0&&(p.linewidth=H),N&&q!==void 0&&(p.uniforms[N].value=q),ve&&me){const Ee=ve.attributes.size;for(let re=0;re<me.length;re++)Ee.array[re]=me[re];Ee.needsUpdate=!0}}),e.setSize(i,l),t.aspect=i/l,t.updateProjectionMatrix(),$.current&&($.current.enabled=!0),be(!1)},"image/jpeg",1)},isGeneratingImage:le}));const De=Math.floor(Date.now()/1e3),[je,ht]=u.useState(0),Fe=w||R?.timing?.cosmic_origin_time||Date.now()/1e3-3600,Le=De-Fe+je;ae.current=Le;const ue=u.useCallback(()=>{if(!A.current||!M.current||!L.current)return;const e=A.current,r=e.clientWidth||400,t=e.clientHeight||400;M.current.setSize(r,t),D.current&&D.current.setSize(r,t),L.current.aspect=r/t,L.current.updateProjectionMatrix()},[]),ye=async e=>{if(!(!x.current||!_.current||!T.current)){O.log("Applying modular effects from API data",{planet:e.planet_info.name,type:e.planet_info.type});try{de();const r=qe(e);T.current.updateBaseColor(r);const t=U.createEffectsFromPythonPlanetData(e,X,x.current,_.current,T.current),i=e.planet_info?.type||e.surface_elements?.planet_type||e.planet_type;if((i==="toxic"||i==="Toxic")&&_.current&&L.current&&M.current)try{const l=Qe(_.current,L.current,M.current,X,{planet_type:"toxic",toxic_intensity:.8,atmosphere_thickness:.6},e.seeds?.planet_seed);if(l){D.current=l;const d={id:`effect_toxic_postprocessing_${Date.now()}`,type:"toxic_post_processing",effect:{dispose:()=>l.dispose(),update:o=>l.update(o),updateUniforms:o=>l.update(o),addToScene:()=>{},apply:()=>{}},priority:100,enabled:!0,name:"Toxic Post-Processing (Bloom + Godrays + Chromatic Aberration)"};U.effects.set(d.id,d),t.push(d),O.log("Created toxic post-processing effects")}}catch(l){O.error("Error creating toxic post-processing",l)}else D.current&&(D.current.dispose(),D.current=null);ie(t),Q.current=t,F&&F(t),O.log(`Successfully applied ${t.length} modular effects`),pe()}catch{te()}}},Te=u.useCallback(()=>{if(!A.current)return!1;try{for(;A.current.firstChild;)A.current.removeChild(A.current.firstChild);_.current=null,L.current=null,M.current=null,x.current=null,I.current=null;const e=A.current,r=e.clientWidth||m||400,t=e.clientHeight||g||400,i=new Xe;i.background=new Re(1297),_.current=i;const l=new Je(45,r/t,.1,1e4),d=Ie();l.position.set(0,0,d),l.lookAt(0,0,0),L.current=l;const o=new Ge({antialias:!0,alpha:!0,powerPreference:"high-performance"});return o.setSize(r,t),o.setPixelRatio(Math.min(window.devicePixelRatio,2)),o.shadowMap.enabled=!0,o.shadowMap.type=Ke,o.toneMapping=et,o.toneMappingExposure=1.2,o.outputColorSpace=tt,o.domElement.className="",A.current.appendChild(o.domElement),M.current=o,Ue(i,null),$e(i),y&&Ne(l,o.domElement),!0}catch{return!1}},[R,v,w]),ze=e=>{if(!e)return 0;const r=e.sun_angle||e.lighting?.sun_angle;if(r!==void 0)return r;const t=e.timing?.current_orbital_angle||e.timing?.orbital_angle;return t??0},z=u.useRef(null),fe=u.useRef(null),Z=u.useRef(null),I=u.useRef(null),ke=e=>{e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.camera.left=-10,e.shadow.camera.right=10,e.shadow.camera.top=10,e.shadow.camera.bottom=-10},we=e=>{if(!z.current||!_.current)return;const r=ze(e),t=10,i=r+Math.PI,l=Math.sin(r)*5,d=t*Math.cos(i),o=l,j=t*Math.sin(i);z.current.position.set(d,o,j),z.current.target.position.set(0,0,0),_.current.children.includes(z.current.target)||_.current.add(z.current.target),fe.current&&fe.current.position.set(-d*.5,0,-j*.5),T.current&&z.current&&T.current.updateFromThreeLight(z.current),z.current&&U.updateLightForAllEffects(z.current)},Ue=(e,r)=>{{const t=new Se(16777215,2);t.position.set(-10,5,10),t.target.position.set(0,0,0),t.castShadow=!0,ke(t),e.add(t),e.add(t.target),z.current=t;const i=new Se(16777215,.05);i.position.set(8,-3,-5),e.add(i),fe.current=i;const l=new rt(2236996,.1);e.add(l),setTimeout(()=>{T.current&&t&&T.current.updateFromThreeLight(t),t&&U.updateLightForAllEffects(t)},50);return}},$e=e=>{const r=new nt(X,128,64),t=new st({color:8421504}),i=new at(r,t);i.castShadow=!0,i.receiveShadow=!0,i.position.set(0,0,0),e.add(i),x.current=i;const l=new Re(8421504);T.current=new Ye(i,l),T.current.addToScene(e)},Ne=(e,r)=>{const t=new We(e,r);t.enableDamping=!0,t.dampingFactor=.05;const i=Ie();t.minDistance=i*.5,t.maxDistance=i*2,t.autoRotate=h,t.autoRotateSpeed=.5,t.enablePan=!0,t.enableZoom=!0,t.target.set(0,0,0),$.current=t},Oe=u.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{J(!0),V(null),O.log("Loading planet data from API",{planetName:s});const r=await fetch("/api/planet/rendering-data");if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const t=await r.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const i=t.planet_data,l=t.timing,d=t.rendering_data,o={planet_info:d?.planet_info||{name:i.name,type:i.planet_type,base_color:"#808080",radius:i.diameter/15e3,orbital_radius:i.orbital_radius},surface_elements:d?.surface_elements,atmosphere:d?.atmosphere,rings:d?.rings,effects_3d:d?.effects_3d,shader_uniforms:d?.shader_uniforms,universal_actions:d?.universal_actions,timing:{cosmic_origin_time:l.cosmic_origin_time,current_time_seconds:l.current_time_seconds,elapsed_time:l.elapsed_time,initial_orbital_angle:i.initial_orbital_angle,current_orbital_angle:i.current_orbital_angle,max_orbital_radius:l.max_orbital_radius,system_max_orbital_radius:i.system_max_orbital_radius},original_planet_data:i,seeds:d?.seeds};return _e(o),k.current=o,O.log("API data loaded successfully",{planet:o.planet_info.name,type:o.planet_info.type,hasEffects:!!o.surface_elements,fullRenderingData:d}),a&&a(o),o}catch(e){const r=e instanceof Error?e.message:"Unknown error";return V(r),E&&E(r),null}finally{J(!1),window.isLoadingPlanetData=!1}}},[s,a,E]);u.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{J(!0),V(null),O.log("Loading planet data from API",{planetName:s});const r=await fetch("/api/planet/rendering-data");if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const t=await r.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const i=t.planet_data,l=t.timing,d=t.rendering_data,o={planet_info:d?.planet_info||{name:i.name,type:i.planet_type,base_color:"#808080",radius:i.diameter/15e3,orbital_radius:i.orbital_radius},surface_elements:d?.surface_elements,atmosphere:d?.atmosphere,rings:d?.rings,effects_3d:d?.effects_3d,shader_uniforms:d?.shader_uniforms,universal_actions:d?.universal_actions,timing:{cosmic_origin_time:l.cosmic_origin_time,current_time_seconds:l.current_time_seconds,elapsed_time:l.elapsed_time,initial_orbital_angle:i.initial_orbital_angle,current_orbital_angle:i.current_orbital_angle,max_orbital_radius:l.max_orbital_radius,system_max_orbital_radius:i.system_max_orbital_radius},original_planet_data:i,seeds:d?.seeds};_e(o),k.current=o,O.log("API data loaded successfully",{planet:o.planet_info.name,type:o.planet_info.type,hasEffects:!!o.surface_elements,fullRenderingData:d}),we(o),I.current&&_.current&&(_.current.remove(I.current),I.current.geometry.dispose(),I.current.material.dispose(),I.current=null),await ye(o),a&&a(o)}catch(e){const r=e instanceof Error?e.message:"Unknown error";V(r),E&&E(r),te()}finally{J(!1),window.isLoadingPlanetData=!1}}},[s,v,w,f]);const xe=u.useCallback(()=>{if(!R||!x.current)return;const e=v?.orbital_period_seconds||365.25*24*3600,r=2*Math.PI/e,t=R.timing?.initial_orbital_angle||0,i=Date.now()/1e3,l=0,d=w||R.timing?.cosmic_origin_time||Date.now()/1e3-3600,o=i-d+l,j=(t+o*r)%(2*Math.PI),B=R.timing?.max_orbital_radius||100,p=20+R.planet_info?.orbital_radius/B*80,S=p,C=p*Math.cos(j),W=S*Math.sin(j);x.current.position.x=C,x.current.position.z=W,x.current.position.y=0},[R,v,w]),Be=u.useCallback(async e=>{const r=e||R;if(r&&_.current)try{we(r),I.current&&_.current&&(_.current.remove(I.current),I.current.geometry.dispose(),I.current.material.dispose(),I.current=null),await ye(r)}catch{te()}},[R]),te=()=>{if(!(!_.current||!x.current)){O.warn("Applying fallback effects for planet type:",v?.planet_type);try{de(),x.current.material instanceof it&&x.current.material.color.setHex(6710886);try{const e=Ve("generic"),r=U.createEffectsFromList(e,X,x.current);r.forEach(t=>{t.effect.addToScene&&_.current&&x.current&&t.effect.addToScene(_.current,x.current.position)}),Q.current=r,ie(r)}catch{}pe()}catch{}}},de=()=>{Q.current.forEach(e=>{try{U.removeEffect(e.id),e.effect.dispose&&e.effect.dispose()}catch{}}),D.current&&(D.current.dispose(),D.current=null),Q.current=[],ie([])},Pe=u.useCallback(()=>{se.current=requestAnimationFrame(Pe);const e=performance.now(),r=Ae.current.getDelta();$.current&&$.current.update();try{U.updateAllEffects(r,x.current?.rotation.y,L.current||void 0)}catch{}if(x.current&&k.current){k.current.planet_info?.name;const l=k.current.original_planet_data,d=l?.orbital_period_seconds||365.25*24*3600,o=k.current.timing?.initial_orbital_angle||0;w||k.current.timing?.cosmic_origin_time||Date.now()/1e3-3600;const j=l?.axial_tilt||0,B=2*Math.PI/d;(o+ae.current*B)%(2*Math.PI);const P=k.current.timing?.max_orbital_radius||k.current.timing?.system_max_orbital_radius,p=l?.orbital_radius;if(!P||!p)return;l?.eccentricity_factor,x.current.position.set(0,0,0);const S=l?.rotation_period_seconds||86400,C=2*Math.PI/S;x.current.rotation.y=ae.current*C%(2*Math.PI),x.current.rotation.z=j*(Math.PI/180)}Q.current.forEach(l=>{l.effect.updateUniforms&&l.effect.updateUniforms(r)});const i=Array.from(U.effects.values()).find(l=>l.type==="toxic_post_processing")?.enabled||!1;if(D.current&&i&&(D.current.update(r),z.current&&D.current.updateLightPosition(z.current.position,L.current)),M.current&&_.current&&L.current){const l=performance.now();D.current&&i?D.current.render():M.current.render(_.current,L.current);const d=performance.now()-l;if(e-ce.current>5e3){const o=1e3/(e-ce.current);pe(),oe(j=>({...j,frameRate:Math.round(o),renderTime:Math.round(d*100)/100})),ce.current=e}}},[]),pe=u.useCallback(()=>{const e=U.getStats();oe(r=>({...r,activeEffects:e.activeEffects,enabledEffects:e.enabledEffects}))},[]);return u.useEffect(()=>{let e=!0;return window.tonnirLoggedInPlanet=!1,window.orbitChecked=!1,window.debugOrbitRadius=null,window.debugSystemMaxRadius=null,window.planetNameLogged=!1,window.timingDataLogged=!1,window.isLoadingPlanetData=!1,window.orbitalAngleSourceLogged=!1,window.orbitalAngleDebugged=!1,window.positionDebugged=!1,window.animationLoopDebugged=!1,(async()=>{try{if(!e)return;const t=await Oe();if(!e)return;if(!Te()){e&&V("Failed to initialize 3D renderer");return}if(!e||(Pe(),A.current&&"ResizeObserver"in window&&(ee.current=new ResizeObserver(ue),ee.current.observe(A.current)),window.addEventListener("resize",ue),!e))return;t?await Be(t):te()}catch(t){e&&V(t instanceof Error?t.message:"Unknown initialization error")}})(),()=>{if(e=!1,k.current=null,se.current&&cancelAnimationFrame(se.current),ee.current&&ee.current.disconnect(),window.removeEventListener("resize",ue),de(),T.current&&(T.current.dispose(),T.current=null),$.current&&$.current.dispose(),Z.current&&_.current&&(_.current.remove(Z.current),Z.current.geometry.dispose(),Z.current.material.dispose(),Z.current=null),I.current&&_.current&&(_.current.remove(I.current),I.current.geometry.dispose(),I.current.material.dispose(),I.current=null),M.current&&A.current)try{A.current.contains(M.current.domElement)&&A.current.removeChild(M.current.domElement),M.current.dispose()}catch{}}},[]),u.useEffect(()=>{const e=setInterval(()=>{const r=U.getStats();oe(t=>({...t,activeEffects:r.activeEffects,enabledEffects:r.enabledEffects}))},1e4);return()=>clearInterval(e)},[]),u.useEffect(()=>{R&&_.current&&x.current&&xe()},[R,xe]),pt(R),n.jsxs("div",{className:`relative ${c}`,children:[b&&R&&n.jsx(dt,{planetData:R,showInPage:!0,showInConsole:!0}),n.jsx("div",{ref:A,className:"w-full h-full",style:{minHeight:"300px",aspectRatio:"1"}}),n.jsx(ft,{isVisible:le}),ge&&n.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-50",children:n.jsxs("div",{className:"text-white text-center",children:[n.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"}),n.jsx("div",{children:"Loading planet..."})]})}),he&&n.jsxs("div",{className:"absolute top-0 left-0 right-0 p-2 bg-red-500 text-white text-sm",children:[n.jsx("strong",{children:"Error:"})," ",he]}),R&&!ge&&n.jsx("div",{className:"absolute bottom-0 left-0 p-2 text-white bg-black bg-opacity-50 max-w-xs rounded-tr-lg",children:n.jsx("h3",{className:"text-xs font-bold",children:R.planet_info.name})}),b&&n.jsxs("div",{className:"absolute top-0 right-0 p-4 text-white bg-black bg-opacity-70 text-xs font-mono",children:[n.jsx("h4",{className:"font-bold mb-2",children:"Debug Info"}),n.jsxs("div",{children:["Frame Rate: ",K.frameRate," FPS"]}),n.jsxs("div",{children:["Render Time: ",K.renderTime,"ms"]}),n.jsxs("div",{children:["Active Effects: ",K.activeEffects]}),n.jsxs("div",{children:["Enabled Effects: ",K.enabledEffects]}),n.jsxs("div",{className:"mt-2",children:[n.jsx("div",{className:"font-semibold",children:"Effects:"}),Me.map(e=>n.jsxs("div",{className:"ml-2",children:[e.type," (",e.enabled?"ON":"OFF",")"]},e.id))]})]})]})});class gt extends u.Component{constructor(c){super(c),this.state={hasError:!1,error:null}}static getDerivedStateFromError(c){return{hasError:!0,error:c.message}}componentDidCatch(c,m){}render(){return this.state.hasError?n.jsx("div",{className:"flex items-center justify-center w-full h-full bg-gray-900/50 rounded",children:n.jsxs("div",{className:"text-center p-4",children:[n.jsx("div",{className:"text-red-400 text-sm mb-2",children:"3D Renderer Error"}),n.jsx("div",{className:"text-xs text-gray-400",children:this.state.error})]})}):this.props.children}}const Ct=u.forwardRef((s,c)=>n.jsx(gt,{children:n.jsx(mt,{ref:c,...s})}));export{ft as E,Ct as M,ne as S,ut as a,lt as b};
