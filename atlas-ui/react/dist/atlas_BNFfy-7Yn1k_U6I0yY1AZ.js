import{j as c,r as i}from"./atlas_BSujyM3STIIs7ogMAeFeS.js";import{W as nt}from"./atlas_XGSDCzrG-pjJUG7P8pQ46.js";import{O as st}from"./atlas_D_U2TZ8CYBU6mWNRLKbuk.js";import{Q as at}from"./atlas_BrYhsyGbdfinGesBjh40k.js";import{e as B}from"./atlas_nEeIqfFouBkG-lfgz55PI.js";import{E as H,c as it}from"./atlas_BNHJ6aWi1b_rytD4uhAmB.js";import{g as ot}from"./atlas_B7nfVtdCEC1XYhTi8ViLE.js";import{P as ct}from"./atlas_-3HiC_x_SNXjkLB6C4QP7.js";import{M as $e}from"./atlas_DR_GZVwZQq3jSg9ohVD5v.js";import{c as lt}from"./atlas_Dtrmf1_lMQ9_aCLozWSkD.js";import{a3 as ut,a4 as ft,f as dt,a5 as mt,C as Ne,a6 as pt,a7 as gt,a8 as ht,a9 as _t,aa as Oe,b as bt,z as yt,M as wt,V as te,ab as xt,m as Pt}from"./atlas_S2gaYUaVDGx2fzGLEfKud.js";class ce{static encodeUrl(f){return btoa(f).replace(/\+/g,"-").replace(/\//g,"_")}static generateGalaxyUrl(f,p=1){const h=`coordinates=${f[0]},${f[1]},${f[2]}&page=${p}`;return`/stargate/${this.encodeUrl(h)}`}static generateSystemUrl(f,p,h){const _=`coordinates=${f[0]},${f[1]},${f[2]}&system=${p}`;return`/stargate/${this.encodeUrl(_)}`}static generatePlanetUrl(f,p,h,_){const E=`coordinates=${f[0]},${f[1]},${f[2]}&system=${p}&planet=${h.toLowerCase()}`;return`/stargate/${this.encodeUrl(E)}`}static getCurrentPage(){try{const p=new URLSearchParams(window.location.search).get("page");if(p)return parseInt(p,10);const h=window.location.pathname.match(/\/galaxy\/(\d+)/);return h?parseInt(h[1],10):1}catch{return 1}}}const vt=(l,f)=>{try{const p=l.split("/stargate/")[1];if(!p)return null;const h=atob(p.replace(/-/g,"+").replace(/_/g,"/")),_=new URLSearchParams(h),E=_.get("coordinates"),x=_.get("system"),M=_.get("planet");if(!E)return null;const S={type:f,coordinates:E};return x&&(S.systemIndex=parseInt(x)),M&&(S.planetName=M),S}catch{return null}},Be=l=>{try{const f=l.coordinates.split(",").map(Number),p=ce.getCurrentPage();let h;switch(l.type){case"galaxy":h=ce.generateGalaxyUrl(f,p);break;case"system":if(l.systemIndex!==void 0)h=ce.generateSystemUrl(f,l.systemIndex,p);else return window.location.href;break;case"planet":if(l.systemIndex!==void 0&&l.planetName)h=ce.generatePlanetUrl(f,l.systemIndex,l.planetName,p);else return window.location.href;break;default:return window.location.href}return`${window.location.origin}${h}`}catch{return window.location.href}},Rt=async l=>{const{url:f,size:p}=l;return new Promise((h,_)=>{const E=document.createElement("canvas"),x=p,M=Math.floor(p*.8);at.toCanvas(E,f,{width:M,margin:0,color:{dark:"#000000",light:"#FFFFFF"},errorCorrectionLevel:"H"},S=>{if(S){_(S);return}const m=document.createElement("canvas"),u=m.getContext("2d"),z=Math.floor(x*.17);if(m.width=x,m.height=x+z,u){const I=Math.floor(x*.1);u.fillStyle="#FFFFFF",u.beginPath(),u.roundRect(0,0,m.width,m.height,I),u.fill();const N=(x-M)/2;u.drawImage(E,N,N),u.fillStyle="#000000",u.font=`bold ${Math.floor(x*.13)}px Arial`,u.textAlign="center",u.textBaseline="middle",u.fillText("VIEW IT LIVE",x/2,x+z*.2),h(m)}})})},Et=async(l,f,p,h)=>{try{let _;if("coordinates"in h)_=Be(h);else{const u=vt(h.stargateUrl,h.type);u?_=Be(u):_=h.stargateUrl}if(_.startsWith("http://localhost/"))try{const z=await(await fetch("/api/universe/config")).json(),I=45156749731585371360938718175484539659389209313560548011495000289036640085049n,N=4515674973158537e61,X=z.config_seed;(X===N||X===I||BigInt(X)===I)&&(_=_.replace("http://localhost/","https://the-atlas.koyeb.app/"))}catch(u){console.warn("Failed to check config seed:",u)}const E=Math.floor(f/8),x=await Rt({url:_,size:E}),M=Math.floor(f/100),S=f-x.width-M,m=p-x.height-M;l.drawImage(x,S,m)}catch(_){console.warn("Failed to generate QR code:",_)}},Ct=(l,f)=>{const{imageWidth:p,imageHeight:h,startYear:_=2023,companyName:E="Banshee",opacity:x=.5,fontSize:M}=f,S=new Date().getFullYear(),m=S===_?`${_}`:`${_}-${S}`,u=`The Atlas Â© Copyright ${E} â€¢ ${m}`;l.fillStyle=`rgba(255, 255, 255, ${x})`;const z=M||Math.floor(p/80);l.font=`${z}px Arial`,l.textAlign="left",l.textBaseline="bottom";const I=Math.floor(p/100);l.fillText(u,I,h-I)},St=({isVisible:l,message:f="Exporting view, please wait..."})=>c.jsxs("div",{className:`absolute inset-0 bg-black flex flex-col items-center justify-center z-10 transition-all duration-300 ${l?"opacity-100 visible":"opacity-0 invisible"}`,children:[c.jsx("div",{className:"w-16 h-16 border-4 border-white/20 border-t-white rounded-full animate-spin mb-6"}),c.jsx("p",{className:"text-white text-xl font-medium text-center px-4",children:f})]}),Mt=({planetData:l,showInConsole:f=!0,showInPage:p=!1})=>{const[h,_]=i.useState([]),[E,x]=i.useState({});i.useEffect(()=>{if(!l)return;const m=M(l);x(m),_(S(l)),typeof window<"u"&&(window.__DEBUG_PLANET_DATA=l,window.__DEBUG_PLANET_ANALYSIS=m)},[l,f]);function M(m){const u={hasValidStructure:!1,missingFields:[],dataIntegrity:"unknown",renderingIssues:[],colorConsistency:"unknown"};if(m.planet_info&&m.surface_elements?u.hasValidStructure=!0:(m.planet_info||u.missingFields.push("planet_info"),m.surface_elements||u.missingFields.push("surface_elements")),m.surface_elements?.type==="oceanic"&&(u.oceanicData={hasAbstractLands:!!m.surface_elements.abstract_lands?.length,numGreenPatches:m.surface_elements.green_patches?.length||0,numClouds:m.surface_elements.clouds?.length||0,hasDepths:m.surface_elements.depths?.enabled||!1,baseColorIsBlue:m.planet_info?.base_color==="#0000FF",greenPatchColor:m.surface_elements.green_patches?.[0]?.color,issues:[]},u.oceanicData.numGreenPatches>15&&u.oceanicData.issues.push("Muchos parches verdes pueden ocultar el ocÃ©ano azul"),u.oceanicData.baseColorIsBlue||u.oceanicData.issues.push(`Color base no es azul puro: ${m.planet_info?.base_color}`),u.renderingIssues=u.oceanicData.issues),m.planet_info?.base_color&&m.planet_info?.type){const I={Oceanic:"#0000FF",Rocky:"#808080",Icy:"#ADD8E6",Desert:"#FFD700",Lava:"#FF0000"}[m.planet_info.type];I&&m.planet_info.base_color!==I?u.colorConsistency=`Inconsistente: esperado ${I}, recibido ${m.planet_info.base_color}`:u.colorConsistency="Correcto"}return u}function S(m){const u=[];if(!m.surface_elements?.type)return["No surface type defined"];const z=m.surface_elements.type.toLowerCase();switch(z){case"oceanic":u.push("OceanWavesEffect (PROBLEMA: ignora green_patches de Python)");break;case"rocky":u.push("RockyTerrainEffect");break;case"icy":u.push("IcyTerrainEffect");break;case"gas giant":u.push("GasGiantBandsEffect");break;default:u.push(`Generic effect for type: ${z}`)}return m.atmosphere?.density>0&&u.push("AtmosphericEffect"),m.rings&&u.push("RingSystemEffect"),u}return p?c.jsxs("div",{style:{position:"fixed",top:10,right:10,background:"rgba(0, 0, 0, 0.9)",color:"#00ff00",padding:"10px",borderRadius:"5px",fontFamily:"monospace",fontSize:"12px",maxWidth:"400px",maxHeight:"600px",overflow:"auto",zIndex:1e4,border:"1px solid #00ff00"},children:[c.jsxs("h3",{style:{margin:"0 0 10px 0",color:"#00ff00"},children:["ðŸ” Planet Debug: ",l.planet_info?.name]}),c.jsxs("div",{style:{marginBottom:"10px"},children:[c.jsx("strong",{children:"Type:"})," ",l.planet_info?.type,c.jsx("br",{}),c.jsx("strong",{children:"Base Color:"})," ",l.planet_info?.base_color,c.jsx("br",{}),c.jsx("strong",{children:"Radius:"})," ",l.planet_info?.radius]}),l.surface_elements?.type==="oceanic"&&c.jsxs("div",{style:{marginBottom:"10px",borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[c.jsx("strong",{children:"ðŸŒŠ Oceanic Data:"}),c.jsx("br",{}),c.jsxs("span",{style:{color:E.oceanicData?.baseColorIsBlue?"#00ff00":"#ff0000"},children:["Base Color: ",E.oceanicData?.baseColorIsBlue?"âœ“ Blue":"âœ— Not Blue"]}),c.jsx("br",{}),"Green Patches: ",E.oceanicData?.numGreenPatches,c.jsx("br",{}),"Clouds: ",E.oceanicData?.numClouds,c.jsx("br",{}),"Has Depths: ",E.oceanicData?.hasDepths?"Yes":"No",c.jsx("br",{}),E.oceanicData?.issues?.length>0&&c.jsxs("div",{style:{color:"#ffaa00",marginTop:"5px"},children:["âš ï¸ Issues:",c.jsx("br",{}),E.oceanicData.issues.map((m,u)=>c.jsxs("div",{children:["- ",m]},u))]})]}),c.jsxs("div",{style:{borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[c.jsx("strong",{children:"ðŸŽ¨ Effects Applied:"}),c.jsx("br",{}),h.map((m,u)=>c.jsxs("div",{style:{color:m.includes("PROBLEMA")?"#ff0000":"#00ff00"},children:["- ",m]},u))]}),c.jsx("button",{style:{marginTop:"10px",background:"#00ff00",color:"#000",border:"none",padding:"5px 10px",cursor:"pointer",borderRadius:"3px"},children:"Log to Console"})]}):null};function Dt(l){i.useEffect(()=>{if(l&&l.surface_elements?.type==="oceanic"){l.surface_elements.green_patches?.length>0;const f=l.planet_info?.base_color;f!=="#0000FF"&&console.warn("âš ï¸ Planeta oceÃ¡nico sin color azul base!",f)}},[l])}const G=2.5,Re=()=>{const l=45*Math.PI/180;return G/(Math.tan(l/2)*.5)},It=i.forwardRef(({planetName:l,containerClassName:f="",width:p=800,height:h=600,autoRotate:_=!0,enableControls:E=!0,showDebugInfo:x=!1,planetData:M,cosmicOriginTime:S,initialAngleRotation:m,onDataLoaded:u,onEffectsCreated:z,onError:I,onMoonSelected:N,planetUrl:X},Ee)=>{const w=i.useRef(null),g=i.useRef(null),F=i.useRef(null),P=i.useRef(null),C=i.useRef(null),k=i.useRef(null),Ge=i.useRef(new ut),le=i.useRef(null),ue=i.useRef(0),O=i.useRef(null),[Ce,re]=i.useState(!0),[Se,Q]=i.useState(null),[b,Me]=i.useState(null),[We,fe]=i.useState([]),[ne,de]=i.useState({activeEffects:0,enabledEffects:0,frameRate:0,renderTime:0}),J=i.useRef([]),me=i.useRef(0),se=i.useRef(null),U=i.useRef(null),T=i.useRef(null),L=i.useRef(null),pe=i.useRef(new ft),ge=i.useRef(new dt),V=i.useRef(null),ae=i.useRef(!1),[he,De]=i.useState(!1),[Tt,_e]=i.useState(null),K=i.useRef(null);i.useImperativeHandle(Ee,()=>({captureScreenshot:()=>{if(!F.current||!g.current||!P.current||he)return;De(!0),k.current&&(k.current.enabled=!1);const e=F.current,r=g.current,t=P.current,s=e.domElement.width,a=e.domElement.height,o=3840/s,n=[];r.traverse(R=>{if(R.isPoints&&R.material){const d=R.material;if(d.size!==void 0){n.push({material:d,originalSize:d.size});const A=d.isPulsatingCubeParticle===!0?o*.3:o*1;d.size=d.size*A}if(d.uniforms){const A=d.isPulsatingCubeParticle===!0?o*.3:o*1;d.uniforms.size&&(n.push({material:d,uniform:"size",originalValue:d.uniforms.size.value}),d.uniforms.size.value=d.uniforms.size.value*A),d.uniforms.scale&&(n.push({material:d,uniform:"scale",originalValue:d.uniforms.scale.value}),d.uniforms.scale.value=d.uniforms.scale.value*A)}if(R.geometry&&R.geometry.attributes.size){const y=R.geometry.attributes.size,A=y.array.slice();n.push({geometry:R.geometry,originalSizeArray:A});const q=d.isPulsatingCubeParticle===!0?o*.3:o*1;for(let W=0;W<y.array.length;W++)y.array[W]*=q;y.needsUpdate=!0}}if(R.isSprite&&(n.push({object:R,originalScale:R.scale.clone()}),R.scale.multiplyScalar(o*1)),R.isLine&&R.material){const d=R.material;d.linewidth!==void 0&&(n.push({material:d,originalLinewidth:d.linewidth}),d.linewidth=d.linewidth*o*1)}});const v=3840,D=3840;e.setSize(v,D),t.aspect=1,t.updateProjectionMatrix(),e.render(r,t),e.domElement.toBlob(R=>{if(R){const d=document.createElement("canvas"),y=d.getContext("2d");if(d.width=v,d.height=D,y){const A=new Image;A.onload=async()=>{y.drawImage(A,0,0),Ct(y,{imageWidth:v,imageHeight:D}),X&&await Et(y,v,D,{type:"planet",stargateUrl:X}),d.toBlob(q=>{if(q){const W=URL.createObjectURL(q),Z=document.createElement("a");Z.href=W,Z.download=`planet_${l}_${Date.now()}.jpg`,Z.click(),URL.revokeObjectURL(W)}},"image/jpeg",1)};const Y=URL.createObjectURL(R);A.src=Y}}n.forEach(({material:d,object:y,originalSize:A,originalScale:Y,originalLinewidth:q,uniform:W,originalValue:Z,geometry:ze,originalSizeArray:ve})=>{if(A!==void 0&&(d.size=A),Y!==void 0&&y.scale.copy(Y),q!==void 0&&(d.linewidth=q),W&&Z!==void 0&&(d.uniforms[W].value=Z),ze&&ve){const Ue=ze.attributes.size;for(let oe=0;oe<ve.length;oe++)Ue.array[oe]=ve[oe];Ue.needsUpdate=!0}}),e.setSize(s,a),t.aspect=s/a,t.updateProjectionMatrix(),k.current&&(k.current.enabled=!0),De(!1)},"image/jpeg",1)},isGeneratingImage:he}));const He=Math.floor(Date.now()/1e3),[Ve,jt]=i.useState(0),Ye=S||b?.timing?.cosmic_origin_time||Date.now()/1e3-3600,qe=He-Ye+Ve;ue.current=qe;const be=i.useCallback(()=>{if(!w.current||!F.current||!P.current)return;const e=w.current,r=e.clientWidth||400,t=e.clientHeight||400;F.current.setSize(r,t),L.current&&L.current.setSize(r,t),P.current.aspect=r/t,P.current.updateProjectionMatrix()},[]),Ie=async e=>{if(!(!C.current||!g.current||!U.current)){H.log("Applying modular effects from API data",{planet:e.planet_info.name,type:e.planet_info.type});try{xe();const r=ot(e);U.current.updateBaseColor(r);const t=B.createEffectsFromPythonPlanetData(e,G,C.current,g.current,U.current),s=e.planet_info?.type||e.surface_elements?.planet_type||e.planet_type;if((s==="toxic"||s==="Toxic")&&g.current&&P.current&&F.current)try{const a=lt(g.current,P.current,F.current,G,{planet_type:"toxic",toxic_intensity:.8,atmosphere_thickness:.6},e.seeds?.planet_seed);if(a){L.current=a;const o={id:`effect_toxic_postprocessing_${Date.now()}`,type:"toxic_post_processing",effect:{dispose:()=>a.dispose(),update:n=>a.update(n),updateUniforms:n=>a.update(n),addToScene:()=>{},apply:()=>{}},priority:100,enabled:!0,name:"Toxic Post-Processing (Bloom + Godrays + Chromatic Aberration)"};B.effects.set(o.id,o),t.push(o),H.log("Created toxic post-processing effects")}}catch(a){H.error("Error creating toxic post-processing",a)}else L.current&&(L.current.dispose(),L.current=null);fe(t),J.current=t,z&&z(t),H.log(`Successfully applied ${t.length} modular effects`),Pe()}catch{ie()}}},Xe=i.useCallback(()=>{if(!w.current)return!1;try{for(;w.current.firstChild;)w.current.removeChild(w.current.firstChild);g.current=null,P.current=null,F.current=null,C.current=null,j.current=null;const e=w.current,r=e.clientWidth||p||400,t=e.clientHeight||h||400,s=new mt;s.background=new Ne(1297),g.current=s;const a=new pt(45,r/t,.1,1e4),o=Re();a.position.set(0,0,o),a.lookAt(0,0,0),P.current=a;const n=new nt({antialias:!0,alpha:!0,powerPreference:"high-performance"});return n.setSize(r,t),n.setPixelRatio(Math.min(window.devicePixelRatio,2)),n.shadowMap.enabled=!0,n.shadowMap.type=gt,n.toneMapping=ht,n.toneMappingExposure=1.2,n.outputColorSpace=_t,n.domElement.className="",w.current.appendChild(n.domElement),F.current=n,Je(s,null),Ke(s),E&&et(a,n.domElement),!0}catch{return!1}},[b,M,S]),Qe=e=>{if(!e)return 0;const r=e.sun_angle||e.lighting?.sun_angle;if(r!==void 0)return r;const t=e.timing?.current_orbital_angle||e.timing?.orbital_angle;return t??0},$=i.useRef(null),ye=i.useRef(null),ee=i.useRef(null),j=i.useRef(null),Ze=e=>{e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.camera.left=-10,e.shadow.camera.right=10,e.shadow.camera.top=10,e.shadow.camera.bottom=-10},we=e=>{if(!$.current||!g.current)return;const r=Qe(e),t=10,s=r+Math.PI,a=Math.sin(r)*5,o=t*Math.cos(s),n=a,v=t*Math.sin(s);$.current.position.set(o,n,v),$.current.target.position.set(0,0,0),g.current.children.includes($.current.target)||g.current.add($.current.target),ye.current&&ye.current.position.set(-o*.5,0,-v*.5),U.current&&$.current&&U.current.updateFromThreeLight($.current),$.current&&B.updateLightForAllEffects($.current)},Je=(e,r)=>{{const t=new Oe(16777215,2);t.position.set(-10,5,10),t.target.position.set(0,0,0),t.castShadow=!0,Ze(t),e.add(t),e.add(t.target),$.current=t;const s=new Oe(16777215,.01);s.position.set(8,-3,-5),e.add(s),ye.current=s,setTimeout(()=>{U.current&&t&&U.current.updateFromThreeLight(t),t&&B.updateLightForAllEffects(t)},50);return}},Ke=e=>{const r=new bt(G,128,64),t=new yt({color:8421504}),s=new wt(r,t);s.castShadow=!0,s.receiveShadow=!0,s.position.set(0,0,0),e.add(s),C.current=s;const a=new Ne(8421504);U.current=new ct(s,a),U.current.addToScene(e),P.current&&(T.current=new $e(e,G,P.current,new te(0,0,0),51408e4))},Ae=i.useCallback(e=>{w.current?.getBoundingClientRect()&&(V.current={x:e.clientX,y:e.clientY,time:Date.now()},ae.current=!1)},[]),Te=i.useCallback(e=>{if(!V.current)return;const r=e.clientX-V.current.x,t=e.clientY-V.current.y;Math.sqrt(r*r+t*t)>5&&(ae.current=!0)},[]),je=i.useCallback(e=>{if(!P.current||!g.current||!T.current||!k.current||!V.current)return;const r=Date.now()-V.current.time,t=ae.current;if(V.current=null,ae.current=!1,t||r>500)return;const s=w.current?.getBoundingClientRect();if(!s)return;ge.current.x=(e.clientX-s.left)/s.width*2-1,ge.current.y=-((e.clientY-s.top)/s.height)*2+1,pe.current.setFromCamera(ge.current,P.current);const a=T.current.getMoonAtPosition(pe.current);if(a){_e(a),N&&N(a);const o=T.current.getMoonPosition(a.name);if(o){const n=G*8,v=new te(o.x,o.y+n*.3,o.z+n);Fe(v,o)}}else if(pe.current.intersectObject(C.current||new xt,!0).length>0){_e(null),N&&N(null);const n=new te(0,0,0),v=Re(),D=new te(0,0,v);Fe(D,n)}else _e(null),N&&N(null)},[]),Fe=i.useCallback((e,r)=>{if(!P.current||!k.current)return;const t=P.current,s=k.current;K.current={isAnimating:!0,startPosition:t.position.clone(),startTarget:s.target.clone(),endPosition:e,endTarget:r,startTime:performance.now(),duration:1500},s.enabled=!1},[]),et=(e,r)=>{const t=new st(e,r);t.enableDamping=!0,t.dampingFactor=.05;const s=Re();t.minDistance=s*.5,t.maxDistance=s*2,t.autoRotate=_,t.autoRotateSpeed=.5,t.enablePan=!0,t.enableZoom=!0,t.target.set(0,0,0),k.current=t},tt=i.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{re(!0),Q(null),H.log("Loading planet data from API",{planetName:l});const r=await fetch("/api/planet/rendering-data");if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const t=await r.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const s=t.planet_data,a=t.timing,o=t.rendering_data,n={planet_info:o?.planet_info||{name:s.name,type:s.planet_type,base_color:"#808080",radius:s.diameter/15e3,orbital_radius:s.orbital_radius},surface_elements:o?.surface_elements,atmosphere:o?.atmosphere,rings:o?.rings,moons:o?.moons,effects_3d:o?.effects_3d,shader_uniforms:o?.shader_uniforms,universal_actions:o?.universal_actions,timing:{cosmic_origin_time:a.cosmic_origin_time,current_time_seconds:a.current_time_seconds,elapsed_time:a.elapsed_time,initial_orbital_angle:s.initial_orbital_angle,current_orbital_angle:s.current_orbital_angle,max_orbital_radius:a.max_orbital_radius,system_max_orbital_radius:s.system_max_orbital_radius},original_planet_data:s,seeds:o?.seeds};return Me(n),O.current=n,H.log("API data loaded successfully",{planet:n.planet_info.name,type:n.planet_info.type,hasEffects:!!n.surface_elements,fullRenderingData:o}),we(n),n.moons&&(n.pendingMoonData=n.moons),u&&u(n),n}catch(e){const r=e instanceof Error?e.message:"Unknown error";return Q(r),I&&I(r),null}finally{re(!1),window.isLoadingPlanetData=!1}}},[l,u,I]);i.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{re(!0),Q(null),H.log("Loading planet data from API",{planetName:l});const r=await fetch("/api/planet/rendering-data");if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const t=await r.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const s=t.planet_data,a=t.timing,o=t.rendering_data,n={planet_info:o?.planet_info||{name:s.name,type:s.planet_type,base_color:"#808080",radius:s.diameter/15e3,orbital_radius:s.orbital_radius},surface_elements:o?.surface_elements,atmosphere:o?.atmosphere,rings:o?.rings,moons:o?.moons,effects_3d:o?.effects_3d,shader_uniforms:o?.shader_uniforms,universal_actions:o?.universal_actions,timing:{cosmic_origin_time:a.cosmic_origin_time,current_time_seconds:a.current_time_seconds,elapsed_time:a.elapsed_time,initial_orbital_angle:s.initial_orbital_angle,current_orbital_angle:s.current_orbital_angle,max_orbital_radius:a.max_orbital_radius,system_max_orbital_radius:s.system_max_orbital_radius},original_planet_data:s,seeds:o?.seeds};if(Me(n),O.current=n,H.log("API data loaded successfully",{planet:n.planet_info.name,type:n.planet_info.type,hasEffects:!!n.surface_elements,fullRenderingData:o}),we(n),n.moons){if(!T.current&&P.current&&g.current){const v=n.timing?.cosmic_origin_time||51408e4;T.current=new $e(g.current,G,P.current,new te(0,0,0),v)}if(T.current){const v={...n.moons,cosmic_origin_time:n.timing?.cosmic_origin_time||51408e4,planet_mass:n.original_planet_data?.mass||1e24,planet_radius:G,moons:n.moons.moons.map(D=>({...D,rotation:{rotation_period_s:D.orbit.orbital_period_seconds||86400,rotation_period_hours:(D.orbit.orbital_period_seconds||86400)/3600,angular_velocity_rad_s:2*Math.PI/(D.orbit.orbital_period_seconds||86400),is_tidally_locked:!0}}))};T.current.loadMoonSystem(v)}}j.current&&g.current&&(g.current.remove(j.current),j.current.geometry.dispose(),j.current.material.dispose(),j.current=null),await Ie(n),u&&u(n)}catch(e){const r=e instanceof Error?e.message:"Unknown error";Q(r),I&&I(r),ie()}finally{re(!1),window.isLoadingPlanetData=!1}}},[l,M,S,m]);const ke=i.useCallback(()=>{if(!b||!C.current)return;const e=M?.orbital_period_seconds||365.25*24*3600,r=2*Math.PI/e,t=b.timing?.initial_orbital_angle||0,s=Date.now()/1e3,a=0,o=S||b.timing?.cosmic_origin_time||Date.now()/1e3-3600,n=s-o+a,v=(t+n*r)%(2*Math.PI),D=b.timing?.max_orbital_radius||100,d=20+b.planet_info?.orbital_radius/D*80,y=d,A=d*Math.cos(v),Y=y*Math.sin(v);C.current.position.x=A,C.current.position.z=Y,C.current.position.y=0},[b,M,S]),rt=i.useCallback(async e=>{const r=e||b;if(r&&g.current)try{we(r),j.current&&g.current&&(g.current.remove(j.current),j.current.geometry.dispose(),j.current.material.dispose(),j.current=null),await Ie(r)}catch{ie()}},[b]),ie=()=>{if(!(!g.current||!C.current)){H.warn("Applying fallback effects for planet type:",M?.planet_type);try{xe(),C.current.material instanceof Pt&&C.current.material.color.setHex(6710886);try{const e=it("generic"),r=B.createEffectsFromList(e,G,C.current);r.forEach(t=>{t.effect.addToScene&&g.current&&C.current&&t.effect.addToScene(g.current,C.current.position)}),J.current=r,fe(r)}catch{}Pe()}catch{}}},xe=()=>{J.current.forEach(e=>{try{B.removeEffect(e.id),e.effect.dispose&&e.effect.dispose()}catch{}}),L.current&&(L.current.dispose(),L.current=null),J.current=[],fe([])},Le=i.useCallback(()=>{le.current=requestAnimationFrame(Le);const e=performance.now(),r=Ge.current.getDelta();if(K.current?.isAnimating&&P.current&&k.current){const a=K.current,o=e-a.startTime,n=Math.min(o/a.duration,1),D=(y=>y<.5?4*y*y*y:(y-1)*(2*y-2)*(2*y-2)+1)(n),R=P.current,d=k.current;R.position.lerpVectors(a.startPosition,a.endPosition,D),d.target.lerpVectors(a.startTarget,a.endTarget,D),R.lookAt(d.target),d.update(),n>=1&&(K.current.isAnimating=!1,d.enabled=!0,K.current=null)}else k.current&&k.current.update();try{B.updateAllEffects(r,C.current?.rotation.y,P.current||void 0)}catch{}if(C.current&&O.current){O.current.planet_info?.name;const a=O.current.original_planet_data,o=a?.orbital_period_seconds||365.25*24*3600,n=O.current.timing?.initial_orbital_angle||0;S||O.current.timing?.cosmic_origin_time||Date.now()/1e3-3600;const v=a?.axial_tilt||0,D=2*Math.PI/o;(n+ue.current*D)%(2*Math.PI);const R=O.current.timing?.max_orbital_radius||O.current.timing?.system_max_orbital_radius,d=a?.orbital_radius;if(!R||!d)return;a?.eccentricity_factor,C.current.position.set(0,0,0);const y=a?.rotation_period_seconds||86400,A=2*Math.PI/y;C.current.rotation.y=ue.current*A%(2*Math.PI),C.current.rotation.z=v*(Math.PI/180)}J.current.forEach(a=>{a.effect.updateUniforms&&a.effect.updateUniforms(r)});const s=Array.from(B.effects.values()).find(a=>a.type==="toxic_post_processing")?.enabled||!1;if(L.current&&s&&(L.current.update(r),$.current&&L.current.updateLightPosition($.current.position,P.current)),F.current&&g.current&&P.current){T.current&&T.current.update();const a=performance.now();L.current&&s?L.current.render():F.current.render(g.current,P.current);const o=performance.now()-a;if(e-me.current>5e3){const n=1e3/(e-me.current);Pe(),de(v=>({...v,frameRate:Math.round(n),renderTime:Math.round(o*100)/100})),me.current=e}}},[]),Pe=i.useCallback(()=>{const e=B.getStats();de(r=>({...r,activeEffects:e.activeEffects,enabledEffects:e.enabledEffects}))},[]);return i.useEffect(()=>{let e=!0;return(async()=>{try{if(!e)return;const t=await tt();if(!e)return;if(!Xe()){e&&Q("Failed to initialize 3D renderer");return}if(!e||(Le(),w.current&&"ResizeObserver"in window&&(se.current=new ResizeObserver(be),se.current.observe(w.current)),window.addEventListener("resize",be),w.current&&(w.current.addEventListener("mousedown",Ae),w.current.addEventListener("mousemove",Te),w.current.addEventListener("click",je)),!e))return;t?await rt(t):ie()}catch(t){e&&Q(t instanceof Error?t.message:"Unknown initialization error")}})(),()=>{if(e=!1,O.current=null,le.current&&cancelAnimationFrame(le.current),se.current&&se.current.disconnect(),window.removeEventListener("resize",be),w.current&&(w.current.removeEventListener("mousedown",Ae),w.current.removeEventListener("mousemove",Te),w.current.removeEventListener("click",je)),xe(),U.current&&(U.current.dispose(),U.current=null),T.current&&(T.current.dispose(),T.current=null),k.current&&k.current.dispose(),ee.current&&g.current&&(g.current.remove(ee.current),ee.current.geometry.dispose(),ee.current.material.dispose(),ee.current=null),j.current&&g.current&&(g.current.remove(j.current),j.current.geometry.dispose(),j.current.material.dispose(),j.current=null),F.current&&w.current)try{w.current.contains(F.current.domElement)&&w.current.removeChild(F.current.domElement),F.current.dispose()}catch{}}},[]),i.useEffect(()=>{const e=setInterval(()=>{const r=B.getStats();de(t=>({...t,activeEffects:r.activeEffects,enabledEffects:r.enabledEffects}))},1e4);return()=>clearInterval(e)},[]),i.useEffect(()=>{b&&g.current&&C.current&&ke()},[b,ke]),i.useEffect(()=>{if(b&&b.pendingMoonData&&T.current){const e=b.pendingMoonData,r={...e,cosmic_origin_time:b.timing?.cosmic_origin_time||51408e4,planet_mass:b.original_planet_data?.mass||1e24,planet_radius:G,moons:e.moons.map(t=>({...t,rotation:{rotation_period_s:t.orbit.orbital_period_seconds||86400,rotation_period_hours:(t.orbit.orbital_period_seconds||86400)/3600,angular_velocity_rad_s:2*Math.PI/(t.orbit.orbital_period_seconds||86400),is_tidally_locked:!0}}))};T.current.loadMoonSystem(r),delete b.pendingMoonData}},[b,T.current]),Dt(b),c.jsxs("div",{className:`relative ${f}`,children:[x&&b&&c.jsx(Mt,{planetData:b,showInPage:!0,showInConsole:!0}),c.jsx("div",{ref:w,className:"w-full h-full",style:{minHeight:"300px",aspectRatio:"1"}}),c.jsx(St,{isVisible:he}),Ce&&c.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-50",children:c.jsxs("div",{className:"text-white text-center",children:[c.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"}),c.jsx("div",{children:"Loading planet..."})]})}),Se&&c.jsxs("div",{className:"absolute top-0 left-0 right-0 p-2 bg-red-500 text-white text-sm",children:[c.jsx("strong",{children:"Error:"})," ",Se]}),b&&!Ce&&c.jsxs("div",{className:"absolute bottom-0 left-0 p-2 text-white bg-black bg-opacity-50 max-w-xs rounded-tr-lg",children:[c.jsx("h3",{className:"text-xs font-bold",children:b.planet_info.name}),b.moons&&c.jsxs("div",{className:"text-xs mt-1",children:["Moons: ",b.moons.count]})]}),x&&c.jsxs("div",{className:"absolute top-0 right-0 p-4 text-white bg-black bg-opacity-70 text-xs font-mono",children:[c.jsx("h4",{className:"font-bold mb-2",children:"Debug Info"}),c.jsxs("div",{children:["Frame Rate: ",ne.frameRate," FPS"]}),c.jsxs("div",{children:["Render Time: ",ne.renderTime,"ms"]}),c.jsxs("div",{children:["Active Effects: ",ne.activeEffects]}),c.jsxs("div",{children:["Enabled Effects: ",ne.enabledEffects]}),c.jsxs("div",{className:"mt-2",children:[c.jsx("div",{className:"font-semibold",children:"Effects:"}),We.map(e=>c.jsxs("div",{className:"ml-2",children:[e.type," (",e.enabled?"ON":"OFF",")"]},e.id))]})]})]})});class At extends i.Component{constructor(f){super(f),this.state={hasError:!1,error:null}}static getDerivedStateFromError(f){return{hasError:!0,error:f.message}}componentDidCatch(f,p){}render(){return this.state.hasError?c.jsx("div",{className:"flex items-center justify-center w-full h-full bg-gray-900/50 rounded",children:c.jsxs("div",{className:"text-center p-4",children:[c.jsx("div",{className:"text-red-400 text-sm mb-2",children:"3D Renderer Error"}),c.jsx("div",{className:"text-xs text-gray-400",children:this.state.error})]})}):this.props.children}}const Ht=i.forwardRef((l,f)=>c.jsx(At,{children:c.jsx(It,{ref:f,...l})}));export{St as E,Ht as M,ce as S,Ct as a,Et as b};
