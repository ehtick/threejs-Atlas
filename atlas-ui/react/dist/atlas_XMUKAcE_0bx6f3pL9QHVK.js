import{j as c,r as i}from"./atlas_BG-O7ORrd1CIuvq6sOIEu.js";import{W as It}from"./atlas_VMw0cJKPlPEHKRP927cEp.js";import{O as Dt}from"./atlas_DcNBpw2oKtwvZQEHQs4H7.js";import{Q as Tt}from"./atlas_DTMHG0KBmlmtp0V4aoQDq.js";import{E as At}from"./atlas_CnuOWFZeVlXS2g8AY7C7C.js";import{E as ne,c as Ft}from"./atlas_C0hstbgC64R4Zd81BzUVj.js";import{g as Lt}from"./atlas_DKx8078aWX3rJjjGj5Axe.js";import{P as jt}from"./atlas_B2-pJMNWYXxyj-B-RssSJ.js";import{M as st}from"./atlas_DNN6G5x7TLhEbIgPQWiHn.js";import{c as kt}from"./atlas_DTVfYL1QSwUOVvlArN5hQ.js";import{s as at}from"./atlas_D5TkNrZ-UIh1OV1m_7qMi.js";import{a4 as zt,a5 as Ot,f as Ut,a6 as Nt,C as it,a7 as Bt,a8 as $t,a9 as Gt,aa as Wt,ab as ot,b as ct,y as lt,M as ut,V as se,ac as ft,ad as Ht,m as Vt,B as Yt,a3 as qt,o as Qt,a as Xt}from"./atlas_Bd-08EnGHvuA4jxvJ1T-8.js";class Zt{static isRemoteUniverse(){try{const n=document.getElementById("data-universe-config");return n?JSON.parse(n.textContent||"{}").remote===!0:!1}catch(n){return console.error("Error checking universe type:",n),!1}}static getUniverseConfig(){try{const n=document.getElementById("data-universe-config");return n?JSON.parse(n.textContent||"{}"):null}catch(n){return console.error("Error parsing universe config:",n),null}}}class Me{static encodeUrl(n){return btoa(n).replace(/\+/g,"-").replace(/\//g,"_")}static generateGalaxyUrl(n,m=1){const h=`coordinates=${n[0]},${n[1]},${n[2]}&page=${m}`;return`/stargate/${this.encodeUrl(h)}`}static generateSystemUrl(n,m,h){const _=`coordinates=${n[0]},${n[1]},${n[2]}&system=${m}`;return`/stargate/${this.encodeUrl(_)}`}static generatePlanetUrl(n,m,h,_){const P=`coordinates=${n[0]},${n[1]},${n[2]}&system=${m}&planet=${h.toLowerCase()}`;return`/stargate/${this.encodeUrl(P)}`}static getCurrentPage(){try{const m=new URLSearchParams(window.location.search).get("page");if(m)return parseInt(m,10);const h=window.location.pathname.match(/\/galaxy\/(\d+)/);return h?parseInt(h[1],10):1}catch{return 1}}}const Jt=(a,n)=>{try{const m=a.split("/stargate/")[1];if(!m)return null;const h=atob(m.replace(/-/g,"+").replace(/_/g,"/")),_=new URLSearchParams(h),P=_.get("coordinates"),x=_.get("system"),S=_.get("planet");if(!P)return null;const I={type:n,coordinates:P};return x&&(I.systemIndex=parseInt(x)),S&&(I.planetName=S),I}catch{return null}},dt=a=>{try{const n=a.coordinates.split(",").map(Number),m=Me.getCurrentPage();let h;switch(a.type){case"galaxy":h=Me.generateGalaxyUrl(n,m);break;case"system":if(a.systemIndex!==void 0)h=Me.generateSystemUrl(n,a.systemIndex,m);else return window.location.href;break;case"planet":if(a.systemIndex!==void 0&&a.planetName)h=Me.generatePlanetUrl(n,a.systemIndex,a.planetName,m);else return window.location.href;break;default:return window.location.href}return`${window.location.origin}${h}`}catch{return window.location.href}},Kt=async a=>{const{url:n,size:m}=a;return new Promise((h,_)=>{const P=document.createElement("canvas"),x=m,S=Math.floor(m*.8);Tt.toCanvas(P,n,{width:S,margin:0,color:{dark:"#000000",light:"#FFFFFF"},errorCorrectionLevel:"H"},I=>{if(I){_(I);return}const d=document.createElement("canvas"),l=d.getContext("2d"),k=Math.floor(x*.17);if(d.width=x,d.height=x+k,l){const U=Math.floor(x*.1);l.fillStyle="#FFFFFF",l.beginPath(),l.roundRect(0,0,d.width,d.height,U),l.fill();const Q=(x-S)/2;l.drawImage(P,Q,Q),l.fillStyle="#000000",l.font=`bold ${Math.floor(x*.13)}px Arial`,l.textAlign="center",l.textBaseline="middle",l.fillText("VIEW IT LIVE",x/2,x+k*.2),h(d)}})})},er=async(a,n,m,h)=>{try{if(Zt.isRemoteUniverse())return;let _;if("coordinates"in h)_=dt(h);else{const l=Jt(h.stargateUrl,h.type);l?_=dt(l):_=h.stargateUrl}if(_.startsWith("http://localhost/"))try{const k=await(await fetch("/api/universe/config")).json(),U=45156749731585371360938718175484539659389209313560548011495000289036640085049n,Q=4515674973158537e61,X=k.config_seed;(X===Q||X===U||BigInt(X)===U)&&(_=_.replace("http://localhost/","https://the-atlas.koyeb.app/"))}catch(l){console.warn("Failed to check config seed:",l)}const P=Math.floor(n/8),x=await Kt({url:_,size:P}),S=Math.floor(n/100),I=n-x.width-S,d=m-x.height-S;a.drawImage(x,I,d)}catch(_){console.warn("Failed to generate QR code:",_)}},tr=(a,n)=>{const{imageWidth:m,imageHeight:h,startYear:_=2023,companyName:P="Banshee",opacity:x=.5,fontSize:S}=n,I=new Date().getFullYear(),d=I===_?`${_}`:`${_}-${I}`,l=`The Atlas Â© Copyright ${P} â€¢ ${d}`;a.fillStyle=`rgba(255, 255, 255, ${x})`;const k=S||Math.floor(m/80);a.font=`${k}px Arial`,a.textAlign="left",a.textBaseline="bottom";const U=Math.floor(m/100);a.fillText(l,U,h-U)},rr=({isVisible:a,message:n="Exporting view, please wait..."})=>c.jsxs("div",{className:`absolute inset-0 bg-black flex flex-col items-center justify-center z-10 transition-all duration-300 ${a?"opacity-100 visible":"opacity-0 invisible"}`,children:[c.jsx("div",{className:"w-16 h-16 border-4 border-white/20 border-t-white rounded-full animate-spin mb-6"}),c.jsx("p",{className:"text-white text-xl font-medium text-center px-4",children:n})]}),nr=({planetData:a,showInConsole:n=!0,showInPage:m=!1})=>{const[h,_]=i.useState([]),[P,x]=i.useState({});i.useEffect(()=>{if(!a)return;const d=S(a);x(d),_(I(a)),typeof window<"u"&&(window.__DEBUG_PLANET_DATA=a,window.__DEBUG_PLANET_ANALYSIS=d)},[a,n]);function S(d){const l={hasValidStructure:!1,missingFields:[],dataIntegrity:"unknown",renderingIssues:[],colorConsistency:"unknown"};if(d.planet_info&&d.surface_elements?l.hasValidStructure=!0:(d.planet_info||l.missingFields.push("planet_info"),d.surface_elements||l.missingFields.push("surface_elements")),d.surface_elements?.type==="oceanic"&&(l.oceanicData={hasAbstractLands:!!d.surface_elements.abstract_lands?.length,numGreenPatches:d.surface_elements.green_patches?.length||0,numClouds:d.surface_elements.clouds?.length||0,hasDepths:d.surface_elements.depths?.enabled||!1,baseColorIsBlue:d.planet_info?.base_color==="#0000FF",greenPatchColor:d.surface_elements.green_patches?.[0]?.color,issues:[]},l.oceanicData.numGreenPatches>15&&l.oceanicData.issues.push("Muchos parches verdes pueden ocultar el ocÃ©ano azul"),l.oceanicData.baseColorIsBlue||l.oceanicData.issues.push(`Color base no es azul puro: ${d.planet_info?.base_color}`),l.renderingIssues=l.oceanicData.issues),d.planet_info?.base_color&&d.planet_info?.type){const U={Oceanic:"#0000FF",Rocky:"#808080",Icy:"#ADD8E6",Desert:"#FFD700",Lava:"#FF0000"}[d.planet_info.type];U&&d.planet_info.base_color!==U?l.colorConsistency=`Inconsistente: esperado ${U}, recibido ${d.planet_info.base_color}`:l.colorConsistency="Correcto"}return l}function I(d){const l=[];if(!d.surface_elements?.type)return["No surface type defined"];const k=d.surface_elements.type.toLowerCase();switch(k){case"oceanic":l.push("OceanWavesEffect (PROBLEMA: ignora green_patches de Python)");break;case"rocky":l.push("RockyTerrainEffect");break;case"icy":l.push("IcyTerrainEffect");break;case"gas giant":l.push("GasGiantBandsEffect");break;default:l.push(`Generic effect for type: ${k}`)}return d.atmosphere?.density>0&&l.push("AtmosphericEffect"),d.rings&&l.push("RingSystemEffect"),l}return m?c.jsxs("div",{style:{position:"fixed",top:10,right:10,background:"rgba(0, 0, 0, 0.9)",color:"#00ff00",padding:"10px",borderRadius:"5px",fontFamily:"monospace",fontSize:"12px",maxWidth:"400px",maxHeight:"600px",overflow:"auto",zIndex:1e4,border:"1px solid #00ff00"},children:[c.jsxs("h3",{style:{margin:"0 0 10px 0",color:"#00ff00"},children:["ðŸ” Planet Debug: ",a.planet_info?.name]}),c.jsxs("div",{style:{marginBottom:"10px"},children:[c.jsx("strong",{children:"Type:"})," ",a.planet_info?.type,c.jsx("br",{}),c.jsx("strong",{children:"Base Color:"})," ",a.planet_info?.base_color,c.jsx("br",{}),c.jsx("strong",{children:"Radius:"})," ",a.planet_info?.radius]}),a.surface_elements?.type==="oceanic"&&c.jsxs("div",{style:{marginBottom:"10px",borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[c.jsx("strong",{children:"ðŸŒŠ Oceanic Data:"}),c.jsx("br",{}),c.jsxs("span",{style:{color:P.oceanicData?.baseColorIsBlue?"#00ff00":"#ff0000"},children:["Base Color: ",P.oceanicData?.baseColorIsBlue?"âœ“ Blue":"âœ— Not Blue"]}),c.jsx("br",{}),"Green Patches: ",P.oceanicData?.numGreenPatches,c.jsx("br",{}),"Clouds: ",P.oceanicData?.numClouds,c.jsx("br",{}),"Has Depths: ",P.oceanicData?.hasDepths?"Yes":"No",c.jsx("br",{}),P.oceanicData?.issues?.length>0&&c.jsxs("div",{style:{color:"#ffaa00",marginTop:"5px"},children:["âš ï¸ Issues:",c.jsx("br",{}),P.oceanicData.issues.map((d,l)=>c.jsxs("div",{children:["- ",d]},l))]})]}),c.jsxs("div",{style:{borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[c.jsx("strong",{children:"ðŸŽ¨ Effects Applied:"}),c.jsx("br",{}),h.map((d,l)=>c.jsxs("div",{style:{color:d.includes("PROBLEMA")?"#ff0000":"#00ff00"},children:["- ",d]},l))]}),c.jsx("button",{style:{marginTop:"10px",background:"#00ff00",color:"#000",border:"none",padding:"5px 10px",cursor:"pointer",borderRadius:"3px"},children:"Log to Console"})]}):null};function sr(a){i.useEffect(()=>{if(a&&a.surface_elements?.type==="oceanic"){a.surface_elements.green_patches?.length>0;const n=a.planet_info?.base_color;n!=="#0000FF"&&console.warn("âš ï¸ Planeta oceÃ¡nico sin color azul base!",n)}},[a])}const V=2.5,Ce=()=>{const a=45*Math.PI/180;return V/(Math.tan(a/2)*.5)},mt=a=>{let n=0;for(let m=0;m<a.length;m++)n=(n<<5)-n+a.charCodeAt(m),n=n&n;return Math.abs(n)%1e4/1e4*.15},pt=a=>{let n=0;for(let m=0;m<a.length;m++)n=(n<<3)-n+a.charCodeAt(m)*7,n=n&n;return Math.abs(n)%1e4/1e4*Math.PI*2},gt=(a,n,m,h,_)=>{const P=n*(1-m*m)/(1+m*Math.cos(a)),x=P*Math.cos(a),S=P*Math.sin(a),I=x*Math.cos(_)-S*Math.sin(_)*Math.cos(h),d=x*Math.sin(_)+S*Math.cos(_)*Math.cos(h),l=S*Math.sin(h);return new se(I,l,d)},ht={"Red Dwarf":1,"Yellow Dwarf":2,"Blue Giant":8,"Red Giant":3,"White Dwarf":2.5,"Neutron Star":1.5},ar=i.forwardRef(({planetName:a,containerClassName:n="",width:m=800,height:h=600,autoRotate:_=!0,enableControls:P=!0,showDebugInfo:x=!1,planetData:S,cosmicOriginTime:I,initialAngleRotation:d,timeOffset:l=0,onDataLoaded:k,onEffectsCreated:U,onError:Q,onMoonSelected:X,planetUrl:Se},_t)=>{const v=i.useRef(null),g=i.useRef(null),N=i.useRef(null),R=i.useRef(null),D=i.useRef(null),F=i.useRef(null),yt=i.useRef(new zt),Ie=i.useRef(null),ge=i.useRef(0),Z=i.useRef(null),De=i.useRef(l),[Ve,we]=i.useState(!0),[Ye,le]=i.useState(null),[M,qe]=i.useState(null),[bt,Te]=i.useState([]),[xe,wt]=i.useState(!1),[Pe,Ae]=i.useState({activeEffects:0,enabledEffects:0,frameRate:0,renderTime:0}),he=i.useRef([]),G=i.useRef(new At),Fe=i.useRef(0),ve=i.useRef(null),B=i.useRef(null),L=i.useRef(null),$=i.useRef(null),Le=i.useRef(new Ot),je=i.useRef(new Ut),ae=i.useRef(null),Ee=i.useRef(!1),[ke,Qe]=i.useState(!1),[or,ze]=i.useState(null),_e=i.useRef(null);i.useImperativeHandle(_t,()=>({captureScreenshot:()=>{if(!N.current||!g.current||!R.current||ke)return;Qe(!0),F.current&&(F.current.enabled=!1);const e=N.current,s=g.current,t=R.current,o=e.domElement.width,p=e.domElement.height,u=3840/o,r=[];s.traverse(w=>{if(w.isPoints&&w.material){const f=w.material;if(f.size!==void 0){r.push({material:f,originalSize:f.size});const C=f.isPulsatingCubeParticle===!0?u*.3:u*1;f.size=f.size*C}if(f.uniforms){const C=f.isPulsatingCubeParticle===!0?u*.3:u*1;f.uniforms.size&&(r.push({material:f,uniform:"size",originalValue:f.uniforms.size.value}),f.uniforms.size.value=f.uniforms.size.value*C),f.uniforms.scale&&(r.push({material:f,uniform:"scale",originalValue:f.uniforms.scale.value}),f.uniforms.scale.value=f.uniforms.scale.value*C)}if(w.geometry&&w.geometry.attributes.size){const E=w.geometry.attributes.size,C=E.array.slice();r.push({geometry:w.geometry,originalSizeArray:C});const H=f.isPulsatingCubeParticle===!0?u*.3:u*1;for(let A=0;A<E.array.length;A++)E.array[A]*=H;E.needsUpdate=!0}}if(w.isSprite&&(r.push({object:w,originalScale:w.scale.clone()}),w.scale.multiplyScalar(u*1)),w.isLine&&w.material){const f=w.material;f.linewidth!==void 0&&(r.push({material:f,originalLinewidth:f.linewidth}),f.linewidth=f.linewidth*u*1)}});const y=3840,b=3840;e.setSize(y,b),t.aspect=1,t.updateProjectionMatrix(),e.render(s,t),e.domElement.toBlob(w=>{if(w){const f=document.createElement("canvas"),E=f.getContext("2d");if(f.width=y,f.height=b,E){const C=new Image;C.onload=async()=>{E.drawImage(C,0,0),tr(E,{imageWidth:y,imageHeight:b}),Se&&await er(E,y,b,{type:"planet",stargateUrl:Se}),f.toBlob(H=>{if(H){const A=URL.createObjectURL(H),J=document.createElement("a");J.href=A,J.download=`planet_${a}_${Date.now()}.jpg`,J.click(),URL.revokeObjectURL(A)}},"image/jpeg",1)};const T=URL.createObjectURL(w);C.src=T}}r.forEach(({material:f,object:E,originalSize:C,originalScale:T,originalLinewidth:H,uniform:A,originalValue:J,geometry:ue,originalSizeArray:Y})=>{if(C!==void 0&&(f.size=C),T!==void 0&&E.scale.copy(T),H!==void 0&&(f.linewidth=H),A&&J!==void 0&&(f.uniforms[A].value=J),ue&&Y){const K=ue.attributes.size;for(let te=0;te<Y.length;te++)K.array[te]=Y[te];K.needsUpdate=!0}}),e.setSize(o,p),t.aspect=o/p,t.updateProjectionMatrix(),F.current&&(F.current.enabled=!0),Qe(!1)},"image/jpeg",1)},isGeneratingImage:ke,toggleEffect:(e,s)=>{G.current.toggleEffect(e,s)}}));const Oe=i.useCallback(()=>{if(!v.current||!N.current||!R.current)return;const e=v.current,s=e.clientWidth||400,t=e.clientHeight||400;N.current.setSize(s,t),$.current&&$.current.setSize(s,t),R.current.aspect=s/t,R.current.updateProjectionMatrix()},[]),Xe=async e=>{if(!(!D.current||!g.current||!B.current)){ne.log("Applying modular effects from API data",{planet:e.planet_info.name,type:e.planet_info.type});try{Be();const s=Lt(e);B.current.updateBaseColor(s);const t=G.current.createEffectsFromPythonPlanetData(e,V,D.current,g.current,B.current),o=e.planet_info?.type||e.surface_elements?.planet_type||e.planet_type;if((o==="toxic"||o==="Toxic")&&g.current&&R.current&&N.current)try{const p=kt(g.current,R.current,N.current,V,{planet_type:"toxic",toxic_intensity:.8,atmosphere_thickness:.6},e.seeds?.planet_seed);if(p){$.current=p;const u={id:`effect_toxic_postprocessing_${Date.now()}`,type:"toxic_post_processing",effect:{dispose:()=>p.dispose(),update:r=>p.update(r),updateUniforms:r=>p.update(r),addToScene:()=>{},apply:()=>{}},priority:100,enabled:!0,name:"Toxic Post-Processing (Bloom + Godrays + Chromatic Aberration)"};G.current.effects.set(u.id,u),t.push(u),ne.log("Created toxic post-processing effects")}}catch(p){ne.error("Error creating toxic post-processing",p)}else $.current&&($.current.dispose(),$.current=null);Te(t),he.current=t,U&&U(t),ne.log(`Successfully applied ${t.length} modular effects`),$e()}catch{Re()}}},xt=i.useCallback(()=>{if(!v.current)return!1;try{for(;v.current.firstChild;)v.current.removeChild(v.current.firstChild);g.current=null,R.current=null,N.current=null,D.current=null,z.current=null;const e=v.current,s=e.clientWidth||m||400,t=e.clientHeight||h||400,o=new Nt;o.background=new it(1297),g.current=o;const p=new Bt(45,s/t,.1,1e4),u=Ce();p.position.set(0,0,u),p.lookAt(0,0,0),R.current=p;const r=new It({antialias:!0,alpha:!0,powerPreference:"high-performance"});return r.setSize(s,t),r.setPixelRatio(Math.min(window.devicePixelRatio,2)),r.shadowMap.enabled=!0,r.shadowMap.type=$t,r.toneMapping=Gt,r.toneMappingExposure=1.2,r.outputColorSpace=Wt,r.domElement.className="",v.current.appendChild(r.domElement),N.current=r,vt(o,null),Et(o),P&&Rt(p,r.domElement),!0}catch{return!1}},[M,S,I]),j=i.useRef([]),Ze=i.useRef([]),Ue=i.useRef(null),ye=i.useRef(null),z=i.useRef(null),O=i.useRef(null),Pt=e=>{e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.camera.left=-10,e.shadow.camera.right=10,e.shadow.camera.top=10,e.shadow.camera.bottom=-10},Ne=e=>{if(j.current.length===0||!g.current)return;const s=e?.original_planet_data||e,t=s?.initial_orbital_angle||0,o=s?.orbital_period_seconds||365.25*24*3600,p=2*Math.PI/o,u=(t+ge.current*p)%(2*Math.PI),r=e?.planet_info?.name||e?.name||e?.original_planet_data?.name||"unknown_planet",y=s?.eccentricity_factor||.1,b=mt(r),w=pt(r),f=e?.planet_info?.orbital_radius||s?.orbital_radius||1,E=e?.timing?.max_orbital_radius||s?.system_max_orbital_radius||1,H=20+f/E*80,A=gt(u,H,y,b,w),J=Math.sqrt(A.x**2+A.y**2+A.z**2),ue=200;j.current.forEach((Y,K)=>{const te=Ze.current[K],fe=new se(-A.x,-A.y,-A.z);if(K>0){const de=K*30;fe.x+=de*Math.cos(K),fe.z+=de*Math.sin(K)}fe.normalize();const Ge=fe.multiplyScalar(ue);if(te){const de=te.Type||"Yellow Dwarf",be=(ht[de]||2)*300/(J*J),me=Math.min(3,Math.max(.05,be));Y.intensity=me}Y.position.copy(Ge),Y.target.position.set(0,0,0),g.current.children.includes(Y.target)||g.current.add(Y.target)}),Ue.current&&Ue.current.position.set(A.x*.5,0,A.z*.5),B.current&&j.current[0]&&B.current.updateFromThreeLight(j.current[0]),j.current[0]&&G.current.updateLightForAllEffects(j.current[0])},vt=(e,s)=>{{const t=new ot(16777215,2);t.position.set(-10,5,10),t.target.position.set(0,0,0),t.castShadow=!0,Pt(t),e.add(t),e.add(t.target),j.current=[t];const o=new ot(16777215,.01);o.position.set(8,-3,-5),e.add(o),Ue.current=o,setTimeout(()=>{B.current&&t&&B.current.updateFromThreeLight(t),t&&G.current.updateLightForAllEffects(t)},50);return}},Et=e=>{const s=new ct(V,128,64),t=new lt({color:8421504}),o=new ut(s,t);o.castShadow=!0,o.receiveShadow=!0,o.position.set(0,0,0),e.add(o),D.current=o;const p=new it(8421504);B.current=new jt(o,p),B.current.addToScene(e),R.current&&(L.current=new st(e,V,R.current,new se(0,0,0),51408e4));const u=new ft(20);u.visible=!1,e.add(u)},Je=i.useCallback(e=>{v.current?.getBoundingClientRect()&&(ae.current={x:e.clientX,y:e.clientY,time:Date.now()},Ee.current=!1)},[]),Ke=i.useCallback(e=>{if(!ae.current)return;const s=e.clientX-ae.current.x,t=e.clientY-ae.current.y;Math.sqrt(s*s+t*t)>5&&(Ee.current=!0)},[]),et=i.useCallback(e=>{if(!R.current||!g.current||!L.current||!F.current||!ae.current)return;const s=Date.now()-ae.current.time,t=Ee.current;if(ae.current=null,Ee.current=!1,t||s>500)return;const o=v.current?.getBoundingClientRect();if(!o)return;je.current.x=(e.clientX-o.left)/o.width*2-1,je.current.y=-((e.clientY-o.top)/o.height)*2+1,Le.current.setFromCamera(je.current,R.current);const p=L.current.getMoonAtPosition(Le.current);if(p){ze(p),X&&X(p);const u=p.visuals?.relative_size||.1,r=V*u,y=Math.max(r*3,V*.15);F.current&&(F.current.minDistance=y);const b=L.current.getMoonPosition(p.name);if(b){const w=Math.max(r*6,V*.5),f=b.clone().normalize(),E=b.clone().add(f.multiplyScalar(w));tt(E,b)}}else{const u=Le.current.intersectObject(D.current||new Ht,!0);if(F.current){const r=Ce();F.current.minDistance=r*.5}if(u.length>0){ze(null),X&&X(null);const r=new se(0,0,0),y=Ce(),b=new se(0,0,y);tt(b,r)}else ze(null),X&&X(null)}},[]),tt=i.useCallback((e,s)=>{if(!R.current||!F.current)return;const t=R.current,o=F.current;_e.current={isAnimating:!0,startPosition:t.position.clone(),startTarget:o.target.clone(),endPosition:e,endTarget:s,startTime:performance.now(),duration:1500},o.enabled=!1},[]),Rt=(e,s)=>{const t=new Dt(e,s);t.enableDamping=!0,t.dampingFactor=.05;const o=Ce();t.minDistance=o*.5,t.maxDistance=o*2,t.autoRotate=_,t.autoRotateSpeed=.5,t.enablePan=!0,t.enableZoom=!0,t.target.set(0,0,0),F.current=t},Mt=i.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{we(!0),le(null),ne.log("Loading planet data from API",{planetName:a});const s=await fetch("/api/planet/rendering-data");if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const t=await s.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const o=t.planet_data,p=t.timing,u=t.rendering_data,r={planet_info:u?.planet_info||{name:o.name,type:o.planet_type,base_color:"#808080",radius:o.diameter/15e3,orbital_radius:o.orbital_radius},surface_elements:u?.surface_elements,atmosphere:u?.atmosphere,rings:u?.rings,moons:u?.moons,effects_3d:u?.effects_3d,shader_uniforms:u?.shader_uniforms,universal_actions:u?.universal_actions,timing:{cosmic_origin_time:p.cosmic_origin_time,current_time_seconds:p.current_time_seconds,elapsed_time:p.elapsed_time,initial_orbital_angle:o.initial_orbital_angle,current_orbital_angle:o.current_orbital_angle,max_orbital_radius:p.max_orbital_radius,system_max_orbital_radius:o.system_max_orbital_radius},original_planet_data:o,seeds:u?.seeds};return qe(r),Z.current=r,ne.log("API data loaded successfully",{planet:r.planet_info.name,type:r.planet_info.type,hasEffects:!!r.surface_elements,fullRenderingData:u}),Ne(r),r.moons&&(r.pendingMoonData=r.moons),k&&k(r),r}catch(e){const s=e instanceof Error?e.message:"Unknown error";return le(s),Q&&Q(s),null}finally{we(!1),window.isLoadingPlanetData=!1}}},[a,k,Q]);i.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{we(!0),le(null),ne.log("Loading planet data from API",{planetName:a});const s=await fetch("/api/planet/rendering-data");if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const t=await s.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const o=t.planet_data,p=t.timing,u=t.rendering_data,r={planet_info:u?.planet_info||{name:o.name,type:o.planet_type,base_color:"#808080",radius:o.diameter/15e3,orbital_radius:o.orbital_radius},surface_elements:u?.surface_elements,atmosphere:u?.atmosphere,rings:u?.rings,moons:u?.moons,effects_3d:u?.effects_3d,shader_uniforms:u?.shader_uniforms,universal_actions:u?.universal_actions,timing:{cosmic_origin_time:p.cosmic_origin_time,current_time_seconds:p.current_time_seconds,elapsed_time:p.elapsed_time,initial_orbital_angle:o.initial_orbital_angle,current_orbital_angle:o.current_orbital_angle,max_orbital_radius:p.max_orbital_radius,system_max_orbital_radius:o.system_max_orbital_radius},original_planet_data:o,seeds:u?.seeds};if(qe(r),Z.current=r,ne.log("API data loaded successfully",{planet:r.planet_info.name,type:r.planet_info.type,hasEffects:!!r.surface_elements,fullRenderingData:u}),Ne(r),r.moons){if(!L.current&&R.current&&g.current){const y=r.timing?.cosmic_origin_time||51408e4;L.current=new st(g.current,V,R.current,new se(0,0,0),y)}if(L.current){const y={...r.moons,cosmic_origin_time:r.timing?.cosmic_origin_time||51408e4,planet_mass:r.original_planet_data?.mass||1e24,planet_radius:V,moons:r.moons.moons.map(b=>({...b,rotation:{rotation_period_s:b.orbit.orbital_period_seconds||86400,rotation_period_hours:(b.orbit.orbital_period_seconds||86400)/3600,angular_velocity_rad_s:2*Math.PI/(b.orbit.orbital_period_seconds||86400),is_tidally_locked:!0}}))};L.current.loadMoonSystem(y)}}z.current&&g.current&&(g.current.remove(z.current),z.current.geometry.dispose(),z.current.material.dispose(),z.current=null),await Xe(r),k&&k(r)}catch(e){const s=e instanceof Error?e.message:"Unknown error";le(s),Q&&Q(s),Re()}finally{we(!1),window.isLoadingPlanetData=!1}}},[a,S,I,d]),i.useCallback(()=>{if(!M||!D.current)return;const e=S?.orbital_period_seconds||365.25*24*3600,s=2*Math.PI/e,t=M.timing?.initial_orbital_angle||0,o=Date.now()/1e3,p=0,u=I||M.timing?.cosmic_origin_time||Date.now()/1e3-3600,r=o-u+p,y=(t+r*s)%(2*Math.PI),b=M.timing?.max_orbital_radius||100,f=20+M.planet_info?.orbital_radius/b*80,E=f,C=f*Math.cos(y),T=E*Math.sin(y);D.current.position.x=C,D.current.position.z=T,D.current.position.y=0},[M,S,I]);const Ct=i.useCallback(async e=>{const s=e||M;if(s&&g.current)try{Ne(s),z.current&&g.current&&(g.current.remove(z.current),z.current.geometry.dispose(),z.current.material.dispose(),z.current=null),await Xe(s)}catch{Re()}},[M]),Re=()=>{if(!(!g.current||!D.current)){ne.warn("Applying fallback effects for planet type:",S?.planet_type);try{Be(),D.current.material instanceof Vt&&D.current.material.color.setHex(6710886);try{const e=Ft("generic"),s=G.current.createEffectsFromList(e,V,D.current);s.forEach(t=>{t.effect.addToScene&&g.current&&D.current&&t.effect.addToScene(g.current,D.current.position)}),he.current=s,Te(s)}catch{}$e()}catch{}}},Be=()=>{he.current.forEach(e=>{try{G.current.removeEffect(e.id),e.effect.dispose&&e.effect.dispose()}catch{}}),$.current&&($.current.dispose(),$.current=null),he.current=[],Te([])},rt=i.useCallback(()=>{Ie.current=requestAnimationFrame(rt);const e=performance.now(),s=yt.current.getDelta(),t=Date.now()/1e3,o=Z.current?.timing?.cosmic_origin_time||51408e4;if(ge.current=t-o+De.current,L.current&&L.current.setTimeOffset(De.current),_e.current?.isAnimating&&R.current&&F.current){const r=_e.current,y=e-r.startTime,b=Math.min(y/r.duration,1),f=(T=>T<.5?4*T*T*T:(T-1)*(2*T-2)*(2*T-2)+1)(b),E=R.current,C=F.current;E.position.lerpVectors(r.startPosition,r.endPosition,f),C.target.lerpVectors(r.startTarget,r.endTarget,f),E.lookAt(C.target),C.update(),b>=1&&(_e.current.isAnimating=!1,C.enabled=!0,_e.current=null)}else F.current&&F.current.update();try{G.current.updateAllEffects(s,D.current?.rotation.y,R.current||void 0,ge.current)}catch{}if(D.current&&Z.current){const r=(Z.current.planet_info?.name||a).replace(/ /g,"_"),y=Z.current.original_planet_data,b=y?.orbital_period_seconds||365.25*24*3600,w=Z.current.timing?.initial_orbital_angle||0,f=y?.axial_tilt||0,E=2*Math.PI/b,C=(w+ge.current*E)%(2*Math.PI),T=Z.current.timing?.max_orbital_radius||Z.current.timing?.system_max_orbital_radius,H=y?.orbital_radius;if(!T||!H)return;const ue=20+H/T*80,Y=y?.eccentricity_factor||.1,K=ue;D.current.position.set(0,0,0);const te=y?.rotation_period_seconds||86400,fe=2*Math.PI/te;if(D.current.rotation.y=ge.current*fe%(2*Math.PI),D.current.rotation.z=f*(Math.PI/180),j.current.length>0){const Ge=mt(r),de=pt(r),q=gt(C,K,Y,Ge,de);Math.sqrt(q.x**2+q.y**2+q.z**2);const be=[];j.current.forEach((pe,re)=>{let ee;if(re===0)ee=new se(0,0,0);else{const W=re/j.current.length*Math.PI*2;ee=new se(50*Math.cos(W),0,50*Math.sin(W))}be.push(ee)});let me=0;j.current.forEach((pe,re)=>{const ee=Ze.current[re],ie=be[re],W=Math.sqrt((q.x-ie.x)**2+(q.y-ie.y)**2+(q.z-ie.z)**2);let oe=0;if(ee){const ce=ee.Type||"Yellow Dwarf",We=(ht[ce]||2)*300/(W*W);oe=Math.min(3,Math.max(.05,We))}else{const ce=600/(W*W);oe=Math.min(3,Math.max(.05,ce))}me+=oe}),me=Math.min(3,me),j.current.forEach((pe,re)=>{const ee=be[re],ie=new se(q.x-ee.x,q.y-ee.y,q.z-ee.z);ie.normalize();const W=ie.clone().multiplyScalar(-200);if(re===0?pe.intensity=me:pe.intensity=0,pe.position.copy(W),pe.target.position.set(0,0,0),re===0&&g.current){if(!O.current){const ce=new ct(1,16,16),nt=new lt({color:16776960,transparent:!0,opacity:.8});O.current=new ut(ce,nt),O.current.visible=!1,g.current.add(O.current);const We=new Yt,St=new qt({color:16776960,transparent:!0,opacity:.3}),He=new Qt(We,St);He.visible=!1,O.current.debugLine=He,g.current.add(He)}O.current.position.copy(W);const oe=O.current.debugLine;if(oe){const ce=new Float32Array([W.x,W.y,W.z,0,0,0]);oe.geometry.setAttribute("position",new Xt(ce,3)),oe.geometry.attributes.position.needsUpdate=!0}}}),B.current&&j.current[0]&&B.current.updateFromThreeLight(j.current[0]),j.current[0]&&G.current.updateLightForAllEffects(j.current[0]),G.current.updateOrbitalPositionForAllEffects(q)}}he.current.forEach(r=>{r.effect.updateUniforms&&r.effect.updateUniforms(s)});const u=Array.from(G.current.effects.values()).find(r=>r.type==="toxic_post_processing")?.enabled||!1;if($.current&&u&&($.current.update(s),j.current[0]&&$.current.updateLightPosition(j.current[0].position,R.current)),N.current&&g.current&&R.current){L.current&&L.current.update();const r=performance.now();$.current&&u?$.current.render():N.current.render(g.current,R.current);const y=performance.now()-r;if(e-Fe.current>5e3){const b=1e3/(e-Fe.current);$e(),Ae(w=>({...w,frameRate:Math.round(b),renderTime:Math.round(y*100)/100})),Fe.current=e}}},[]),$e=i.useCallback(()=>{const e=G.current.getStats();Ae(s=>({...s,activeEffects:e.activeEffects,enabledEffects:e.enabledEffects}))},[]);return i.useEffect(()=>{let e=!0;return(async()=>{try{if(!e)return;const t=await Mt();if(!e)return;if(!xt()){e&&le("Failed to initialize 3D renderer");return}if(!e||(rt(),v.current&&"ResizeObserver"in window&&(ve.current=new ResizeObserver(Oe),ve.current.observe(v.current)),window.addEventListener("resize",Oe),v.current&&(v.current.addEventListener("mousedown",Je),v.current.addEventListener("mousemove",Ke),v.current.addEventListener("click",et)),!e))return;t?await Ct(t):Re()}catch(t){e&&le(t instanceof Error?t.message:"Unknown initialization error")}})(),()=>{if(e=!1,Z.current=null,Ie.current&&cancelAnimationFrame(Ie.current),ve.current&&ve.current.disconnect(),window.removeEventListener("resize",Oe),v.current&&(v.current.removeEventListener("mousedown",Je),v.current.removeEventListener("mousemove",Ke),v.current.removeEventListener("click",et)),Be(),B.current&&(B.current.dispose(),B.current=null),L.current&&(L.current.dispose(),L.current=null),F.current&&F.current.dispose(),ye.current&&g.current&&(g.current.remove(ye.current),ye.current.geometry.dispose(),ye.current.material.dispose(),ye.current=null),z.current&&g.current&&(g.current.remove(z.current),z.current.geometry.dispose(),z.current.material.dispose(),z.current=null),O.current&&g.current){const t=O.current.debugLine;t&&(g.current.remove(t),t.geometry.dispose(),t.material.dispose()),g.current.remove(O.current),O.current.geometry.dispose(),O.current.material.dispose(),O.current=null}if(N.current&&v.current)try{v.current.contains(N.current.domElement)&&v.current.removeChild(N.current.domElement),N.current.dispose()}catch{}}},[]),i.useEffect(()=>(De.current=l,at(l),()=>{at(0)}),[l]),i.useEffect(()=>{if(O.current){O.current.visible=xe;const e=O.current.debugLine;e&&(e.visible=xe)}g.current&&g.current.children.forEach(e=>{e instanceof ft&&(e.visible=xe)})},[xe]),i.useEffect(()=>{let e="";const s=t=>{e+=t.key.toLowerCase(),e.length>5&&(e=e.slice(-5)),e==="atlas"&&(wt(o=>!o),e="")};return window.addEventListener("keypress",s),()=>{window.removeEventListener("keypress",s)}},[]),i.useEffect(()=>{const e=setInterval(()=>{const s=G.current.getStats();Ae(t=>({...t,activeEffects:s.activeEffects,enabledEffects:s.enabledEffects}))},1e4);return()=>clearInterval(e)},[]),i.useEffect(()=>{if(M&&M.pendingMoonData&&L.current){const e=M.pendingMoonData,s={...e,cosmic_origin_time:M.timing?.cosmic_origin_time||51408e4,planet_mass:M.original_planet_data?.mass||1e24,planet_radius:V,moons:e.moons.map(t=>({...t,rotation:{rotation_period_s:t.orbit.orbital_period_seconds||86400,rotation_period_hours:(t.orbit.orbital_period_seconds||86400)/3600,angular_velocity_rad_s:2*Math.PI/(t.orbit.orbital_period_seconds||86400),is_tidally_locked:!0}}))};L.current.loadMoonSystem(s),delete M.pendingMoonData}},[M,L.current]),sr(M),c.jsxs("div",{className:`relative ${n}`,children:[x&&M&&c.jsx(nr,{planetData:M,showInPage:!0,showInConsole:!0}),c.jsx("div",{ref:v,className:"w-full h-full",style:{minHeight:"300px",aspectRatio:"1"}}),c.jsx(rr,{isVisible:ke}),Ve&&c.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-50",children:c.jsxs("div",{className:"text-white text-center",children:[c.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"}),c.jsx("div",{children:"Loading planet..."})]})}),Ye&&c.jsxs("div",{className:"absolute top-0 left-0 right-0 p-2 bg-red-500 text-white text-sm",children:[c.jsx("strong",{children:"Error:"})," ",Ye]}),M&&!Ve&&c.jsxs("div",{className:"absolute bottom-0 left-0 p-2 text-white bg-black bg-opacity-50 max-w-xs rounded-tr-lg",children:[c.jsx("h3",{className:"text-xs font-bold",children:M.planet_info.name}),M.moons&&c.jsxs("div",{className:"text-xs mt-1",children:["Moons: ",M.moons.count]})]}),x&&c.jsxs("div",{className:"absolute top-0 right-0 p-4 text-white bg-black bg-opacity-70 text-xs font-mono",children:[c.jsx("h4",{className:"font-bold mb-2",children:"Debug Info"}),c.jsxs("div",{children:["Frame Rate: ",Pe.frameRate," FPS"]}),c.jsxs("div",{children:["Render Time: ",Pe.renderTime,"ms"]}),c.jsxs("div",{children:["Active Effects: ",Pe.activeEffects]}),c.jsxs("div",{children:["Enabled Effects: ",Pe.enabledEffects]}),c.jsxs("div",{className:"mt-2",children:[c.jsx("div",{className:"font-semibold",children:"Effects:"}),bt.map(e=>c.jsxs("div",{className:"ml-2",children:[e.type," (",e.enabled?"ON":"OFF",")"]},e.id))]})]})]})});class ir extends i.Component{constructor(n){super(n),this.state={hasError:!1,error:null}}static getDerivedStateFromError(n){return{hasError:!0,error:n.message}}componentDidCatch(n,m){}render(){return this.state.hasError?c.jsx("div",{className:"flex items-center justify-center w-full h-full bg-gray-900/50 rounded",children:c.jsxs("div",{className:"text-center p-4",children:[c.jsx("div",{className:"text-red-400 text-sm mb-2",children:"3D Renderer Error"}),c.jsx("div",{className:"text-xs text-gray-400",children:this.state.error})]})}):this.props.children}}const wr=i.forwardRef((a,n)=>c.jsx(ir,{children:c.jsx(ar,{ref:n,...a})}));export{rr as E,wr as M,Me as S,Zt as U,tr as a,er as b};
