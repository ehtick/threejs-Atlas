import{c as Z}from"./atlas_DTMHG0KBmlmtp0V4aoQDq.js";import{V as $,a6 as ae,m as B,f as X,o as J,i as ne,M as D,G as Q,b as H,C as q,F as oe,p as re,z as K,D as ee,x as ce,c as le,v as he,w as te,u as de,B as ie,a2 as se,ad as me,e as ue}from"./atlas_DUxdE5_5iPCKlmI6uaLFO.js";class be{scene;planetRadius;moonMeshes=[];orbitalLines=[];smallMoonIndicators=[];moonData=null;cosmicOriginTime;lastRelaxationSummary=0;moonMaterials=new Map;destroyedMoons=new Set;onMoonCollision;camera;planetPosition;timeOffset=0;orbitalLinesFadeEnabled=!0;orbitalLinesVisible=!0;orbitalLinesTargetOpacity=1;orbitalLinesCurrentOpacity=1;lastCameraPosition=new $;lastCameraTarget=new $;lastInteractionTime=0;fadeOutTimer=null;initialShowTimer=null;cameraMovementThreshold=.01;fadeOutDelay=3e3;initialShowDuration=5e3;fadeSpeed=.05;constructor(e,t,i,n,s){if(this.scene=e,this.planetRadius=t,this.camera=i,this.planetPosition=n,this.cosmicOriginTime=s,this.lastCameraPosition.copy(this.camera.position),this.camera instanceof ae){const o=new $;this.camera.getWorldDirection(o),this.lastCameraTarget.copy(o)}this.startInitialShowTimer(),this.initializeMaterials()}initializeMaterials(){this.moonMaterials.set("rocky",new B({color:9143936,roughness:.9,metalness:.1,normalScale:new X(.8,.8)})),this.moonMaterials.set("icy",new B({color:14737648,roughness:.3,metalness:.05,normalScale:new X(.4,.4)})),this.moonMaterials.set("asteroidal",new B({color:4865578,roughness:.95,metalness:.15,normalScale:new X(1.2,1.2)})),this.moonMaterials.set("captured",new B({color:7035722,roughness:.8,metalness:.08,normalScale:new X(.9,.9)}))}loadMoonSystem(e){this.moonData=e,e.cosmic_origin_time&&(this.cosmicOriginTime=e.cosmic_origin_time),this.clearMoons(),this.createMoons()}clearMoons(){this.orbitalLines.forEach(e=>{this.scene.remove(e),e.traverse(t=>{t instanceof J&&(t.geometry.dispose(),t.material instanceof ne&&t.material.dispose())})}),this.orbitalLines=[],this.moonMeshes.forEach(e=>{this.scene.remove(e),e.traverse(t=>{t instanceof D&&(t.geometry.dispose(),Array.isArray(t.material)?t.material.forEach(i=>i.dispose()):t.material.dispose())})}),this.moonMeshes=[]}createMoons(){this.moonData&&this.moonData.moons.forEach((e,t)=>{const i=this.createMoonMesh(e,t);this.moonMeshes.push(i),this.scene.add(i)})}createMoonMesh(e,t){const i=new Q;i.name=`moon-${e.name}`;const n=e.visuals.relative_size,s=this.planetRadius*n,o=64,a=Math.max(1,Math.min(2,1.5/Math.max(n,.01))),c=Math.floor(o*a),d=Math.floor(c*.75),l=(e.procedural?.seed||0)*.618034%(Math.PI*2),g=new H(s,c,d,l);this.generateProceduralSurface(g,e,s);let r;switch(e.properties.type){case"icy":r=new B({color:16777215,roughness:.2,metalness:.05,transparent:!1});break;case"asteroidal":r=new B({color:16777215,roughness:.95,metalness:.15,transparent:!1});break;case"captured":r=new B({color:16777215,roughness:.8,metalness:.08,transparent:!1});break;default:r=new B({color:16777215,roughness:.8,metalness:.1,transparent:!1});break}switch(this.applyMoonTexture(r,e),e.properties.type){case"icy":const u=e.procedural?.seed||0,h=this.createSeededRandom(u+9999)();let f=1;h>.8?f=1.4:h>.6?f=1.2:h<.2?f=.6:h<.4&&(f=.8),r.emissive=new q(4877194).multiplyScalar(.05*f),r.emissiveIntensity=.6*f,r.envMapIntensity=1*f,r.roughness=Math.max(.05,.15/f),r.metalness=.02,r.transparent=!0,r.opacity=Math.min(1,.95+(f-1)*.1);break;case"asteroidal":r.emissive=new q(2759178).multiplyScalar(.03),r.emissiveIntensity=.3,r.envMapIntensity=.1,r.roughness=.98,r.metalness=.18;break;case"captured":r.emissive=new q(5917242).multiplyScalar(.04),r.emissiveIntensity=.4,r.envMapIntensity=.3,r.roughness=.75,r.metalness=.12;break;default:r.emissive=new q(9136404).multiplyScalar(.04),r.emissiveIntensity=.4,r.envMapIntensity=.4,r.roughness=.85,r.metalness=.08;break}r.transparent=!1,r.side=oe,r.aoMapIntensity=.8,r.normalScale=new X(1,1);const m=new D(g,r);if(m.name=`moon-surface-${e.name}`,m.castShadow=!0,m.receiveShadow=!0,m.userData={moonData:e,moonIndex:t,isMoon:!0},i.add(m),this.createOrbitalTrail(e,t),n<.15){const u=Math.max(s*4,this.planetRadius*.04),h=new re(u,32),f=new K({side:ee,depthTest:!1,depthWrite:!1,colorWrite:!1}),M=new D(h,f);M.name=`moon-indicator-hitarea-${e.name}`,M.renderOrder=998,M.userData={isMoonIndicator:!0,moonData:e},i.add(M);const p=new ce(u*.85,u,48),S=new K({color:65348,transparent:!0,opacity:0,side:ee,depthTest:!1}),y=new D(p,S);y.name=`moon-indicator-${e.name}`,y.renderOrder=999,y.userData={isMoonIndicator:!0,moonData:e},i.add(y),this.smallMoonIndicators.push(y),this.smallMoonIndicators.push(M)}if(e.visuals.has_atmosphere&&e.visuals.atmosphere_color){const u=new H(s*1.05,16,8),h=new K({color:e.visuals.atmosphere_color,transparent:!0,opacity:e.visuals.atmosphere_opacity||.1,side:le}),f=new D(u,h);f.name=`moon-atmosphere-${e.name}`,i.add(f)}return this.updateMoonPosition(i,e,0,t),i}generateProceduralSurface(e,t,i){const n=t.procedural?.seed||0,s=Z(this.createSeededRandom(n)),o=e.attributes.position.array,a=1.5/Math.max(i,.1),c=this.calculateHydrostaticRelaxation(t),w=.7+(n*13+4567)%1e3/1e3*.6;let l;switch(t.properties.type){case"icy":l=i*.15;break;case"asteroidal":l=i*.18;break;case"captured":l=i*.12;break;default:l=i*.09;break}const r=l*(1-c)*w;for(let m=0;m<o.length;m+=3){const u=o[m],h=o[m+1],f=o[m+2],M=u*a,p=h*a,S=f*a;let y=0;switch(t.properties.type){case"icy":y+=s(M*2,p*2,S*2)*.8,y+=s(M*6,p*6,S*6)*.4,y+=s(M*15,p*15,S*15)*.2;break;case"asteroidal":y+=s(M*.8,p*.8,S*.8)*1.5,y+=s(M*3,p*3,S*3)*1,y+=s(M*8,p*8,S*8)*.7,y+=s(M*20,p*20,S*20)*.4,y+=s(M*50,p*50,S*50)*.2;break;case"captured":y+=s(M*1.2,p*1.2,S*1.2)*1.2,y+=s(M*4,p*4,S*4)*.8,y+=s(M*10,p*10,S*10)*.5,y+=s(M*30,p*30,S*30)*.25;break;default:y+=s(M*1.5,p*1.5,S*1.5)*1,y+=s(M*5,p*5,S*5)*.6,y+=s(M*12,p*12,S*12)*.3,y+=s(M*25,p*25,S*25)*.15;break}const P=new $(u,h,f),O=P.clone().normalize(),k=P.add(O.multiplyScalar(y*r));o[m]=k.x,o[m+1]=k.y,o[m+2]=k.z}e.attributes.position.needsUpdate=!0,e.computeVertexNormals()}applyMoonTexture(e,t){this.createProceduralColorTexture(e,t)}createProceduralColorTexture(e,t){const n=document.createElement("canvas");n.width=256,n.height=256;const s=n.getContext("2d"),o=t.visuals.base_color;let a;if(o&&o.startsWith("#")){const _=o.slice(1);a={r:parseInt(_.slice(0,2),16),g:parseInt(_.slice(2,4),16),b:parseInt(_.slice(4,6),16)}}else switch(t.properties.type){case"icy":a={r:160,g:170,b:190};break;case"asteroidal":a={r:74,g:62,b:42};break;case"captured":a={r:107,g:91,b:74};break;default:a={r:139,g:134,b:128};break}const c=t.procedural?.seed||Math.abs(t.name.split("").reduce((_,v)=>_+v.charCodeAt(0),0)),d=Math.abs(c)%1e6,w=d===0?12345:d,l=Z(this.createSeededRandom(w+777));let g=0,r=0,m=0;const u=w%100*.1,h=w/100%100*.1,f=w/1e4%100*.1;switch(t.properties.type){case"icy":g=l(u+1,h+2,f+3)*120,r=l(u+4,h+5,f+6)*100,m=l(u+7,h+8,f+9)*110;const _=l(u*.5,h*.5,f*.5),v=l(u*.3,h*.7,f*.4),T=l(u*.8,h*.2,f*.6);let V=1;T>.4?V=1.4:T>.1?V=1.2:T<-.4?V=.6:T<-.1&&(V=.8),_>.3?(g-=40,r+=50,m+=60):_<-.3?(g+=60,r-=20,m+=20):v>.4?(g+=40,r+=35,m-=30,V*=.9):v<-.4&&(g-=30,r-=20,m+=50),g*=V,r*=V,m*=V;break;case"asteroidal":g=l(u+10,h+11,f+12)*60,r=l(u+13,h+14,f+15)*55,m=l(u+16,h+17,f+18)*50;break;case"captured":g=l(u+19,h+20,f+21)*50,r=l(u+22,h+23,f+24)*45,m=l(u+25,h+26,f+27)*40;break;default:g=l(u+28,h+29,f+30)*55,r=l(u+31,h+32,f+33)*50,m=l(u+34,h+35,f+36)*45;break}({...a},a={r:Math.max(20,Math.min(255,a.r+g)),g:Math.max(20,Math.min(255,a.g+r)),b:Math.max(30,Math.min(255,a.b+m))}),s.fillStyle=`rgb(${a.r}, ${a.g}, ${a.b})`,s.fillRect(0,0,256,256);const M=(w*7919+41)%233280,p=Z(this.createSeededRandom(M)),S=s.getImageData(0,0,256,256),y=S.data;for(let _=0;_<256;_++)for(let v=0;v<256;v++){const T=(_*256+v)*4,V=v/256,N=_/256,U=(V-.5)*2*Math.PI,W=(N-.5)*Math.PI,C=Math.cos(W)*Math.cos(U),L=Math.cos(W)*Math.sin(U),x=Math.sin(W),G=(M*17+8901)%1e3,b=.5+G/1e3*1,z=.8+G/1e3*.4;let F=0;switch(t.properties.type){case"icy":F+=p(C*(2*b),L*(2*b),x*(2*b))*(.5*z),F+=p(C*(6*b),L*(6*b),x*(6*b))*(.3*z),F+=p(C*(15*b),L*(15*b),x*(15*b))*(.2*z);const j=p(C*30,L*30,x*30)*.1;F+=j*z;break;case"asteroidal":F+=p(C*(1.2*b),L*(1.2*b),x*(1.2*b))*(.75*z),F+=p(C*(4*b),L*(4*b),x*(4*b))*(.55*z),F+=p(C*(10*b),L*(10*b),x*(10*b))*(.35*z),F+=p(C*(25*b),L*(25*b),x*(25*b))*(.22*z);break;case"captured":F+=p(C*(1.8*b),L*(1.8*b),x*(1.8*b))*(.6*z),F+=p(C*(5*b),L*(5*b),x*(5*b))*(.38*z),F+=p(C*(12*b),L*(12*b),x*(12*b))*(.2*z);break;default:F+=p(C*(2*b),L*(2*b),x*(2*b))*(.55*z),F+=p(C*(6*b),L*(6*b),x*(6*b))*(.33*z),F+=p(C*(16*b),L*(16*b),x*(16*b))*(.18*z);break}let I,R,A;if(t.properties.type==="icy"){if(I=a.r,R=a.g,A=a.b,F>0){const E=F*.5;I=I*(1-E*.15),R=R*(1+E*.2),A=A*(1+E*.25)}else{const E=Math.abs(F)*.5;I=I*(1+E*.1),R=R*(1-E*.15),A=A*(1+E*.05)}const j=1+F*.3;I=I*j,R=R*j,A=A*j;const Y=p(C*8,L*8,x*8);Y>.5?(I=Math.min(255,I*1.05),R=Math.min(255,R*1.08),A=Math.min(255,A*1.1)):Y<-.5&&(I=I*.95,R=R*.97,A=A*1.02),I=Math.max(0,Math.min(255,I)),R=Math.max(0,Math.min(255,R)),A=Math.max(0,Math.min(255,A))}else{const j=1+F;I=Math.max(0,Math.min(255,a.r*j)),R=Math.max(0,Math.min(255,a.g*j)),A=Math.max(0,Math.min(255,a.b*j))}y[T]=I,y[T+1]=R,y[T+2]=A,y[T+3]=255}s.putImageData(S,0,0);const P=new he(n);P.wrapS=te,P.wrapT=te,P.generateMipmaps=!0,P.needsUpdate=!0;const k=(t.procedural?.seed||0)*.618034%1;P.offset.x=k,P.repeat.set(1,1),e.map=P,e.needsUpdate=!0}drawCrater(e,t,i){const n=(i.position.lon+180)/360*t,s=(90-i.position.lat)/180*t,o=Math.max(20,i.radius*t*.8),a=e.createRadialGradient(n,s,0,n,s,o);a.addColorStop(0,"rgba(0, 0, 0, 0.95)"),a.addColorStop(.2,"rgba(10, 10, 10, 0.8)"),a.addColorStop(.5,"rgba(40, 40, 40, 0.6)"),a.addColorStop(.8,"rgba(100, 100, 100, 0.4)"),a.addColorStop(.95,"rgba(180, 180, 180, 0.3)"),a.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=a,e.beginPath(),e.arc(n,s,o,0,2*Math.PI),e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.7)",e.lineWidth=3,e.beginPath(),e.arc(n,s,o*.9,0,2*Math.PI),e.stroke(),e.strokeStyle="rgba(220, 220, 220, 0.5)",e.lineWidth=1,e.beginPath(),e.arc(n,s,o*.95,0,2*Math.PI),e.stroke()}createSeededRandom(e){let t=e*9301+49297;return()=>(t=(t*9301+49297)%233280,t/233280)}calculateHydrostaticRelaxation(e){const t=e.properties.radius_km*1e3,i=e.properties.mass_kg,n=e.properties.density_kg_m3;if(!isFinite(t)||!isFinite(i)||!isFinite(n)||t<=0||i<=0||n<=0)return 0;const o=66743e-15*i/(t*t);if(!isFinite(o)||o<=0)return 0;let a;switch(e.properties.type){case"icy":const m=e.tidal_heating?.tidal_power_watts||0,u=4*Math.PI*t*t,h=m/u;h>1e3?a=1e12:h>100?a=1e15:h>10?a=1e18:h>1?a=1e20:a=1e21;break;case"asteroidal":a=1e26;break;case"captured":a=1e24;break;default:t>5e5?a=1e22:t>1e5?a=1e23:a=1e25;break}let c;e.properties.type==="icy"?(e.tidal_heating?.tidal_power_watts||0)>1e12?c=1e9:c=35e8:c=3e10;const d=a/c;if(!isFinite(d)||d<=0)return 0;const l=Date.now()/1e3-this.cosmicOriginTime;if(!isFinite(l)||l<0)return 0;const g=l/d,r=1-Math.exp(-g);return e.tidal_heating?.tidal_power_watts,this.lastRelaxationSummary||(this.lastRelaxationSummary=0),this.lastRelaxationSummary<Date.now()-5e3&&(this.lastRelaxationSummary=Date.now()),Math.max(0,Math.min(1,r))}updateMoonSurfaceRelaxation(e,t){const i=e.getObjectByName(`moon-surface-${t.name}`);if(!i||!(i.geometry instanceof H))return;const n=this.calculateHydrostaticRelaxation(t),s=t.procedural?.seed||0,o=i.geometry,a=o.parameters.radius,c=Z(this.createSeededRandom(s)),d=o.attributes.position.array,w=.5,g=.7+(s*13+4567)%1e3/1e3*.6;let r;switch(t.properties.type){case"icy":r=a*.15;break;case"asteroidal":r=a*.18;break;case"captured":r=a*.12;break;default:r=a*.09;break}const u=r*(1-n)*g;for(let h=0;h<d.length;h+=3){const f=d[h],M=d[h+1],p=d[h+2],S=new $(f,M,p),y=S.length(),P=S.clone().normalize(),O=f/y*w,k=M/y*w,_=p/y*w;let v=0;switch(t.properties.type){case"icy":v+=c(O*2,k*2,_*2)*.8,v+=c(O*6,k*6,_*6)*.4,v+=c(O*15,k*15,_*15)*.2;break;case"asteroidal":v+=c(O*.8,k*.8,_*.8)*1.5,v+=c(O*3,k*3,_*3)*1,v+=c(O*8,k*8,_*8)*.7,v+=c(O*20,k*20,_*20)*.4,v+=c(O*50,k*50,_*50)*.2;break;case"captured":v+=c(O*1.2,k*1.2,_*1.2)*1.2,v+=c(O*4,k*4,_*4)*.8,v+=c(O*10,k*10,_*10)*.5,v+=c(O*30,k*30,_*30)*.25;break;default:v+=c(O*1.5,k*1.5,_*1.5)*1,v+=c(O*5,k*5,_*5)*.6,v+=c(O*12,k*12,_*12)*.3,v+=c(O*25,k*25,_*25)*.15;break}const T=P.clone().multiplyScalar(a+v*u);d[h]=T.x,d[h+1]=T.y,d[h+2]=T.z}o.attributes.position.needsUpdate=!0,o.computeVertexNormals()}drawMaria(e,t,i,n=0){const s=(i.position.lon+180)/360*t,o=(90-i.position.lat)/180*t,a=Math.max(15,i.radius*t*.4),c=e.createRadialGradient(s,o,0,s,o,a);c.addColorStop(0,`rgba(10, 10, 10, ${i.darkness*.9})`),c.addColorStop(.6,`rgba(25, 25, 25, ${i.darkness*.7})`),c.addColorStop(1,`rgba(40, 40, 40, ${i.darkness*.3})`),e.fillStyle=c,e.beginPath(),e.arc(s,o,a,0,2*Math.PI),e.fill();const d=this.createSeededRandom(n+Math.floor(s+o));e.fillStyle=`rgba(60, 50, 40, ${i.darkness*.2})`;for(let w=0;w<5;w++){const l=s+(d()-.5)*a*.8,g=o+(d()-.5)*a*.8;e.beginPath(),e.arc(l,g,2+d()*3,0,2*Math.PI),e.fill()}}calculateOrbitalParameters(e){const t=Math.max(...this.moonData.moons.map(P=>P.orbit.semi_major_axis_km)),i=e.orbit.semi_major_axis_km/t,n=Math.log10(1+i*9),o=e.properties.origin==="co-formation"&&e.properties.density_kg_m3<1500?2.5:1.8,c=this.planetRadius*o*1.2,d=this.planetRadius*4,w=c+n*d,l=this.planetRadius*10,g=Math.min(w,l),r=e.orbit.eccentricity,u=Math.min(3,1/.5),h=Math.min(.8,r*u),M=Math.min(e.orbit.inclination_deg*3,60),p=de.degToRad(M),S=e.orbit.argument_of_periapsis||0,y=e.orbit.longitude_of_ascending_node||0;return{semiMajorAxis:g,eccentricity:h,inclination:p,argumentOfPeriapsis:S,longitudeOfAscendingNode:y}}createOrbitalTrail(e,t){const i=this.calculateOrbitalParameters(e),n=i.semiMajorAxis,s=i.eccentricity,o=i.inclination,a=i.argumentOfPeriapsis,c=i.longitudeOfAscendingNode,d=[],w=128;for(let m=0;m<=w;m++){const u=m/w*Math.PI*2,h=n*(1-s*s)/(1+s*Math.cos(u)),f=h*Math.cos(u+a),M=h*Math.sin(u+a),p=0,S=Math.cos(o),y=Math.sin(o),P=Math.cos(c),O=Math.sin(c),k=f,_=M*S-p*y,v=M*y+p*S,T=k*P-_*O,V=k*O+_*P,N=v;d.push(new $(T,N,-V))}new ie().setFromPoints(d);let l;switch(e.properties.type){case"icy":l=6724095;break;case"asteroidal":l=9127187;break;case"captured":l=16737894;break;default:l=16755302;break}const g=new Q;g.name=`moon-orbit-${e.name}`;for(let m=0;m<d.length;m+=3){const u=[];if(m<d.length&&(u.push(d[m]),m+1<d.length&&u.push(d[m+1])),u.length>=2){const h=new ie().setFromPoints(u),f=new se({color:l,opacity:0,transparent:!0,linewidth:1}),M=new J(h,f);M.name=`moon-orbit-segment-${e.name}-${m}`,g.add(M)}}const r=g;r.visible=!1,r.position.copy(this.planetPosition),this.scene.add(r),this.orbitalLines||(this.orbitalLines=[]),this.orbitalLines.push(r)}drawIceCracks(e,t,i){const n=(i.start.lon+180)/360*t,s=(90-i.start.lat)/180*t,o=(i.end.lon+180)/360*t,a=(90-i.end.lat)/180*t,c=Math.max(8,i.width*t*500);e.shadowColor="rgba(150, 200, 255, 1.0)",e.shadowBlur=20,e.strokeStyle=`rgba(255, 255, 255, ${Math.min(1,i.brightness*3)})`,e.lineWidth=c,e.lineCap="round",e.beginPath(),e.moveTo(n,s),e.lineTo(o,a),e.stroke(),e.shadowColor="rgba(100, 150, 255, 0.8)",e.shadowBlur=30,e.strokeStyle=`rgba(200, 230, 255, ${Math.min(1,i.brightness*2.5)})`,e.lineWidth=c*.7,e.beginPath(),e.moveTo(n,s),e.lineTo(o,a),e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.shadowBlur=0}setTimeOffset(e){this.timeOffset=e}getTimeOffset(){return this.timeOffset}setCollisionCallback(e){this.onMoonCollision=e}checkMoonCollisions(){if(!this.moonData||this.moonData.moons.length<2)return;const e=this.moonData.moons,t=this.moonMeshes.map(i=>i.position.clone());for(let i=0;i<e.length;i++)if(!this.destroyedMoons.has(i))for(let n=i+1;n<e.length;n++){if(this.destroyedMoons.has(n))continue;const s=e[i],o=e[n],a=this.planetRadius*s.visuals.relative_size,c=this.planetRadius*o.visuals.relative_size,d=a+c,w=t[i].distanceTo(t[n]);if(w<d*3&&console.log(`[Collision Check] ${s.name} <-> ${o.name}: distance=${w.toFixed(4)}, collisionDist=${d.toFixed(4)}, ratio=${(w/d).toFixed(2)}`),w<d){const l=s.properties.mass_kg,g=o.properties.mass_kg,r=s.properties.radius_km,m=o.properties.radius_km,u=this.calculateOrbitalVelocity(s),h=this.calculateOrbitalVelocity(o),f=Math.abs(u-h),M=Math.sqrt(2*6674e-14*(l+g)/((r+m)*1e3)),p=l<g?i:n,S=l<g?n:i;f<M*.5?(this.fuseMoons(p,S),this.onMoonCollision&&this.onMoonCollision(e[p],e[S],"fusion")):(this.destroyMoon(p),this.onMoonCollision&&this.onMoonCollision(e[p],e[S],"destruction"))}}}calculateOrbitalVelocity(e){const t=e.orbit.semi_major_axis_km*1e3,i=e.orbit.orbital_period_seconds;return 2*Math.PI*t/i}fuseMoons(e,t){if(!this.moonData)return;const i=this.moonData.moons[e],n=this.moonData.moons[t];n.properties.mass_kg+=i.properties.mass_kg;const s=4/3*Math.PI*(Math.pow(n.properties.radius_km,3)+Math.pow(i.properties.radius_km,3));n.properties.radius_km=Math.pow(3*s/(4*Math.PI),1/3),n.visuals.relative_size=Math.pow(Math.pow(n.visuals.relative_size,3)+Math.pow(i.visuals.relative_size,3),1/3),this.destroyMoon(e),this.updateSurvivorMesh(t)}destroyMoon(e){if(this.destroyedMoons.add(e),e<this.moonMeshes.length){const t=this.moonMeshes[e];t.visible=!1}if(e<this.orbitalLines.length){const t=this.orbitalLines[e];t.visible=!1}}updateSurvivorMesh(e){if(!this.moonData||e>=this.moonMeshes.length)return;const t=this.moonData.moons[e],n=this.moonMeshes[e].children.find(s=>s instanceof D&&s.name.startsWith("moon-mesh-"));if(n&&n.geometry){const s=this.planetRadius*t.visuals.relative_size;n.geometry.dispose(),n.geometry=new H(s,32,16)}}update(){if(!this.moonData)return;this.detectCameraMovement()&&this.onCameraMovement(),this.updateOrbitalLinesFade();const e=Date.now()/1e3;if(!isFinite(this.cosmicOriginTime))return;const t=e-this.cosmicOriginTime+this.timeOffset;isFinite(t)&&(t<0||(this.moonData.moons.forEach((i,n)=>{this.destroyedMoons.has(n)||n<this.moonMeshes.length&&(this.updateMoonPosition(this.moonMeshes[n],i,t,n),Math.floor(t)%30===0&&this.updateMoonSurfaceRelaxation(this.moonMeshes[n],i))}),this.checkMoonCollisions(),this.updateLOD()))}updateMoonPosition(e,t,i,n=0){if(!isFinite(i))return;const s=t.orbit.orbital_period_seconds;if(!isFinite(s)||s<=0)return;const o=2*Math.PI/s,a=t.orbit.initial_phase||0,c=(o*i+a)%(2*Math.PI);if(!isFinite(c))return;const d=this.calculateOrbitalParameters(t),w=d.semiMajorAxis,l=d.eccentricity,g=d.inclination,r=d.argumentOfPeriapsis,m=d.longitudeOfAscendingNode;let u=c;for(let Y=0;Y<5;Y++){const E=c+l*Math.sin(u);if(!isFinite(E))break;u=E}if(!isFinite(u))return;const h=Math.sqrt(1+l),f=Math.sqrt(1-l),M=Math.sin(u/2),p=Math.cos(u/2);if(!isFinite(h)||!isFinite(f)||!isFinite(M)||!isFinite(p))return;const S=2*Math.atan2(h*M,f*p);if(!isFinite(S))return;const y=w*(1-l*l)/(1+l*Math.cos(S)),P=S+r,O=y*Math.cos(P),k=y*Math.sin(P),_=0;if(!isFinite(O)||!isFinite(k)||!isFinite(_))return;const v=Math.cos(g),T=Math.sin(g);if(!isFinite(v)||!isFinite(T)||!isFinite(m))return;let V=O,N=k*v-_*T,U=k*T+_*v;const W=Math.cos(m),C=Math.sin(m);if(!isFinite(W)||!isFinite(C))return;const L=V*W-N*C,x=V*C+N*W,G=U;if(!isFinite(L)||!isFinite(x)||!isFinite(G)||!isFinite(this.planetPosition.x)||!isFinite(this.planetPosition.y)||!isFinite(this.planetPosition.z))return;const b=L,z=G,F=-x,I=this.planetPosition.x+b,R=this.planetPosition.y+z,A=this.planetPosition.z+F;if(!isFinite(I)||!isFinite(R)||!isFinite(A))return;e.position.set(I,R,A);const j=e.getObjectByName(`moon-surface-${t.name}`);j&&this.applyTidalLockingWithLibration(j,t,S,i)}calculatePeriapsisWithPrecession(e,t){const i=e.orbit.argument_of_periapsis||0;if(!isFinite(t)||!isFinite(i))return i;const n=this.planetRadius,s=e.orbit.semi_major_axis_km;if(!isFinite(s)||s<=0||s/n>10)return i;const a=.001,c=2*Math.PI/e.orbit.orbital_period_seconds,d=e.orbit.inclination_deg*Math.PI/180;if(!isFinite(c)||!isFinite(d))return i;const w=3/2*a*c*Math.pow(n/s,2)*Math.cos(d);if(!isFinite(w))return i;const l=w*t,g=(i+l)%(2*Math.PI);return isFinite(g)?g:i}applyTidalLockingWithLibration(e,t,i,n){if(!isFinite(i))return;if(t.rotation?.is_tidally_locked??!0){e.lookAt(this.planetPosition);const o=t.orbit.eccentricity;if(isFinite(o)&&o>=0&&o<1){const a=2*o*Math.sin(i),d=t.orbit.inclination_deg*Math.PI/180*Math.sin(i)*.1;if(isFinite(a)&&isFinite(d)){const w=a+d;isFinite(w)&&e.rotateY(w)}}}else{const o=t.rotation?.angular_velocity_rad_s??2*Math.PI/t.orbit.orbital_period_seconds;if(isFinite(o)&&o>0){const a=Date.now()/1e3,c=this.moonData?.cosmic_origin_time||0,d=a-c,w=o*d;isFinite(w)&&(e.rotation.y=w%(2*Math.PI))}}}updateLOD(){if(!this.moonData)return;const e=this.camera.position,t=new me,i=new ue;i.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),t.setFromProjectionMatrix(i),this.moonMeshes.forEach((n,s)=>{const o=e.distanceTo(n.position),a=this.moonData.moons[s];if(!t.containsPoint(n.position)&&o>this.moonData.render_settings.lod_distances[1]){n.visible=!1;return}const d=this.moonData.render_settings.max_visible_distance*2;if(n.visible=o<d,!n.visible)return;const l=a.properties.radius_km/o;let g=2;o<this.moonData.render_settings.lod_distances[0]||l>.001?g=0:(o<this.moonData.render_settings.lod_distances[1]||l>1e-4)&&(g=1);const r=n.getObjectByName(`moon-surface-${a.name}`);r&&r.geometry instanceof H&&this.applyGeometryLOD(r,g,o);const m=this.moonData.render_settings.max_visible_distance;if(o>m*.5){const u=Math.max(.3,1-(o-m*.5)/(m*.5));n.scale.setScalar(u)}else n.scale.setScalar(1)})}applyGeometryLOD(e,t,i){e.geometry;const n=e.material;i>1e3&&(n.roughness=Math.min(1,n.roughness+.1),n.metalness=Math.max(0,n.metalness-.05))}getMoonAtPosition(e){const t=e.intersectObjects(this.scene.children,!0);for(const i of t)if(i.object.userData?.isMoon||i.object.userData?.isMoonIndicator)return i.object.userData.moonData;return null}getMoonPosition(e){const t=this.moonMeshes.find(i=>i.name===`moon-${e}`);return t?t.position.clone():null}dispose(){this.fadeOutTimer&&(clearTimeout(this.fadeOutTimer),this.fadeOutTimer=null),this.initialShowTimer&&(clearTimeout(this.initialShowTimer),this.initialShowTimer=null),this.clearMoons(),this.moonMaterials.forEach(e=>e.dispose()),this.moonMaterials.clear()}startInitialShowTimer(){this.orbitalLinesTargetOpacity=0,this.orbitalLinesCurrentOpacity=0,this.lastInteractionTime=Date.now(),this.initialShowTimer=null}detectCameraMovement(){const e=this.camera.position.clone(),t=new $;this.camera.getWorldDirection(t);const i=e.distanceTo(this.lastCameraPosition)>this.cameraMovementThreshold,n=t.distanceTo(this.lastCameraTarget)>this.cameraMovementThreshold;return i||n?(this.lastCameraPosition.copy(e),this.lastCameraTarget.copy(t),!0):!1}isCameraMoving(){return this.detectCameraMovement()}onCameraMovement(){this.lastInteractionTime=Date.now(),this.fadeOutTimer&&(clearTimeout(this.fadeOutTimer),this.fadeOutTimer=null),this.initialShowTimer&&(clearTimeout(this.initialShowTimer),this.initialShowTimer=null),this.fadeInOrbitalLines(),this.fadeOutTimer=window.setTimeout(()=>{this.fadeOutOrbitalLines(),this.fadeOutTimer=null},this.fadeOutDelay)}fadeInOrbitalLines(){this.orbitalLinesFadeEnabled&&(this.orbitalLinesTargetOpacity=.4)}fadeOutOrbitalLines(){this.orbitalLinesFadeEnabled&&(this.orbitalLinesTargetOpacity=0)}updateOrbitalLinesFade(){if(!this.orbitalLinesFadeEnabled)return;const e=this.orbitalLinesTargetOpacity-this.orbitalLinesCurrentOpacity;Math.abs(e)>.001&&(this.orbitalLinesCurrentOpacity+=e*this.fadeSpeed,this.orbitalLines.forEach(s=>{if(s.name&&s.name.startsWith("moon-orbit-")){const o=this.orbitalLinesCurrentOpacity>.05;s.visible=o,o&&s.traverse(a=>{if(a instanceof J&&a.material instanceof se&&a.name&&a.name.startsWith("moon-orbit-segment-")){const c=a.material;c.opacity=this.orbitalLinesCurrentOpacity,c.needsUpdate=!0}})}}));const t=Date.now()/1e3,i=.5+Math.sin(t*4)*.4,n=this.orbitalLinesCurrentOpacity*i;this.smallMoonIndicators.forEach(s=>{if(s.material instanceof K&&(s.visible=this.orbitalLinesCurrentOpacity>.05,s.material.opacity=n,s.material.needsUpdate=!0,s.parent)){const o=new $;s.parent.getWorldPosition(o),s.lookAt(this.camera.position)}})}enableOrbitalLinesFade(e){this.orbitalLinesFadeEnabled=e,e||(this.orbitalLinesTargetOpacity=.4,this.orbitalLinesCurrentOpacity=.4,this.updateOrbitalLinesFade())}isOrbitalLinesFadeEnabled(){return this.orbitalLinesFadeEnabled}}export{be as M};
