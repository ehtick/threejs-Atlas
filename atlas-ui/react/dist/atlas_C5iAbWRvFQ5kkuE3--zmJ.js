import{j as n,r as u}from"./atlas_C3xj8MG9oH9uC54MklkAb.js";import{W as Ge}from"./atlas_DZM9FmPthL9IAVyCLrEWU.js";import{O as He}from"./atlas_CyxJnurXlVDWbOBgEYZ47.js";import{Q as We}from"./atlas_C0q7_QgoBkw_1ECio0nFC.js";import{e as $}from"./atlas_CN2P8foxSAWepRmkWi2pd.js";import{E as B,c as Ve}from"./atlas_oMHFjiYa_LxCgszKuGd-s.js";import{g as qe}from"./atlas_D8Sk6PbDRqOSEGMc8d1CU.js";import{P as Ye}from"./atlas_BmyVsCDHB7iU5E6YE6FRM.js";import{c as Qe}from"./atlas_bYrLhk8mRzAb9WUD7AvHB.js";import{a1 as Ze,a2 as Xe,C as Re,a3 as Je,a4 as Ke,a5 as et,a6 as tt,a7 as Ee,a8 as rt,b as nt,z as st,M as at,m as it}from"./atlas_BptVXGp7hwWSDe7IbaYgj.js";class re{static encodeUrl(c){return btoa(c).replace(/\+/g,"-").replace(/\//g,"_")}static generateGalaxyUrl(c,p=1){const _=`coordinates=${c[0]},${c[1]},${c[2]}&page=${p}`,g=this.encodeUrl(_);return`${window.location.origin}/stargate/${g}`}static generateSystemUrl(c,p,_=1){const g=`coordinates=${c[0]},${c[1]},${c[2]}&system=${p}&page=${_}`,y=this.encodeUrl(g);return`${window.location.origin}/stargate/${y}`}static generatePlanetUrl(c,p,_,g=1){const y=`coordinates=${c[0]},${c[1]},${c[2]}&system=${p}&planet=${_.toLowerCase()}&page=${g}`,b=this.encodeUrl(y);return`${window.location.origin}/stargate/${b}`}static getCurrentPage(){try{const p=new URLSearchParams(window.location.search).get("page");if(p)return parseInt(p,10);const _=window.location.pathname.match(/\/galaxy\/(\d+)/);return _?parseInt(_[1],10):1}catch{return 1}}}const ot=(s,c)=>{try{const p=s.split("/stargate/")[1];if(!p)return null;const _=atob(p.replace(/-/g,"+").replace(/_/g,"/")),g=new URLSearchParams(_),y=g.get("coordinates"),b=g.get("system"),R=g.get("planet");if(!y)return null;const w={type:c,coordinates:y};return b&&(w.systemIndex=parseInt(b)),R&&(w.planetName=R),w}catch{return null}},Se=s=>{try{const c=s.coordinates.split(",").map(Number),p=re.getCurrentPage();switch(s.type){case"galaxy":return re.generateGalaxyUrl(c,p);case"system":if(s.systemIndex!==void 0)return re.generateSystemUrl(c,s.systemIndex,p);break;case"planet":if(s.systemIndex!==void 0&&s.planetName)return re.generatePlanetUrl(c,s.systemIndex,s.planetName,p);break}return window.location.pathname}catch{return window.location.pathname}},ct=async s=>{const{url:c,size:p}=s;return new Promise((_,g)=>{const y=document.createElement("canvas"),b=p,R=Math.floor(p*.8);We.toCanvas(y,c,{width:R,margin:0,color:{dark:"#000000",light:"#FFFFFF"},errorCorrectionLevel:"H"},w=>{if(w){g(w);return}const d=document.createElement("canvas"),i=d.getContext("2d"),z=Math.floor(b*.17);if(d.width=b,d.height=b+z,i){const A=Math.floor(b*.1);i.fillStyle="#FFFFFF",i.beginPath(),i.roundRect(0,0,d.width,d.height,A),i.fill();const q=(b-R)/2;i.drawImage(y,q,q),i.fillStyle="#000000",i.font=`bold ${Math.floor(b*.13)}px Arial`,i.textAlign="center",i.textBaseline="middle",i.fillText("VIEW IT LIVE",b/2,b+z*.2),_(d)}})})},lt=async(s,c,p,_)=>{try{let g;if("coordinates"in _)g=Se(_);else{const i=ot(_.stargateUrl,_.type);i?g=Se(i):g=_.stargateUrl}const y=Math.floor(c/8),b=await ct({url:g,size:y}),R=Math.floor(c/100),w=c-b.width-R,d=p-b.height-R;s.drawImage(b,w,d)}catch(g){console.warn("Failed to generate QR code:",g)}},ut=(s,c)=>{const{imageWidth:p,imageHeight:_,startYear:g=2023,companyName:y="Banshee",opacity:b=.5,fontSize:R}=c,w=new Date().getFullYear(),d=w===g?`${g}`:`${g}-${w}`,i=`The Atlas • Copyright ${y} • ${d}`;s.fillStyle=`rgba(255, 255, 255, ${b})`;const z=R||Math.floor(p/80);s.font=`${z}px Arial`,s.textAlign="left",s.textBaseline="bottom";const A=Math.floor(p/100);s.fillText(i,A,_-A)},ft=({isVisible:s,message:c="Exporting view, please wait..."})=>n.jsxs("div",{className:`absolute inset-0 bg-black flex flex-col items-center justify-center z-10 transition-all duration-300 ${s?"opacity-100 visible":"opacity-0 invisible"}`,children:[n.jsx("div",{className:"w-16 h-16 border-4 border-white/20 border-t-white rounded-full animate-spin mb-6"}),n.jsx("p",{className:"text-white text-xl font-medium text-center px-4",children:c})]}),dt=({planetData:s,showInConsole:c=!0,showInPage:p=!1})=>{const[_,g]=u.useState([]),[y,b]=u.useState({});u.useEffect(()=>{if(!s)return;const d=R(s);b(d),g(w(s)),typeof window<"u"&&(window.__DEBUG_PLANET_DATA=s,window.__DEBUG_PLANET_ANALYSIS=d)},[s,c]);function R(d){const i={hasValidStructure:!1,missingFields:[],dataIntegrity:"unknown",renderingIssues:[],colorConsistency:"unknown"};if(d.planet_info&&d.surface_elements?i.hasValidStructure=!0:(d.planet_info||i.missingFields.push("planet_info"),d.surface_elements||i.missingFields.push("surface_elements")),d.surface_elements?.type==="oceanic"&&(i.oceanicData={hasAbstractLands:!!d.surface_elements.abstract_lands?.length,numGreenPatches:d.surface_elements.green_patches?.length||0,numClouds:d.surface_elements.clouds?.length||0,hasDepths:d.surface_elements.depths?.enabled||!1,baseColorIsBlue:d.planet_info?.base_color==="#0000FF",greenPatchColor:d.surface_elements.green_patches?.[0]?.color,issues:[]},i.oceanicData.numGreenPatches>15&&i.oceanicData.issues.push("Muchos parches verdes pueden ocultar el océano azul"),i.oceanicData.baseColorIsBlue||i.oceanicData.issues.push(`Color base no es azul puro: ${d.planet_info?.base_color}`),i.renderingIssues=i.oceanicData.issues),d.planet_info?.base_color&&d.planet_info?.type){const A={Oceanic:"#0000FF",Rocky:"#808080",Icy:"#ADD8E6",Desert:"#FFD700",Lava:"#FF0000"}[d.planet_info.type];A&&d.planet_info.base_color!==A?i.colorConsistency=`Inconsistente: esperado ${A}, recibido ${d.planet_info.base_color}`:i.colorConsistency="Correcto"}return i}function w(d){const i=[];if(!d.surface_elements?.type)return["No surface type defined"];const z=d.surface_elements.type.toLowerCase();switch(z){case"oceanic":i.push("OceanWavesEffect (PROBLEMA: ignora green_patches de Python)");break;case"rocky":i.push("RockyTerrainEffect");break;case"icy":i.push("IcyTerrainEffect");break;case"gas giant":i.push("GasGiantBandsEffect");break;default:i.push(`Generic effect for type: ${z}`)}return d.atmosphere?.density>0&&i.push("AtmosphericEffect"),d.rings&&i.push("RingSystemEffect"),i}return p?n.jsxs("div",{style:{position:"fixed",top:10,right:10,background:"rgba(0, 0, 0, 0.9)",color:"#00ff00",padding:"10px",borderRadius:"5px",fontFamily:"monospace",fontSize:"12px",maxWidth:"400px",maxHeight:"600px",overflow:"auto",zIndex:1e4,border:"1px solid #00ff00"},children:[n.jsxs("h3",{style:{margin:"0 0 10px 0",color:"#00ff00"},children:["🔍 Planet Debug: ",s.planet_info?.name]}),n.jsxs("div",{style:{marginBottom:"10px"},children:[n.jsx("strong",{children:"Type:"})," ",s.planet_info?.type,n.jsx("br",{}),n.jsx("strong",{children:"Base Color:"})," ",s.planet_info?.base_color,n.jsx("br",{}),n.jsx("strong",{children:"Radius:"})," ",s.planet_info?.radius]}),s.surface_elements?.type==="oceanic"&&n.jsxs("div",{style:{marginBottom:"10px",borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[n.jsx("strong",{children:"🌊 Oceanic Data:"}),n.jsx("br",{}),n.jsxs("span",{style:{color:y.oceanicData?.baseColorIsBlue?"#00ff00":"#ff0000"},children:["Base Color: ",y.oceanicData?.baseColorIsBlue?"✓ Blue":"✗ Not Blue"]}),n.jsx("br",{}),"Green Patches: ",y.oceanicData?.numGreenPatches,n.jsx("br",{}),"Clouds: ",y.oceanicData?.numClouds,n.jsx("br",{}),"Has Depths: ",y.oceanicData?.hasDepths?"Yes":"No",n.jsx("br",{}),y.oceanicData?.issues?.length>0&&n.jsxs("div",{style:{color:"#ffaa00",marginTop:"5px"},children:["⚠️ Issues:",n.jsx("br",{}),y.oceanicData.issues.map((d,i)=>n.jsxs("div",{children:["- ",d]},i))]})]}),n.jsxs("div",{style:{borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[n.jsx("strong",{children:"🎨 Effects Applied:"}),n.jsx("br",{}),_.map((d,i)=>n.jsxs("div",{style:{color:d.includes("PROBLEMA")?"#ff0000":"#00ff00"},children:["- ",d]},i))]}),n.jsx("button",{style:{marginTop:"10px",background:"#00ff00",color:"#000",border:"none",padding:"5px 10px",cursor:"pointer",borderRadius:"3px"},children:"Log to Console"})]}):null};function mt(s){u.useEffect(()=>{if(s&&s.surface_elements?.type==="oceanic"){s.surface_elements.green_patches?.length>0;const c=s.planet_info?.base_color;c!=="#0000FF"&&console.warn("⚠️ Planeta oceánico sin color azul base!",c)}},[s])}const Z=2.5,Ce=()=>{const s=45*Math.PI/180;return Z/(Math.tan(s/2)*.5)},pt=u.forwardRef(({planetName:s,containerClassName:c="",width:p=800,height:_=600,autoRotate:g=!0,enableControls:y=!0,showDebugInfo:b=!1,planetData:R,cosmicOriginTime:w,initialAngleRotation:d,onDataLoaded:i,onEffectsCreated:z,onError:A,planetUrl:q},Ae)=>{const L=u.useRef(null),h=u.useRef(null),F=u.useRef(null),D=u.useRef(null),x=u.useRef(null),U=u.useRef(null),Le=u.useRef(new Ze),ne=u.useRef(null),se=u.useRef(0),k=u.useRef(null),[pe,X]=u.useState(!0),[ge,W]=u.useState(null),[S,he]=u.useState(null),[Fe,ae]=u.useState([]),[J,ie]=u.useState({activeEffects:0,enabledEffects:0,frameRate:0,renderTime:0}),Y=u.useRef([]),oe=u.useRef(0),K=u.useRef(null),j=u.useRef(null),M=u.useRef(null),[ce,_e]=u.useState(!1);u.useImperativeHandle(Ae,()=>({captureScreenshot:()=>{if(!F.current||!h.current||!D.current||ce)return;_e(!0),U.current&&(U.current.enabled=!1);const e=F.current,r=h.current,t=D.current,a=e.domElement.width,l=e.domElement.height,f=3840/a,o=[];r.traverse(P=>{if(P.isPoints&&P.material){const m=P.material;if(m.size!==void 0){o.push({material:m,originalSize:m.size});const v=m.isPulsatingCubeParticle===!0?f*.3:f*1;m.size=m.size*v}if(m.uniforms){const v=m.isPulsatingCubeParticle===!0?f*.3:f*1;m.uniforms.size&&(o.push({material:m,uniform:"size",originalValue:m.uniforms.size.value}),m.uniforms.size.value=m.uniforms.size.value*v),m.uniforms.scale&&(o.push({material:m,uniform:"scale",originalValue:m.uniforms.scale.value}),m.uniforms.scale.value=m.uniforms.scale.value*v)}if(P.geometry&&P.geometry.attributes.size){const E=P.geometry.attributes.size,v=E.array.slice();o.push({geometry:P.geometry,originalSizeArray:v});const H=m.isPulsatingCubeParticle===!0?f*.3:f*1;for(let N=0;N<E.array.length;N++)E.array[N]*=H;E.needsUpdate=!0}}if(P.isSprite&&(o.push({object:P,originalScale:P.scale.clone()}),P.scale.multiplyScalar(f*1)),P.isLine&&P.material){const m=P.material;if(m.linewidth!==void 0){o.push({material:m,originalLinewidth:m.linewidth});const v=m.isLifeFormBeamLine===!0?f*.5:f*1;m.linewidth=m.linewidth*v}}});const I=3840,O=3840;e.setSize(I,O),t.aspect=1,t.updateProjectionMatrix(),e.render(r,t),e.domElement.toBlob(P=>{if(P){const m=document.createElement("canvas"),E=m.getContext("2d");if(m.width=I,m.height=O,E){const v=new Image;v.onload=async()=>{E.drawImage(v,0,0),ut(E,{imageWidth:I,imageHeight:O}),q&&await lt(E,I,O,{type:"planet",stargateUrl:q}),m.toBlob(H=>{if(H){const N=URL.createObjectURL(H),V=document.createElement("a");V.href=N,V.download=`planet_${s}_${Date.now()}.png`,V.click(),URL.revokeObjectURL(N)}},"image/png",1)};const G=URL.createObjectURL(P);v.src=G}}o.forEach(({material:m,object:E,originalSize:v,originalScale:G,originalLinewidth:H,uniform:N,originalValue:V,geometry:Pe,originalSizeArray:me})=>{if(v!==void 0&&(m.size=v),G!==void 0&&E.scale.copy(G),H!==void 0&&(m.linewidth=H),N&&V!==void 0&&(m.uniforms[N].value=V),Pe&&me){const ve=Pe.attributes.size;for(let te=0;te<me.length;te++)ve.array[te]=me[te];ve.needsUpdate=!0}}),e.setSize(a,l),t.aspect=a/l,t.updateProjectionMatrix(),U.current&&(U.current.enabled=!0),_e(!1)},"image/png",1)},isGeneratingImage:ce}));const Me=Math.floor(Date.now()/1e3),[Ie,ht]=u.useState(0),De=w||S?.timing?.cosmic_origin_time||Date.now()/1e3-3600,je=Me-De+Ie;se.current=je;const le=u.useCallback(()=>{if(!L.current||!F.current||!D.current)return;const e=L.current,r=e.clientWidth||400,t=e.clientHeight||400;F.current.setSize(r,t),M.current&&M.current.setSize(r,t),D.current.aspect=r/t,D.current.updateProjectionMatrix()},[]),be=async e=>{if(!(!x.current||!h.current||!j.current)){B.log("Applying modular effects from API data",{planet:e.planet_info.name,type:e.planet_info.type});try{fe();const r=qe(e);j.current.updateBaseColor(r);const t=$.createEffectsFromPythonPlanetData(e,Z,x.current,h.current,j.current),a=e.planet_info?.type||e.surface_elements?.planet_type||e.planet_type;if((a==="toxic"||a==="Toxic")&&h.current&&D.current&&F.current)try{const l=Qe(h.current,D.current,F.current,Z,{planet_type:"toxic",toxic_intensity:.8,atmosphere_thickness:.6},e.seeds?.planet_seed);if(l){M.current=l;const f={id:`effect_toxic_postprocessing_${Date.now()}`,type:"toxic_post_processing",effect:{dispose:()=>l.dispose(),update:o=>l.update(o),updateUniforms:o=>l.update(o),addToScene:()=>{},apply:()=>{}},priority:100,enabled:!0,name:"Toxic Post-Processing (Bloom + Godrays + Chromatic Aberration)"};$.effects.set(f.id,f),t.push(f),B.log("Created toxic post-processing effects")}}catch(l){B.error("Error creating toxic post-processing",l)}else M.current&&(M.current.dispose(),M.current=null);ae(t),Y.current=t,z&&z(t),B.log(`Successfully applied ${t.length} modular effects`),de()}catch{ee()}}},Te=u.useCallback(()=>{if(!L.current)return!1;try{for(;L.current.firstChild;)L.current.removeChild(L.current.firstChild);h.current=null,D.current=null,F.current=null,x.current=null,C.current=null;const e=L.current,r=e.clientWidth||p||400,t=e.clientHeight||_||400,a=new Xe;a.background=new Re(1297),h.current=a;const l=new Je(45,r/t,.1,1e4),f=Ce();l.position.set(0,0,f),l.lookAt(0,0,0),D.current=l;const o=new Ge({antialias:!0,alpha:!0,powerPreference:"high-performance"});return o.setSize(r,t),o.setPixelRatio(Math.min(window.devicePixelRatio,2)),o.shadowMap.enabled=!0,o.shadowMap.type=Ke,o.toneMapping=et,o.toneMappingExposure=1.2,o.outputColorSpace=tt,o.domElement.className="",L.current.appendChild(o.domElement),F.current=o,$e(a,null),Ue(a),y&&Ne(l,o.domElement),!0}catch{return!1}},[S,R,w]),ze=e=>{if(!e)return 0;const r=e.sun_angle||e.lighting?.sun_angle;if(r!==void 0)return r;const t=e.timing?.current_orbital_angle||e.timing?.orbital_angle;return t??0},T=u.useRef(null),ue=u.useRef(null),Q=u.useRef(null),C=u.useRef(null),ke=e=>{e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.camera.left=-10,e.shadow.camera.right=10,e.shadow.camera.top=10,e.shadow.camera.bottom=-10},ye=e=>{if(!T.current||!h.current)return;const r=ze(e),t=10,a=r+Math.PI,l=Math.sin(r)*5,f=t*Math.cos(a),o=l,I=t*Math.sin(a);T.current.position.set(f,o,I),T.current.target.position.set(0,0,0),h.current.children.includes(T.current.target)||h.current.add(T.current.target),ue.current&&ue.current.position.set(-f*.5,0,-I*.5),j.current&&T.current&&j.current.updateFromThreeLight(T.current),T.current&&$.updateLightForAllEffects(T.current)},$e=(e,r)=>{{const t=new Ee(16777215,2);t.position.set(-10,5,10),t.target.position.set(0,0,0),t.castShadow=!0,ke(t),e.add(t),e.add(t.target),T.current=t;const a=new Ee(16777215,.05);a.position.set(8,-3,-5),e.add(a),ue.current=a;const l=new rt(2236996,.1);e.add(l),setTimeout(()=>{j.current&&t&&j.current.updateFromThreeLight(t),t&&$.updateLightForAllEffects(t)},50);return}},Ue=e=>{const r=new nt(Z,128,64),t=new st({color:8421504}),a=new at(r,t);a.castShadow=!0,a.receiveShadow=!0,a.position.set(0,0,0),e.add(a),x.current=a;const l=new Re(8421504);j.current=new Ye(a,l),j.current.addToScene(e)},Ne=(e,r)=>{const t=new He(e,r);t.enableDamping=!0,t.dampingFactor=.05;const a=Ce();t.minDistance=a*.5,t.maxDistance=a*2,t.autoRotate=g,t.autoRotateSpeed=.5,t.enablePan=!0,t.enableZoom=!0,t.target.set(0,0,0),U.current=t},Be=u.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{X(!0),W(null),B.log("Loading planet data from API",{planetName:s});const r=await fetch("/api/planet/rendering-data");if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const t=await r.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const a=t.planet_data,l=t.timing,f=t.rendering_data,o={planet_info:f?.planet_info||{name:a.name,type:a.planet_type,base_color:"#808080",radius:a.diameter/15e3,orbital_radius:a.orbital_radius},surface_elements:f?.surface_elements,atmosphere:f?.atmosphere,rings:f?.rings,effects_3d:f?.effects_3d,shader_uniforms:f?.shader_uniforms,universal_actions:f?.universal_actions,timing:{cosmic_origin_time:l.cosmic_origin_time,current_time_seconds:l.current_time_seconds,elapsed_time:l.elapsed_time,initial_orbital_angle:a.initial_orbital_angle,current_orbital_angle:a.current_orbital_angle,max_orbital_radius:l.max_orbital_radius,system_max_orbital_radius:a.system_max_orbital_radius},original_planet_data:a,seeds:f?.seeds};return he(o),k.current=o,B.log("API data loaded successfully",{planet:o.planet_info.name,type:o.planet_info.type,hasEffects:!!o.surface_elements,fullRenderingData:f}),i&&i(o),o}catch(e){const r=e instanceof Error?e.message:"Unknown error";return W(r),A&&A(r),null}finally{X(!1),window.isLoadingPlanetData=!1}}},[s,i,A]);u.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{X(!0),W(null),B.log("Loading planet data from API",{planetName:s});const r=await fetch("/api/planet/rendering-data");if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const t=await r.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const a=t.planet_data,l=t.timing,f=t.rendering_data,o={planet_info:f?.planet_info||{name:a.name,type:a.planet_type,base_color:"#808080",radius:a.diameter/15e3,orbital_radius:a.orbital_radius},surface_elements:f?.surface_elements,atmosphere:f?.atmosphere,rings:f?.rings,effects_3d:f?.effects_3d,shader_uniforms:f?.shader_uniforms,universal_actions:f?.universal_actions,timing:{cosmic_origin_time:l.cosmic_origin_time,current_time_seconds:l.current_time_seconds,elapsed_time:l.elapsed_time,initial_orbital_angle:a.initial_orbital_angle,current_orbital_angle:a.current_orbital_angle,max_orbital_radius:l.max_orbital_radius,system_max_orbital_radius:a.system_max_orbital_radius},original_planet_data:a,seeds:f?.seeds};he(o),k.current=o,B.log("API data loaded successfully",{planet:o.planet_info.name,type:o.planet_info.type,hasEffects:!!o.surface_elements,fullRenderingData:f}),ye(o),C.current&&h.current&&(h.current.remove(C.current),C.current.geometry.dispose(),C.current.material.dispose(),C.current=null),await be(o),i&&i(o)}catch(e){const r=e instanceof Error?e.message:"Unknown error";W(r),A&&A(r),ee()}finally{X(!1),window.isLoadingPlanetData=!1}}},[s,R,w,d]);const we=u.useCallback(()=>{if(!S||!x.current)return;const e=R?.orbital_period_seconds||365.25*24*3600,r=2*Math.PI/e,t=S.timing?.initial_orbital_angle||0,a=Date.now()/1e3,l=0,f=w||S.timing?.cosmic_origin_time||Date.now()/1e3-3600,o=a-f+l,I=(t+o*r)%(2*Math.PI),O=S.timing?.max_orbital_radius||100,m=20+S.planet_info?.orbital_radius/O*80,E=m,v=m*Math.cos(I),G=E*Math.sin(I);x.current.position.x=v,x.current.position.z=G,x.current.position.y=0},[S,R,w]),Oe=u.useCallback(async e=>{const r=e||S;if(r&&h.current)try{ye(r),C.current&&h.current&&(h.current.remove(C.current),C.current.geometry.dispose(),C.current.material.dispose(),C.current=null),await be(r)}catch{ee()}},[S]),ee=()=>{if(!(!h.current||!x.current)){B.warn("Applying fallback effects for planet type:",R?.planet_type);try{fe(),x.current.material instanceof it&&x.current.material.color.setHex(6710886);try{const e=Ve("generic"),r=$.createEffectsFromList(e,Z,x.current);r.forEach(t=>{t.effect.addToScene&&h.current&&x.current&&t.effect.addToScene(h.current,x.current.position)}),Y.current=r,ae(r)}catch{}de()}catch{}}},fe=()=>{Y.current.forEach(e=>{try{$.removeEffect(e.id),e.effect.dispose&&e.effect.dispose()}catch{}}),M.current&&(M.current.dispose(),M.current=null),Y.current=[],ae([])},xe=u.useCallback(()=>{ne.current=requestAnimationFrame(xe);const e=performance.now(),r=Le.current.getDelta();U.current&&U.current.update();try{$.updateAllEffects(r,x.current?.rotation.y,D.current||void 0)}catch{}if(x.current&&k.current){k.current.planet_info?.name;const l=k.current.original_planet_data,f=l?.orbital_period_seconds||365.25*24*3600,o=k.current.timing?.initial_orbital_angle||0;w||k.current.timing?.cosmic_origin_time||Date.now()/1e3-3600;const I=l?.axial_tilt||0,O=2*Math.PI/f;(o+se.current*O)%(2*Math.PI);const P=k.current.timing?.max_orbital_radius||k.current.timing?.system_max_orbital_radius,m=l?.orbital_radius;if(!P||!m)return;l?.eccentricity_factor,x.current.position.set(0,0,0);const E=l?.rotation_period_seconds||86400,v=2*Math.PI/E;x.current.rotation.y=se.current*v%(2*Math.PI),x.current.rotation.z=I*(Math.PI/180)}Y.current.forEach(l=>{l.effect.updateUniforms&&l.effect.updateUniforms(r)});const a=Array.from($.effects.values()).find(l=>l.type==="toxic_post_processing")?.enabled||!1;if(M.current&&a&&(M.current.update(r),T.current&&M.current.updateLightPosition(T.current.position,D.current)),F.current&&h.current&&D.current){const l=performance.now();M.current&&a?M.current.render():F.current.render(h.current,D.current);const f=performance.now()-l;if(e-oe.current>5e3){const o=1e3/(e-oe.current);de(),ie(I=>({...I,frameRate:Math.round(o),renderTime:Math.round(f*100)/100})),oe.current=e}}},[]),de=u.useCallback(()=>{const e=$.getStats();ie(r=>({...r,activeEffects:e.activeEffects,enabledEffects:e.enabledEffects}))},[]);return u.useEffect(()=>{let e=!0;return window.tonnirLoggedInPlanet=!1,window.orbitChecked=!1,window.debugOrbitRadius=null,window.debugSystemMaxRadius=null,window.planetNameLogged=!1,window.timingDataLogged=!1,window.isLoadingPlanetData=!1,window.orbitalAngleSourceLogged=!1,window.orbitalAngleDebugged=!1,window.positionDebugged=!1,window.animationLoopDebugged=!1,(async()=>{try{if(!e)return;const t=await Be();if(!e)return;if(!Te()){e&&W("Failed to initialize 3D renderer");return}if(!e||(xe(),L.current&&"ResizeObserver"in window&&(K.current=new ResizeObserver(le),K.current.observe(L.current)),window.addEventListener("resize",le),!e))return;t?await Oe(t):ee()}catch(t){e&&W(t instanceof Error?t.message:"Unknown initialization error")}})(),()=>{if(e=!1,k.current=null,ne.current&&cancelAnimationFrame(ne.current),K.current&&K.current.disconnect(),window.removeEventListener("resize",le),fe(),j.current&&(j.current.dispose(),j.current=null),U.current&&U.current.dispose(),Q.current&&h.current&&(h.current.remove(Q.current),Q.current.geometry.dispose(),Q.current.material.dispose(),Q.current=null),C.current&&h.current&&(h.current.remove(C.current),C.current.geometry.dispose(),C.current.material.dispose(),C.current=null),F.current&&L.current)try{L.current.contains(F.current.domElement)&&L.current.removeChild(F.current.domElement),F.current.dispose()}catch{}}},[]),u.useEffect(()=>{const e=setInterval(()=>{const r=$.getStats();ie(t=>({...t,activeEffects:r.activeEffects,enabledEffects:r.enabledEffects}))},1e4);return()=>clearInterval(e)},[]),u.useEffect(()=>{S&&h.current&&x.current&&we()},[S,we]),mt(S),n.jsxs("div",{className:`relative ${c}`,children:[b&&S&&n.jsx(dt,{planetData:S,showInPage:!0,showInConsole:!0}),n.jsx("div",{ref:L,className:"w-full h-full",style:{minHeight:"300px",aspectRatio:"1"}}),n.jsx(ft,{isVisible:ce}),pe&&n.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-50",children:n.jsxs("div",{className:"text-white text-center",children:[n.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"}),n.jsx("div",{children:"Loading planet..."})]})}),ge&&n.jsxs("div",{className:"absolute top-0 left-0 right-0 p-2 bg-red-500 text-white text-sm",children:[n.jsx("strong",{children:"Error:"})," ",ge]}),S&&!pe&&n.jsx("div",{className:"absolute bottom-0 left-0 p-2 text-white bg-black bg-opacity-50 max-w-xs rounded-tr-lg",children:n.jsx("h3",{className:"text-xs font-bold",children:S.planet_info.name})}),b&&n.jsxs("div",{className:"absolute top-0 right-0 p-4 text-white bg-black bg-opacity-70 text-xs font-mono",children:[n.jsx("h4",{className:"font-bold mb-2",children:"Debug Info"}),n.jsxs("div",{children:["Frame Rate: ",J.frameRate," FPS"]}),n.jsxs("div",{children:["Render Time: ",J.renderTime,"ms"]}),n.jsxs("div",{children:["Active Effects: ",J.activeEffects]}),n.jsxs("div",{children:["Enabled Effects: ",J.enabledEffects]}),n.jsxs("div",{className:"mt-2",children:[n.jsx("div",{className:"font-semibold",children:"Effects:"}),Fe.map(e=>n.jsxs("div",{className:"ml-2",children:[e.type," (",e.enabled?"ON":"OFF",")"]},e.id))]})]})]})});class gt extends u.Component{constructor(c){super(c),this.state={hasError:!1,error:null}}static getDerivedStateFromError(c){return{hasError:!0,error:c.message}}componentDidCatch(c,p){}render(){return this.state.hasError?n.jsx("div",{className:"flex items-center justify-center w-full h-full bg-gray-900/50 rounded",children:n.jsxs("div",{className:"text-center p-4",children:[n.jsx("div",{className:"text-red-400 text-sm mb-2",children:"3D Renderer Error"}),n.jsx("div",{className:"text-xs text-gray-400",children:this.state.error})]})}):this.props.children}}const Ct=u.forwardRef((s,c)=>n.jsx(gt,{children:n.jsx(pt,{ref:c,...s})}));export{ft as E,Ct as M,re as S,ut as a,lt as b};
