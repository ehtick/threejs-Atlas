import{j as n,r as u}from"./atlas_DztNjO7RDBVhWZ-y1bcy1.js";import{W as Ge}from"./atlas_oohEvMdySAEvykvrmEZWK.js";import{O as We}from"./atlas_ujwtN6M9bdCDvth7wAGyD.js";import{Q as He}from"./atlas_NcbMusH95geV1bEYmniMW.js";import{e as $}from"./atlas_CKgoXdq-KyExGQBSbNLMh.js";import{E as O,c as Ve}from"./atlas_RvtgSuNkg9MFF7eIotjGD.js";import{g as qe}from"./atlas_Dohzt8kNSWBW4t2pSLrOG.js";import{P as Ye}from"./atlas_BZAQSikhKZZ5xAz2fSejO.js";import{c as Qe}from"./atlas_B0DOS25QVmvMiQ0kDrzPR.js";import{a3 as Ze,a4 as Xe,C as Re,a5 as Je,a6 as Ke,a7 as et,a8 as tt,a9 as Se,aa as rt,b as nt,z as st,M as at,m as it}from"./atlas_Dr7FhitegIaVfnn-NnCom.js";class ne{static encodeUrl(o){return btoa(o).replace(/\+/g,"-").replace(/\//g,"_")}static generateGalaxyUrl(o,m=1){const g=`coordinates=${o[0]},${o[1]},${o[2]}&page=${m}`;return`/stargate/${this.encodeUrl(g)}`}static generateSystemUrl(o,m,g=1){const h=`coordinates=${o[0]},${o[1]},${o[2]}&system=${m}&page=${g}`;return`/stargate/${this.encodeUrl(h)}`}static generatePlanetUrl(o,m,g,h=1){const w=`coordinates=${o[0]},${o[1]},${o[2]}&system=${m}&planet=${g.toLowerCase()}&page=${h}`;return`/stargate/${this.encodeUrl(w)}`}static getCurrentPage(){try{const m=new URLSearchParams(window.location.search).get("page");if(m)return parseInt(m,10);const g=window.location.pathname.match(/\/galaxy\/(\d+)/);return g?parseInt(g[1],10):1}catch{return 1}}}const ot=(a,o)=>{try{const m=a.split("/stargate/")[1];if(!m)return null;const g=atob(m.replace(/-/g,"+").replace(/_/g,"/")),h=new URLSearchParams(g),w=h.get("coordinates"),y=h.get("system"),E=h.get("planet");if(!w)return null;const x={type:o,coordinates:w};return y&&(x.systemIndex=parseInt(y)),E&&(x.planetName=E),x}catch{return null}},Ce=a=>{try{const o=a.coordinates.split(",").map(Number),m=ne.getCurrentPage();let g;switch(a.type){case"galaxy":g=ne.generateGalaxyUrl(o,m);break;case"system":if(a.systemIndex!==void 0)g=ne.generateSystemUrl(o,a.systemIndex,m);else return window.location.href;break;case"planet":if(a.systemIndex!==void 0&&a.planetName)g=ne.generatePlanetUrl(o,a.systemIndex,a.planetName,m);else return window.location.href;break;default:return window.location.href}return`${window.location.origin}${g}`}catch{return window.location.href}},ct=async a=>{const{url:o,size:m}=a;return new Promise((g,h)=>{const w=document.createElement("canvas"),y=m,E=Math.floor(m*.8);He.toCanvas(w,o,{width:E,margin:0,color:{dark:"#000000",light:"#FFFFFF"},errorCorrectionLevel:"H"},x=>{if(x){h(x);return}const f=document.createElement("canvas"),i=f.getContext("2d"),F=Math.floor(y*.17);if(f.width=y,f.height=y+F,i){const R=Math.floor(y*.1);i.fillStyle="#FFFFFF",i.beginPath(),i.roundRect(0,0,f.width,f.height,R),i.fill();const G=(y-E)/2;i.drawImage(w,G,G),i.fillStyle="#000000",i.font=`bold ${Math.floor(y*.13)}px Arial`,i.textAlign="center",i.textBaseline="middle",i.fillText("VIEW IT LIVE",y/2,y+F*.2),g(f)}})})},lt=async(a,o,m,g)=>{try{let h;if("coordinates"in g)h=Ce(g);else{const i=ot(g.stargateUrl,g.type);i?h=Ce(i):h=g.stargateUrl}if(h.startsWith("http://localhost/"))try{const F=await(await fetch("/api/universe/config")).json(),R=45156749731585371360938718175484539659389209313560548011495000289036640085049n,G=4515674973158537e61,Y=F.config_seed;(Y===G||Y===R||BigInt(Y)===R)&&(h=h.replace("http://localhost/","https://the-atlas.koyeb.app/"))}catch(i){console.warn("Failed to check config seed:",i)}const w=Math.floor(o/8),y=await ct({url:h,size:w}),E=Math.floor(o/100),x=o-y.width-E,f=m-y.height-E;a.drawImage(y,x,f)}catch(h){console.warn("Failed to generate QR code:",h)}},ut=(a,o)=>{const{imageWidth:m,imageHeight:g,startYear:h=2023,companyName:w="Banshee",opacity:y=.5,fontSize:E}=o,x=new Date().getFullYear(),f=x===h?`${h}`:`${h}-${x}`,i=`The Atlas © Copyright ${w} • ${f}`;a.fillStyle=`rgba(255, 255, 255, ${y})`;const F=E||Math.floor(m/80);a.font=`${F}px Arial`,a.textAlign="left",a.textBaseline="bottom";const R=Math.floor(m/100);a.fillText(i,R,g-R)},ft=({isVisible:a,message:o="Exporting view, please wait..."})=>n.jsxs("div",{className:`absolute inset-0 bg-black flex flex-col items-center justify-center z-10 transition-all duration-300 ${a?"opacity-100 visible":"opacity-0 invisible"}`,children:[n.jsx("div",{className:"w-16 h-16 border-4 border-white/20 border-t-white rounded-full animate-spin mb-6"}),n.jsx("p",{className:"text-white text-xl font-medium text-center px-4",children:o})]}),dt=({planetData:a,showInConsole:o=!0,showInPage:m=!1})=>{const[g,h]=u.useState([]),[w,y]=u.useState({});u.useEffect(()=>{if(!a)return;const f=E(a);y(f),h(x(a)),typeof window<"u"&&(window.__DEBUG_PLANET_DATA=a,window.__DEBUG_PLANET_ANALYSIS=f)},[a,o]);function E(f){const i={hasValidStructure:!1,missingFields:[],dataIntegrity:"unknown",renderingIssues:[],colorConsistency:"unknown"};if(f.planet_info&&f.surface_elements?i.hasValidStructure=!0:(f.planet_info||i.missingFields.push("planet_info"),f.surface_elements||i.missingFields.push("surface_elements")),f.surface_elements?.type==="oceanic"&&(i.oceanicData={hasAbstractLands:!!f.surface_elements.abstract_lands?.length,numGreenPatches:f.surface_elements.green_patches?.length||0,numClouds:f.surface_elements.clouds?.length||0,hasDepths:f.surface_elements.depths?.enabled||!1,baseColorIsBlue:f.planet_info?.base_color==="#0000FF",greenPatchColor:f.surface_elements.green_patches?.[0]?.color,issues:[]},i.oceanicData.numGreenPatches>15&&i.oceanicData.issues.push("Muchos parches verdes pueden ocultar el océano azul"),i.oceanicData.baseColorIsBlue||i.oceanicData.issues.push(`Color base no es azul puro: ${f.planet_info?.base_color}`),i.renderingIssues=i.oceanicData.issues),f.planet_info?.base_color&&f.planet_info?.type){const R={Oceanic:"#0000FF",Rocky:"#808080",Icy:"#ADD8E6",Desert:"#FFD700",Lava:"#FF0000"}[f.planet_info.type];R&&f.planet_info.base_color!==R?i.colorConsistency=`Inconsistente: esperado ${R}, recibido ${f.planet_info.base_color}`:i.colorConsistency="Correcto"}return i}function x(f){const i=[];if(!f.surface_elements?.type)return["No surface type defined"];const F=f.surface_elements.type.toLowerCase();switch(F){case"oceanic":i.push("OceanWavesEffect (PROBLEMA: ignora green_patches de Python)");break;case"rocky":i.push("RockyTerrainEffect");break;case"icy":i.push("IcyTerrainEffect");break;case"gas giant":i.push("GasGiantBandsEffect");break;default:i.push(`Generic effect for type: ${F}`)}return f.atmosphere?.density>0&&i.push("AtmosphericEffect"),f.rings&&i.push("RingSystemEffect"),i}return m?n.jsxs("div",{style:{position:"fixed",top:10,right:10,background:"rgba(0, 0, 0, 0.9)",color:"#00ff00",padding:"10px",borderRadius:"5px",fontFamily:"monospace",fontSize:"12px",maxWidth:"400px",maxHeight:"600px",overflow:"auto",zIndex:1e4,border:"1px solid #00ff00"},children:[n.jsxs("h3",{style:{margin:"0 0 10px 0",color:"#00ff00"},children:["🔍 Planet Debug: ",a.planet_info?.name]}),n.jsxs("div",{style:{marginBottom:"10px"},children:[n.jsx("strong",{children:"Type:"})," ",a.planet_info?.type,n.jsx("br",{}),n.jsx("strong",{children:"Base Color:"})," ",a.planet_info?.base_color,n.jsx("br",{}),n.jsx("strong",{children:"Radius:"})," ",a.planet_info?.radius]}),a.surface_elements?.type==="oceanic"&&n.jsxs("div",{style:{marginBottom:"10px",borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[n.jsx("strong",{children:"🌊 Oceanic Data:"}),n.jsx("br",{}),n.jsxs("span",{style:{color:w.oceanicData?.baseColorIsBlue?"#00ff00":"#ff0000"},children:["Base Color: ",w.oceanicData?.baseColorIsBlue?"✓ Blue":"✗ Not Blue"]}),n.jsx("br",{}),"Green Patches: ",w.oceanicData?.numGreenPatches,n.jsx("br",{}),"Clouds: ",w.oceanicData?.numClouds,n.jsx("br",{}),"Has Depths: ",w.oceanicData?.hasDepths?"Yes":"No",n.jsx("br",{}),w.oceanicData?.issues?.length>0&&n.jsxs("div",{style:{color:"#ffaa00",marginTop:"5px"},children:["⚠️ Issues:",n.jsx("br",{}),w.oceanicData.issues.map((f,i)=>n.jsxs("div",{children:["- ",f]},i))]})]}),n.jsxs("div",{style:{borderTop:"1px solid #00ff00",paddingTop:"10px"},children:[n.jsx("strong",{children:"🎨 Effects Applied:"}),n.jsx("br",{}),g.map((f,i)=>n.jsxs("div",{style:{color:f.includes("PROBLEMA")?"#ff0000":"#00ff00"},children:["- ",f]},i))]}),n.jsx("button",{style:{marginTop:"10px",background:"#00ff00",color:"#000",border:"none",padding:"5px 10px",cursor:"pointer",borderRadius:"3px"},children:"Log to Console"})]}):null};function pt(a){u.useEffect(()=>{if(a&&a.surface_elements?.type==="oceanic"){a.surface_elements.green_patches?.length>0;const o=a.planet_info?.base_color;o!=="#0000FF"&&console.warn("⚠️ Planeta oceánico sin color azul base!",o)}},[a])}const X=2.5,Me=()=>{const a=45*Math.PI/180;return X/(Math.tan(a/2)*.5)},mt=u.forwardRef(({planetName:a,containerClassName:o="",width:m=800,height:g=600,autoRotate:h=!0,enableControls:w=!0,showDebugInfo:y=!1,planetData:E,cosmicOriginTime:x,initialAngleRotation:f,onDataLoaded:i,onEffectsCreated:F,onError:R,planetUrl:G},Y)=>{const A=u.useRef(null),_=u.useRef(null),D=u.useRef(null),L=u.useRef(null),P=u.useRef(null),U=u.useRef(null),Ie=u.useRef(new Ze),se=u.useRef(null),ae=u.useRef(0),k=u.useRef(null),[ge,J]=u.useState(!0),[he,V]=u.useState(null),[S,_e]=u.useState(null),[Ae,ie]=u.useState([]),[K,oe]=u.useState({activeEffects:0,enabledEffects:0,frameRate:0,renderTime:0}),Q=u.useRef([]),ce=u.useRef(0),ee=u.useRef(null),T=u.useRef(null),j=u.useRef(null),[le,be]=u.useState(!1);u.useImperativeHandle(Y,()=>({captureScreenshot:()=>{if(!D.current||!_.current||!L.current||le)return;be(!0),U.current&&(U.current.enabled=!1);const e=D.current,r=_.current,t=L.current,s=e.domElement.width,c=e.domElement.height,l=3840/s,p=[];r.traverse(v=>{if(v.isPoints&&v.material){const d=v.material;if(d.size!==void 0){p.push({material:d,originalSize:d.size});const M=d.isPulsatingCubeParticle===!0?l*.3:l*1;d.size=d.size*M}if(d.uniforms){const M=d.isPulsatingCubeParticle===!0?l*.3:l*1;d.uniforms.size&&(p.push({material:d,uniform:"size",originalValue:d.uniforms.size.value}),d.uniforms.size.value=d.uniforms.size.value*M),d.uniforms.scale&&(p.push({material:d,uniform:"scale",originalValue:d.uniforms.scale.value}),d.uniforms.scale.value=d.uniforms.scale.value*M)}if(v.geometry&&v.geometry.attributes.size){const C=v.geometry.attributes.size,M=C.array.slice();p.push({geometry:v.geometry,originalSizeArray:M});const H=d.isPulsatingCubeParticle===!0?l*.3:l*1;for(let N=0;N<C.array.length;N++)C.array[N]*=H;C.needsUpdate=!0}}if(v.isSprite&&(p.push({object:v,originalScale:v.scale.clone()}),v.scale.multiplyScalar(l*1)),v.isLine&&v.material){const d=v.material;d.linewidth!==void 0&&(p.push({material:d,originalLinewidth:d.linewidth}),d.linewidth=d.linewidth*l*1)}});const b=3840,B=3840;e.setSize(b,B),t.aspect=1,t.updateProjectionMatrix(),e.render(r,t),e.domElement.toBlob(v=>{if(v){const d=document.createElement("canvas"),C=d.getContext("2d");if(d.width=b,d.height=B,C){const M=new Image;M.onload=async()=>{C.drawImage(M,0,0),ut(C,{imageWidth:b,imageHeight:B}),G&&await lt(C,b,B,{type:"planet",stargateUrl:G}),d.toBlob(H=>{if(H){const N=URL.createObjectURL(H),q=document.createElement("a");q.href=N,q.download=`planet_${a}_${Date.now()}.jpg`,q.click(),URL.revokeObjectURL(N)}},"image/jpeg",1)};const W=URL.createObjectURL(v);M.src=W}}p.forEach(({material:d,object:C,originalSize:M,originalScale:W,originalLinewidth:H,uniform:N,originalValue:q,geometry:ve,originalSizeArray:me})=>{if(M!==void 0&&(d.size=M),W!==void 0&&C.scale.copy(W),H!==void 0&&(d.linewidth=H),N&&q!==void 0&&(d.uniforms[N].value=q),ve&&me){const Ee=ve.attributes.size;for(let re=0;re<me.length;re++)Ee.array[re]=me[re];Ee.needsUpdate=!0}}),e.setSize(s,c),t.aspect=1,t.updateProjectionMatrix(),U.current&&(U.current.enabled=!0),be(!1)},"image/jpeg",1)},isGeneratingImage:le}));const De=Math.floor(Date.now()/1e3),[je,ht]=u.useState(0),Fe=x||S?.timing?.cosmic_origin_time||Date.now()/1e3-3600,Le=De-Fe+je;ae.current=Le;const ue=u.useCallback(()=>{if(!A.current||!D.current||!L.current)return;const e=A.current,r=e.clientWidth||400,t=e.clientHeight||400,s=Math.min(r,t);D.current.setSize(s,s),j.current&&j.current.setSize(s,s),L.current.aspect=1,L.current.updateProjectionMatrix()},[]),ye=async e=>{if(!(!P.current||!_.current||!T.current)){O.log("Applying modular effects from API data",{planet:e.planet_info.name,type:e.planet_info.type});try{de();const r=qe(e);T.current.updateBaseColor(r);const t=$.createEffectsFromPythonPlanetData(e,X,P.current,_.current,T.current),s=e.planet_info?.type||e.surface_elements?.planet_type||e.planet_type;if((s==="toxic"||s==="Toxic")&&_.current&&L.current&&D.current)try{const c=Qe(_.current,L.current,D.current,X,{planet_type:"toxic",toxic_intensity:.8,atmosphere_thickness:.6},e.seeds?.planet_seed);if(c){j.current=c;const l={id:`effect_toxic_postprocessing_${Date.now()}`,type:"toxic_post_processing",effect:{dispose:()=>c.dispose(),update:p=>c.update(p),updateUniforms:p=>c.update(p),addToScene:()=>{},apply:()=>{}},priority:100,enabled:!0,name:"Toxic Post-Processing (Bloom + Godrays + Chromatic Aberration)"};$.effects.set(l.id,l),t.push(l),O.log("Created toxic post-processing effects")}}catch(c){O.error("Error creating toxic post-processing",c)}else j.current&&(j.current.dispose(),j.current=null);ie(t),Q.current=t,F&&F(t),O.log(`Successfully applied ${t.length} modular effects`),pe()}catch{te()}}},Te=u.useCallback(()=>{if(!A.current)return!1;try{for(;A.current.firstChild;)A.current.removeChild(A.current.firstChild);_.current=null,L.current=null,D.current=null,P.current=null,I.current=null;const e=A.current,r=e.clientWidth||m||400,t=e.clientHeight||g||400,s=Math.min(r,t),c=new Xe;c.background=new Re(1297),_.current=c;const l=new Je(45,1,.1,1e4),p=Me();l.position.set(0,0,p),l.lookAt(0,0,0),L.current=l;const b=new Ge({antialias:!0,alpha:!0,powerPreference:"high-performance"});return b.setSize(s,s),b.setPixelRatio(Math.min(window.devicePixelRatio,2)),b.shadowMap.enabled=!0,b.shadowMap.type=Ke,b.toneMapping=et,b.toneMappingExposure=1.2,b.outputColorSpace=tt,b.domElement.className="",A.current.appendChild(b.domElement),D.current=b,$e(c,null),Ue(c),w&&Ne(l,b.domElement),!0}catch{return!1}},[S,E,x]),ze=e=>{if(!e)return 0;const r=e.sun_angle||e.lighting?.sun_angle;if(r!==void 0)return r;const t=e.timing?.current_orbital_angle||e.timing?.orbital_angle;return t??0},z=u.useRef(null),fe=u.useRef(null),Z=u.useRef(null),I=u.useRef(null),ke=e=>{e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=50,e.shadow.camera.left=-10,e.shadow.camera.right=10,e.shadow.camera.top=10,e.shadow.camera.bottom=-10},we=e=>{if(!z.current||!_.current)return;const r=ze(e),t=10,s=r+Math.PI,c=Math.sin(r)*5,l=t*Math.cos(s),p=c,b=t*Math.sin(s);z.current.position.set(l,p,b),z.current.target.position.set(0,0,0),_.current.children.includes(z.current.target)||_.current.add(z.current.target),fe.current&&fe.current.position.set(-l*.5,0,-b*.5),T.current&&z.current&&T.current.updateFromThreeLight(z.current),z.current&&$.updateLightForAllEffects(z.current)},$e=(e,r)=>{{const t=new Se(16777215,2);t.position.set(-10,5,10),t.target.position.set(0,0,0),t.castShadow=!0,ke(t),e.add(t),e.add(t.target),z.current=t;const s=new Se(16777215,.05);s.position.set(8,-3,-5),e.add(s),fe.current=s;const c=new rt(2236996,.1);e.add(c),setTimeout(()=>{T.current&&t&&T.current.updateFromThreeLight(t),t&&$.updateLightForAllEffects(t)},50);return}},Ue=e=>{const r=new nt(X,128,64),t=new st({color:8421504}),s=new at(r,t);s.castShadow=!0,s.receiveShadow=!0,s.position.set(0,0,0),e.add(s),P.current=s;const c=new Re(8421504);T.current=new Ye(s,c),T.current.addToScene(e)},Ne=(e,r)=>{const t=new We(e,r);t.enableDamping=!0,t.dampingFactor=.05;const s=Me();t.minDistance=s*.5,t.maxDistance=s*2,t.autoRotate=h,t.autoRotateSpeed=.5,t.enablePan=!0,t.enableZoom=!0,t.target.set(0,0,0),U.current=t},Oe=u.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{J(!0),V(null),O.log("Loading planet data from API",{planetName:a});const r=await fetch("/api/planet/rendering-data");if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const t=await r.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const s=t.planet_data,c=t.timing,l=t.rendering_data,p={planet_info:l?.planet_info||{name:s.name,type:s.planet_type,base_color:"#808080",radius:s.diameter/15e3,orbital_radius:s.orbital_radius},surface_elements:l?.surface_elements,atmosphere:l?.atmosphere,rings:l?.rings,effects_3d:l?.effects_3d,shader_uniforms:l?.shader_uniforms,universal_actions:l?.universal_actions,timing:{cosmic_origin_time:c.cosmic_origin_time,current_time_seconds:c.current_time_seconds,elapsed_time:c.elapsed_time,initial_orbital_angle:s.initial_orbital_angle,current_orbital_angle:s.current_orbital_angle,max_orbital_radius:c.max_orbital_radius,system_max_orbital_radius:s.system_max_orbital_radius},original_planet_data:s,seeds:l?.seeds};return _e(p),k.current=p,O.log("API data loaded successfully",{planet:p.planet_info.name,type:p.planet_info.type,hasEffects:!!p.surface_elements,fullRenderingData:l}),i&&i(p),p}catch(e){const r=e instanceof Error?e.message:"Unknown error";return V(r),R&&R(r),null}finally{J(!1),window.isLoadingPlanetData=!1}}},[a,i,R]);u.useCallback(async()=>{if(!window.isLoadingPlanetData){window.isLoadingPlanetData=!0;try{J(!0),V(null),O.log("Loading planet data from API",{planetName:a});const r=await fetch("/api/planet/rendering-data");if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const t=await r.json();if(!t.success)throw new Error(t.error||"Failed to fetch planet data");const s=t.planet_data,c=t.timing,l=t.rendering_data,p={planet_info:l?.planet_info||{name:s.name,type:s.planet_type,base_color:"#808080",radius:s.diameter/15e3,orbital_radius:s.orbital_radius},surface_elements:l?.surface_elements,atmosphere:l?.atmosphere,rings:l?.rings,effects_3d:l?.effects_3d,shader_uniforms:l?.shader_uniforms,universal_actions:l?.universal_actions,timing:{cosmic_origin_time:c.cosmic_origin_time,current_time_seconds:c.current_time_seconds,elapsed_time:c.elapsed_time,initial_orbital_angle:s.initial_orbital_angle,current_orbital_angle:s.current_orbital_angle,max_orbital_radius:c.max_orbital_radius,system_max_orbital_radius:s.system_max_orbital_radius},original_planet_data:s,seeds:l?.seeds};_e(p),k.current=p,O.log("API data loaded successfully",{planet:p.planet_info.name,type:p.planet_info.type,hasEffects:!!p.surface_elements,fullRenderingData:l}),we(p),I.current&&_.current&&(_.current.remove(I.current),I.current.geometry.dispose(),I.current.material.dispose(),I.current=null),await ye(p),i&&i(p)}catch(e){const r=e instanceof Error?e.message:"Unknown error";V(r),R&&R(r),te()}finally{J(!1),window.isLoadingPlanetData=!1}}},[a,E,x,f]);const xe=u.useCallback(()=>{if(!S||!P.current)return;const e=E?.orbital_period_seconds||365.25*24*3600,r=2*Math.PI/e,t=S.timing?.initial_orbital_angle||0,s=Date.now()/1e3,c=0,l=x||S.timing?.cosmic_origin_time||Date.now()/1e3-3600,p=s-l+c,b=(t+p*r)%(2*Math.PI),B=S.timing?.max_orbital_radius||100,d=20+S.planet_info?.orbital_radius/B*80,C=d,M=d*Math.cos(b),W=C*Math.sin(b);P.current.position.x=M,P.current.position.z=W,P.current.position.y=0},[S,E,x]),Be=u.useCallback(async e=>{const r=e||S;if(r&&_.current)try{we(r),I.current&&_.current&&(_.current.remove(I.current),I.current.geometry.dispose(),I.current.material.dispose(),I.current=null),await ye(r)}catch{te()}},[S]),te=()=>{if(!(!_.current||!P.current)){O.warn("Applying fallback effects for planet type:",E?.planet_type);try{de(),P.current.material instanceof it&&P.current.material.color.setHex(6710886);try{const e=Ve("generic"),r=$.createEffectsFromList(e,X,P.current);r.forEach(t=>{t.effect.addToScene&&_.current&&P.current&&t.effect.addToScene(_.current,P.current.position)}),Q.current=r,ie(r)}catch{}pe()}catch{}}},de=()=>{Q.current.forEach(e=>{try{$.removeEffect(e.id),e.effect.dispose&&e.effect.dispose()}catch{}}),j.current&&(j.current.dispose(),j.current=null),Q.current=[],ie([])},Pe=u.useCallback(()=>{se.current=requestAnimationFrame(Pe);const e=performance.now(),r=Ie.current.getDelta();U.current&&U.current.update();try{$.updateAllEffects(r,P.current?.rotation.y,L.current||void 0)}catch{}if(P.current&&k.current){k.current.planet_info?.name;const c=k.current.original_planet_data,l=c?.orbital_period_seconds||365.25*24*3600,p=k.current.timing?.initial_orbital_angle||0;x||k.current.timing?.cosmic_origin_time||Date.now()/1e3-3600;const b=c?.axial_tilt||0,B=2*Math.PI/l;(p+ae.current*B)%(2*Math.PI);const v=k.current.timing?.max_orbital_radius||k.current.timing?.system_max_orbital_radius,d=c?.orbital_radius;if(!v||!d)return;c?.eccentricity_factor,P.current.position.set(0,0,0);const C=c?.rotation_period_seconds||86400,M=2*Math.PI/C;P.current.rotation.y=ae.current*M%(2*Math.PI),P.current.rotation.z=b*(Math.PI/180)}Q.current.forEach(c=>{c.effect.updateUniforms&&c.effect.updateUniforms(r)});const s=Array.from($.effects.values()).find(c=>c.type==="toxic_post_processing")?.enabled||!1;if(j.current&&s&&(j.current.update(r),z.current&&j.current.updateLightPosition(z.current.position,L.current)),D.current&&_.current&&L.current){const c=performance.now();j.current&&s?j.current.render():D.current.render(_.current,L.current);const l=performance.now()-c;if(e-ce.current>5e3){const p=1e3/(e-ce.current);pe(),oe(b=>({...b,frameRate:Math.round(p),renderTime:Math.round(l*100)/100})),ce.current=e}}},[]),pe=u.useCallback(()=>{const e=$.getStats();oe(r=>({...r,activeEffects:e.activeEffects,enabledEffects:e.enabledEffects}))},[]);return u.useEffect(()=>{let e=!0;return window.tonnirLoggedInPlanet=!1,window.orbitChecked=!1,window.debugOrbitRadius=null,window.debugSystemMaxRadius=null,window.planetNameLogged=!1,window.timingDataLogged=!1,window.isLoadingPlanetData=!1,window.orbitalAngleSourceLogged=!1,window.orbitalAngleDebugged=!1,window.positionDebugged=!1,window.animationLoopDebugged=!1,(async()=>{try{if(!e)return;const t=await Oe();if(!e)return;if(!Te()){e&&V("Failed to initialize 3D renderer");return}if(!e||(Pe(),A.current&&"ResizeObserver"in window&&(ee.current=new ResizeObserver(ue),ee.current.observe(A.current)),window.addEventListener("resize",ue),!e))return;t?await Be(t):te()}catch(t){e&&V(t instanceof Error?t.message:"Unknown initialization error")}})(),()=>{if(e=!1,k.current=null,se.current&&cancelAnimationFrame(se.current),ee.current&&ee.current.disconnect(),window.removeEventListener("resize",ue),de(),T.current&&(T.current.dispose(),T.current=null),U.current&&U.current.dispose(),Z.current&&_.current&&(_.current.remove(Z.current),Z.current.geometry.dispose(),Z.current.material.dispose(),Z.current=null),I.current&&_.current&&(_.current.remove(I.current),I.current.geometry.dispose(),I.current.material.dispose(),I.current=null),D.current&&A.current)try{A.current.contains(D.current.domElement)&&A.current.removeChild(D.current.domElement),D.current.dispose()}catch{}}},[]),u.useEffect(()=>{const e=setInterval(()=>{const r=$.getStats();oe(t=>({...t,activeEffects:r.activeEffects,enabledEffects:r.enabledEffects}))},1e4);return()=>clearInterval(e)},[]),u.useEffect(()=>{S&&_.current&&P.current&&xe()},[S,xe]),pt(S),n.jsxs("div",{className:`relative ${o}`,children:[y&&S&&n.jsx(dt,{planetData:S,showInPage:!0,showInConsole:!0}),n.jsx("div",{ref:A,className:"w-full h-full",style:{minHeight:"300px",aspectRatio:"1"}}),n.jsx(ft,{isVisible:le}),ge&&n.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-50",children:n.jsxs("div",{className:"text-white text-center",children:[n.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"}),n.jsx("div",{children:"Loading planet..."})]})}),he&&n.jsxs("div",{className:"absolute top-0 left-0 right-0 p-2 bg-red-500 text-white text-sm",children:[n.jsx("strong",{children:"Error:"})," ",he]}),S&&!ge&&n.jsx("div",{className:"absolute bottom-0 left-0 p-2 text-white bg-black bg-opacity-50 max-w-xs rounded-tr-lg",children:n.jsx("h3",{className:"text-xs font-bold",children:S.planet_info.name})}),y&&n.jsxs("div",{className:"absolute top-0 right-0 p-4 text-white bg-black bg-opacity-70 text-xs font-mono",children:[n.jsx("h4",{className:"font-bold mb-2",children:"Debug Info"}),n.jsxs("div",{children:["Frame Rate: ",K.frameRate," FPS"]}),n.jsxs("div",{children:["Render Time: ",K.renderTime,"ms"]}),n.jsxs("div",{children:["Active Effects: ",K.activeEffects]}),n.jsxs("div",{children:["Enabled Effects: ",K.enabledEffects]}),n.jsxs("div",{className:"mt-2",children:[n.jsx("div",{className:"font-semibold",children:"Effects:"}),Ae.map(e=>n.jsxs("div",{className:"ml-2",children:[e.type," (",e.enabled?"ON":"OFF",")"]},e.id))]})]})]})});class gt extends u.Component{constructor(o){super(o),this.state={hasError:!1,error:null}}static getDerivedStateFromError(o){return{hasError:!0,error:o.message}}componentDidCatch(o,m){}render(){return this.state.hasError?n.jsx("div",{className:"flex items-center justify-center w-full h-full bg-gray-900/50 rounded",children:n.jsxs("div",{className:"text-center p-4",children:[n.jsx("div",{className:"text-red-400 text-sm mb-2",children:"3D Renderer Error"}),n.jsx("div",{className:"text-xs text-gray-400",children:this.state.error})]})}):this.props.children}}const Ct=u.forwardRef((a,o)=>n.jsx(gt,{children:n.jsx(mt,{ref:o,...a})}));export{ft as E,Ct as M,ne as S,ut as a,lt as b};
